<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì„ ìˆ˜ ê¸°ë¡ ì¡°íšŒ ë° ë¶„ì•¼ë³„ ìˆœìœ„</title>
  <style>
/* =======================
   í…Œë§ˆ ë³€ìˆ˜ (ë¼ì´íŠ¸/ë‹¤í¬)
   ======================= */
:root{
  --bg:#f9faff; --text:#333; --card:#ffffff; --border:#dddddd; --brand:#1a73e8;
  --thead:#e8f0fe; --theadText:#1a73e8; --link:#1a73e8;

  /* MVP */
  --mvp-bg:#1b3764; --mvp-star:#17438a; --mvp-shadow:#0f2a55;
  --mvp-text:#8a160e; --mvp-glow1:#d64a4a; --mvp-glow2:#bf1e1e;
  --mvp-badge:#8a160e; --mvp-badge-glow:#d64a4a; --mvp-name:#8a160e;
  --mvp-name-glow:#bf1e1e; --mvp-info:#eeeeee;

  /* SCOREBOARD */
  --sb-bg1:#0b1220; --sb-bg2:#101a30; --sb-line:rgba(255,255,255,.06);
  --sb-gold:#f7d36a; --sb-gold2:#d4af37; --sb-blue:#5aa0ff; --sb-red:#ff6b6b;
}
[data-theme="dark"]{
  --bg:#0f172a; --text:#e5e7eb; --card:#0b1220; --border:#22314d; --brand:#86b7ff;
  --thead:#13213a; --theadText:#cfe2ff; --link:#9ec5fe;
  --mvp-bg:#0c1a33; --mvp-star:#0f285e; --mvp-shadow:#05152e;
  --mvp-text:#ffb4a2; --mvp-glow1:#ff7070; --mvp-glow2:#ff4d4d;
  --mvp-badge:#b23a3a; --mvp-badge-glow:#ff7070; --mvp-name:#ffd1c7;
  --mvp-name-glow:#ff8e7a; --mvp-info:#e5e7eb;
}

/* ============ ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ============ */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  max-width: 1100px; margin: 40px auto; padding: 20px 30px;
  background-color: var(--bg); color: var(--text); overflow-x: auto;
}
h1 { font-weight: 700; font-size: 2rem; margin-bottom: 10px; color: var(--brand); text-align: center; }

/* ë‹¤í¬ ëª¨ë“œ í† ê¸€ ë²„íŠ¼ */
#themeToggle{
  float:right; margin-top:-4px; margin-bottom:10px; padding:6px 10px; border-radius:6px;
  border:1px solid var(--border); background:var(--card); color: var(--text); cursor:pointer;
}

button.main {
  background-color: var(--brand); color: white; font-weight: 600; padding: 10px 18px;
  border: none; border-radius: 8px; cursor: pointer; transition: filter 0.2s ease;
  margin-bottom: 18px; display: inline-block;
}
button.main:hover { filter: brightness(0.92); }

input[type="text"], select {
  width: 100%; padding: 10px; border-radius: 8px;
  border: 1.5px solid var(--border); background: var(--card); color: var(--text); font-size: 1rem;
}

.container { display: flex; gap: 30px; min-height: 350px; flex-wrap: wrap; }
nav.menu {
  width: 220px; background-color: var(--card); border: 1px solid var(--border); border-radius: 8px;
  box-shadow: 0 2px 8px rgb(26 115 232 / 0.15); overflow-y: auto; padding: 10px 0; flex-shrink: 0;
}
nav.menu h2 { font-weight: 700; font-size: 1.05rem; color: var(--brand); padding: 8px 16px; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
nav.menu ul { list-style: none; padding-left: 0; margin: 0; }
nav.menu li {
  padding: 10px 14px; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease;
  font-weight: 600; font-size: 0.95rem; border-radius: 6px; margin: 4px 8px;
}
nav.menu li:hover { background-color: rgba(134,183,255,0.16); color: var(--brand); }
nav.menu li.active { background-color: var(--brand); color: white; }

section.content {
  flex: 1 1 700px; background-color: var(--card); border-radius: 8px; border: 1px solid var(--border);
  box-shadow: 0 2px 8px rgb(26 115 232 / 0.15); padding: 20px; overflow-x: auto; min-width: 300px;
}

.table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 600px; }
th, td {
  border: 1px solid var(--border); padding: 10px 12px; text-align: center; font-size: 0.95rem;
  white-space: nowrap; background: transparent; color: var(--text);
}
th { background-color: var(--thead); color: var(--theadText); font-weight: 700; user-select: none; }
p.no-data { font-size: 1.05rem; color: #8892a6; text-align: center; margin-top: 30px; }
td.player-name { color: var(--link); cursor: pointer; text-decoration: underline; }

/* ì†Œì œëª©/í¼ ë ˆì´ì•„ì›ƒ */
.subhead { font-weight: 800; color: var(--brand); margin: 8px 0 10px; }
.row { display: grid; grid-template-columns: repeat(3, minmax(160px, 1fr)); gap: 10px; }
.row-2 { display: grid; grid-template-columns: repeat(2, minmax(180px, 1fr)); gap: 10px; }
.tools { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px; }
.badge { display:inline-block; background: var(--thead); color: var(--theadText); border:1px solid var(--border); border-radius:999px; padding:5px 10px; font-weight:700; }

/* ================= SCOREBOARD ë°°ë„ˆ ================= */
#scoreboard{
  position:relative;
  width:100%;
  max-width:1100px;
  height:110px;
  margin:0 auto 16px auto;
  border-radius:16px;
  overflow:hidden;
  background: radial-gradient(120% 100% at 0% 0%, var(--sb-bg2), var(--sb-bg1));
  box-shadow:
    0 0 0 1px rgba(255,255,255,.06),
    inset 0 0 24px rgba(255,255,255,.08),
    0 10px 24px rgba(0,0,0,.18);
}
#sb-header{
  position:absolute; top:8px; left:12px;
  font-weight:900; letter-spacing:.08em; font-size:.85rem;
  color:var(--sb-gold); text-shadow:0 0 10px rgba(247,211,106,.35);
}
#sb-track{
  position:absolute; inset:0; display:flex; align-items:center;
  gap:28px; padding:0 16px 0 120px;  /* í—¤ë” ê³µê°„ */
  animation: marquee 20s linear infinite;
}
@keyframes marquee{
  0%{ transform: translateX(0); }
  100%{ transform: translateX(-50%); }
}
.sb-item{
  flex:0 0 auto;
  display:flex; align-items:baseline; gap:12px;
  color:#eaf2ff; font-weight:900; font-size:1.6rem; letter-spacing:.02em;
  padding:10px 18px; border-radius:12px;
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  box-shadow: inset 0 0 0 1px var(--sb-line), 0 6px 18px rgba(0,0,0,.18);
}
.sb-date{ font-size:.9rem; font-weight:800; opacity:.75; margin-right:6px; }
.sb-away{ color:var(--sb-blue); text-shadow:0 0 6px rgba(90,160,255,.35); }
.sb-home{ color:var(--sb-red);  text-shadow:0 0 6px rgba(255,107,107,.35); }
.sb-sep { opacity:.6; font-weight:700; }
.sb-score { background:rgba(255,255,255,.06); padding:2px 10px; border-radius:999px; font-size:1.2rem; }

/* ================= MVP ë°°ë„ˆ (ê¸°ì¡´) ================= */
#recentMvpSection{
  position:relative;
  width:100%;
  max-width:1100px;
  height:190px;
  margin:0 auto 20px auto;
  border-radius:16px;
  overflow:hidden;
  box-shadow:
    0 0 0 1px rgba(212,175,55,.55),
    inset 0 0 24px rgba(255,255,255,.18),
    0 10px 28px rgba(0,0,0,.18);
  background: linear-gradient(135deg, #0066FF 0 50%, #FF0033 50% 100%);
  display:flex; align-items:center; justify-content:center;
}
#recentMvpSection::before{
  content:"";
  position:absolute; inset:0;
  background:
    linear-gradient(45deg, rgba(255,255,255,.22) 1px, transparent 1px),
    linear-gradient(-45deg, rgba(255,255,255,.22) 1px, transparent 1px);
  background-size:22px 22px;
  mix-blend-mode:overlay;
  opacity:.22;
  pointer-events:none;
}
#recentMvpSection::after{
  content:"";
  position:absolute; inset:0;
  background:
    linear-gradient(135deg, transparent 49.2%, rgba(255,215,120,.9) 50%, transparent 50.8%);
  pointer-events:none;
}
.mvp-core{ position:relative; z-index:2; text-align:center; padding:18px; }
#mvpMain{
  font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif;
  font-weight:1000;
  font-size:clamp(42px, 8vw, 92px);
  line-height:.95; letter-spacing:.01em;
  color:transparent;
  background:linear-gradient(180deg, #E6C75A 0%, #D4AF37 52%, #8C6A00 100%);
  -webkit-background-clip:text; background-clip:text;
  -webkit-text-fill-color:transparent;
  text-shadow:0 0 6px rgba(212,175,55,.35), 0 0 12px rgba(212,175,55,.25);
  animation:mvpPulse 2.2s ease-in-out infinite;
}
@keyframes mvpPulse{ 0%,100%{transform:scale(1)} 50%{transform:scale(1.06)} }
#mvpSub{ margin-top:8px; font-weight:800; font-size:.95rem; color:#fff; text-shadow:0 2px 4px rgba(0,0,0,.35); }
.mvp-sparkles{ position:absolute; inset:0; z-index:1; pointer-events:none; overflow:visible; }
.mvp-sparkle{ position:absolute; top:50%; left:-40px; width:6px; height:6px; background: radial-gradient(circle, #fff 0 40%, rgba(255,255,255,0) 70%); opacity:0; }

/* ê¸°íƒ€ */
footer { margin-top:24px; opacity:.65; font-size:.9rem; }
  </style>
</head>
<body>

  <h1>ì„ ìˆ˜ ê¸°ë¡ ì¡°íšŒ ë° ë¶„ì•¼ë³„ ìˆœìœ„</h1>
  <button id="themeToggle" aria-label="Toggle Dark Mode">ğŸŒ™ ë‹¤í¬ ëª¨ë“œ</button>

  <!-- ===== SCOREBOARD (ì˜¤ëŠ˜ ê²½ê¸°/ìµœê·¼ ê²½ê¸°) ===== -->
  <div id="scoreboard" aria-live="polite">
    <div id="sb-header">SCOREBOARD</div>
    <div id="sb-track"></div>
  </div>

  <!-- ===== MVP ë°°ë„ˆ ===== -->
  <div id="recentMvpSection">
    <div class="mvp-core">
      <div id="mvpMain">MVP: ê¹€ì¤€ìš°</div>
      <div id="mvpSub">(Leaders / SP)</div>
    </div>
    <div class="mvp-sparkles" aria-hidden="true"></div>
  </div>

  <button class="main" id="goToInputBtn">ê¸°ë¡ ì…ë ¥ í˜ì´ì§€ë¡œ ì´ë™</button>

  <input type="text" id="searchInput" placeholder="ì„ ìˆ˜ ì´ë¦„ ê²€ìƒ‰" autocomplete="off" />

  <div class="container">
    <nav class="menu">
      <h2>íƒ€ì ë¶„ì•¼</h2>
      <ul id="hitterMenu">
        <li data-stat="íƒ€ìœ¨">íƒ€ìœ¨</li>
        <li data-stat="í™ˆëŸ°">í™ˆëŸ°</li>
        <li data-stat="ì¶œë£¨ìœ¨">ì¶œë£¨ìœ¨</li>
        <li data-stat="OPS">OPS</li>
        <li data-stat="íƒ€ì ">íƒ€ì </li>
        <li data-stat="WAR">WAR</li>
      </ul>
      <h2>íˆ¬ìˆ˜ ë¶„ì•¼</h2>
      <ul id="pitcherMenu">
        <li data-stat="ìŠ¹ë¦¬">ìŠ¹ë¦¬</li>
        <li data-stat="ì„¸ì´ë¸Œ">ì„¸ì´ë¸Œ</li>
        <li data-stat="í™€ë“œ">í™€ë“œ</li>
        <li data-stat="ì‚¼ì§„">ì‚¼ì§„</li>
        <li data-stat="ERA">ERA</li>
        <li data-stat="WHIP">WHIP</li>
      </ul>

      <h2>ëŒ€ê²°/ê²½ê¸°</h2>
      <ul id="extraMenu">
        <li data-view="h2h">ëŒ€ê²° ê²€ìƒ‰</li>
        <li data-view="games">ê²½ê¸° ê¸°ë¡</li>
      </ul>
    </nav>

    <section class="content" id="rankingContent">
      <p class="no-data">ë¶„ì•¼ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
    </section>
  </div>

  <!-- ====== H2H(íˆ¬ìˆ˜-íƒ€ì) ê²€ìƒ‰ ì„¹ì…˜ ====== -->
  <section class="content" id="h2hSection" style="display:none; margin-top:16px;">
    <div class="subhead">íˆ¬ìˆ˜â€“íƒ€ì ë§ëŒ€ê²° ê²€ìƒ‰</div>
    <div class="row-2">
      <div>
        <label>íˆ¬ìˆ˜ ì„ íƒ</label>
        <input list="dlPitchers" id="h2hPitcher" placeholder="íˆ¬ìˆ˜ ì´ë¦„ ì…ë ¥ ë˜ëŠ” ì„ íƒ" />
      </div>
      <div>
        <label>íƒ€ì ì„ íƒ</label>
        <input list="dlHitters" id="h2hHitter" placeholder="íƒ€ì ì´ë¦„ ì…ë ¥ ë˜ëŠ” ì„ íƒ" />
      </div>
    </div>
    <datalist id="dlPitchers"></datalist>
    <datalist id="dlHitters"></datalist>

    <div class="row-2" style="margin-top:10px;">
      <div>
        <label>ê²½ê¸° ì„ íƒ(ì„ íƒ ì‚¬í•­)</label>
        <select id="h2hGameSelect"><option value="">ì „ì²´ ê²½ê¸°</option></select>
      </div>
      <div>
        <label>ì •ë ¬</label>
        <select id="h2hSort">
          <option value="time_desc">ìµœì‹ ìˆœ</option>
          <option value="time_asc">ì˜¤ë˜ëœìˆœ</option>
          <option value="inning">ì´ë‹ìˆœ</option>
        </select>
      </div>
    </div>

    <div class="tools">
      <button class="main" id="h2hSearchBtn">ëŒ€ê²° ê²€ìƒ‰</button>
      <span class="badge" id="h2hSummary">ê²€ìƒ‰ ëŒ€ê¸°ì¤‘</span>
    </div>

    <div id="h2hResultWrap" style="margin-top:10px;">
      <table class="table" id="h2hTable">
        <thead>
          <tr>
            <th>#</th><th>ì‹œê°</th><th>ê²½ê¸°</th><th>ì´ë‹</th><th>ê³µê²©íŒ€</th>
            <th>íƒ€ì</th><th>íˆ¬ìˆ˜</th><th>ê²°ê³¼ ìš”ì•½</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:10px;">
        <div class="subhead">ìš”ì•½(í•´ë‹¹ ëŒ€ê²°)</div>
        <table class="table" id="h2hAggTable">
          <thead>
            <tr>
              <th>íƒ€ì„</th><th>ì•ˆíƒ€</th><th>2B</th><th>3B</th><th>HR</th><th>BB</th><th>SO</th>
              <th>RBI</th><th>R</th><th>AVG</th><th>OBP</th><th>SLG</th><th>OPS</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ====== ê²½ê¸° ê¸°ë¡ ì„¹ì…˜ ====== -->
  <section class="content" id="gamesSection" style="display:none; margin-top:16px;">
    <div class="subhead">ê²½ê¸° ê¸°ë¡ ë³´ê¸°</div>
    <div class="row">
      <div>
        <label>ê²½ê¸° ì„ íƒ</label>
        <select id="gameSelect"><option value="">(ì„ íƒ)</option></select>
      </div>
      <div>
        <label>íŒ€ í•„í„°(ì„ íƒ)</label>
        <select id="gameTeamFilter">
          <option value="">ì „ì²´</option>
          <option value="Leaders">Leaders</option>
          <option value="CSIA">CSIA</option>
        </select>
      </div>
      <div>
        <label>ì •ë ¬</label>
        <select id="gameSort">
          <option value="inning">ì´ë‹ìˆœ</option>
          <option value="time_desc">ìµœì‹ ìˆœ</option>
          <option value="time_asc">ì˜¤ë˜ëœìˆœ</option>
        </select>
      </div>
    </div>

    <div class="tools">
      <button class="main" id="gameLoadBtn">ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <span class="badge" id="gameSummary">ì„ íƒ ëŒ€ê¸°ì¤‘</span>
    </div>

    <table class="table" id="gameTable" style="margin-top:10px;">
      <thead>
        <tr>
          <th>#</th><th>ì‹œê°</th><th>ì´ë‹</th><th>ê³µê²©íŒ€</th><th>íƒ€ì</th><th>íˆ¬ìˆ˜</th><th>ê²°ê³¼ ìš”ì•½</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <div id="mvpRankingSection" style="display:none; margin-top:16px;">
    <h3>MVP ìˆœìœ„</h3>
    <table id="mvpRankingTable" class="table">
      <thead>
        <tr><th>ìˆœìœ„</th><th>ì„ ìˆ˜ëª…</th><th>íŒ€</th><th>MVP íšŸìˆ˜</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="teamStatsSection" style="display:none; margin-top:16px;">
    <h3>íŒ€ë³„ ì£¼ìš” í†µê³„</h3>
    <table id="teamStatsTable" class="table">
      <thead>
        <tr><th>íŒ€ëª…</th><th>íŒ€ íƒ€ìœ¨</th><th>íŒ€ ìì±…ì </th><th>íŒ€ ë“ì </th><th>íŒ€ íƒ€ì </th><th>íŒ€ ìŠ¹ë¥ </th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <footer>ì‚¬ì´íŠ¸ ì•„ì´ë””ì–´ ê¸°íš ë° ê°œë°œ: ì´ì›ì¤€</footer>

<script>
  const PLAYER_JSON_URL = "https://alex4u-jun.github.io/bs_record/players.json";
  const GAMERECORD_JSON_URL = "https://alex4u-jun.github.io/bs_record/gamerecord.json";

  /* ============= ë°ì´í„° ë¡œë” ============= */
  async function loadPlayersFromJson() {
    try {
      const res = await fetch(PLAYER_JSON_URL, {cache:'no-store'});
      if (!res.ok) throw new Error("ì„ ìˆ˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      return await res.json();
    } catch (err) {
      console.error("players fetch ì‹¤íŒ¨:", err);
      return [];
    }
  }
  async function loadGameRecordJson() {
    try {
      const res = await fetch(GAMERECORD_JSON_URL, {cache:'no-store'});
      if (!res.ok) throw new Error("ê²½ê¸° ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      return await res.json();
    } catch (err) {
      console.error("gamerecord fetch ì‹¤íŒ¨:", err);
      return {version:"0", games:[], events:[]};
    }
  }

  /* ============= ì—˜ë¦¬ë¨¼íŠ¸ ì°¸ì¡° ============= */
  const goToInputBtn = document.getElementById('goToInputBtn');
  const hitterMenu = document.getElementById('hitterMenu');
  const pitcherMenu = document.getElementById('pitcherMenu');
  const extraMenu = document.getElementById('extraMenu');
  const rankingContent = document.getElementById('rankingContent');
  const searchInput = document.getElementById('searchInput');

  const mvpMain = document.getElementById('mvpMain');
  const mvpSub  = document.getElementById('mvpSub');
  const mvpRankingSection = document.getElementById('mvpRankingSection');
  const mvpRankingTableBody = document.querySelector('#mvpRankingTable tbody');
  const teamStatsSection = document.getElementById('teamStatsSection');
  const teamStatsTableBody = document.querySelector('#teamStatsTable tbody');

  const h2hSection = document.getElementById('h2hSection');
  const gamesSection = document.getElementById('gamesSection');

  // H2H
  const h2hPitcher = document.getElementById('h2hPitcher');
  const h2hHitter = document.getElementById('h2hHitter');
  const dlPitchers = document.getElementById('dlPitchers');
  const dlHitters = document.getElementById('dlHitters');
  const h2hGameSelect = document.getElementById('h2hGameSelect');
  const h2hSort = document.getElementById('h2hSort');
  const h2hSearchBtn = document.getElementById('h2hSearchBtn');
  const h2hSummary = document.getElementById('h2hSummary');
  const h2hTableBody = document.querySelector('#h2hTable tbody');
  const h2hAggBody = document.querySelector('#h2hAggTable tbody');

  // ê²Œì„
  const gameSelect = document.getElementById('gameSelect');
  const gameTeamFilter = document.getElementById('gameTeamFilter');
  const gameSort = document.getElementById('gameSort');
  const gameLoadBtn = document.getElementById('gameLoadBtn');
  const gameSummary = document.getElementById('gameSummary');
  const gameTableBody = document.querySelector('#gameTable tbody');

  const hitterStatsForRanking = ['íƒ€ìœ¨', 'í™ˆëŸ°', 'ì¶œë£¨ìœ¨', 'OPS', 'íƒ€ì ', 'WAR'];
  const pitcherStatsForRanking = ['ìŠ¹ë¦¬', 'ì„¸ì´ë¸Œ', 'í™€ë“œ', 'ì‚¼ì§„', 'ERA', 'WHIP'];

  function isDescPreferred(stat){
    return ['íƒ€ìœ¨','í™ˆëŸ°','ì¶œë£¨ìœ¨','OPS','íƒ€ì ','ìŠ¹ë¦¬','ì„¸ì´ë¸Œ','í™€ë“œ','ì‚¼ì§„','WAR'].includes(stat);
  }
  let currentSort = { column: null, asc: true };

  /* MVP ë¡œë“œ */
  function loadRecentMvp() {
    const mvpData = localStorage.getItem('lastMvp');
    if (!mvpData) return;
    const mvp = JSON.parse(mvpData);
    if (mvpMain) mvpMain.textContent = `MVP: ${mvp.name}`;
    if (mvpSub)  mvpSub.textContent  = `(${mvp.team} / ${mvp.type})`;
  }

  /* ìœ í‹¸ */
  function filterByName(players, keyword) {
    if (!keyword) return players;
    const lower = keyword.toLowerCase();
    return players.filter(p => p.name.toLowerCase().includes(lower));
  }
  function getTodayStr(){
    const d=new Date();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const day=String(d.getDate()).padStart(2,'0');
    return `${d.getFullYear()}-${m}-${day}`;
  }

  /* ===== íƒ€ì/íˆ¬ìˆ˜ ì§€í‘œ ê³„ì‚° =====
     (ABì— ë³¼ë„· í¬í•¨í•˜ì§€ ì•ŠìŒ! => íƒ€ìœ¨ ì •í™•) */
  function calculateAB(p){
    const H = (p.stats['1ë£¨íƒ€']||0)+(p.stats['2ë£¨íƒ€']||0)+(p.stats['3ë£¨íƒ€']||0)+(p.stats['í™ˆëŸ°']||0);
    // SO/ë•…ë³¼/í”Œë¼ì´ì•„ì›ƒì€ íƒ€ìˆ˜ì— í¬í•¨, ë³¼ë„· ì œì™¸
    return H + (p.stats['ì‚¼ì§„']||0) + (p.stats['ë‚´ì•¼ë•…ë³¼']||0) + (p.stats['í”Œë¼ì´ì•„ì›ƒ']||0);
  }
  function calculatePA(p){ // íƒ€ì„ = AB + ë³¼ë„· + í¬ìƒí”Œë¼ì´
    const AB = calculateAB(p);
    const BB = p.stats['ë³¼ë„·']||0;
    const SF = p.stats['í¬ìƒí”Œë¼ì´']||0;
    return AB + BB + SF;
  }
  function calculateAVG(p) {
    const H = (p.stats['1ë£¨íƒ€']||0) + (p.stats['2ë£¨íƒ€']||0) + (p.stats['3ë£¨íƒ€']||0) + (p.stats['í™ˆëŸ°']||0);
    const AB = calculateAB(p);
    return AB ? H / AB : 0;
  }
  function calculateOBP(p) {
    const H = (p.stats['1ë£¨íƒ€']||0) + (p.stats['2ë£¨íƒ€']||0) + (p.stats['3ë£¨íƒ€']||0) + (p.stats['í™ˆëŸ°']||0);
    const BB = p.stats['ë³¼ë„·']||0;
    const AB = calculateAB(p);
    const SF = p.stats['í¬ìƒí”Œë¼ì´']||0;
    const denom = AB + BB + SF;
    return denom ? (H + BB) / denom : 0;
  }
  function calculateSLG(p) {
    const singles = (p.stats['1ë£¨íƒ€']||0);
    const doubles = p.stats['2ë£¨íƒ€']||0, triples = p.stats['3ë£¨íƒ€']||0, HR = p.stats['í™ˆëŸ°']||0;
    const AB = calculateAB(p);
    const TB = singles + doubles*2 + triples*3 + HR*4;
    return AB ? TB / AB : 0;
  }
  function calculateOPS(p) { return calculateOBP(p) + calculateSLG(p); }
  function calculateERA(p) {
    const ER = p.stats['ìì±…ì ']||0, IP = p.stats['ì´ë‹']||0;
    return IP ? (ER * 9) / IP : 0;
  }
  function calculateWHIP(p) {
    const BB = p.stats['ë³¼ë„·']||0, H = p.stats['í”¼ì•ˆíƒ€']||0, IP = p.stats['ì´ë‹']||0;
    return IP ? (BB + H) / IP : 0;
  }

  // ===== WAR(íƒ€ì) ê³„ì‚°(ê°„ë‹¨ëª¨ë¸)
  const WAR_WEIGHTS = { single:0.90, double:1.25, triple:1.60, hr:2.00, bb:0.70 };
  const WOBASCALE = 1.15, RUNS_PER_WIN = 10, REPLACEMENT_PER_600PA = 20;
  function wobaNumeratorFromStats(p){
    const s = p.stats||{};
    const singles = (s['1ë£¨íƒ€']||0);
    const doubles = (s['2ë£¨íƒ€']||0);
    const triples = (s['3ë£¨íƒ€']||0);
    const hr      = (s['í™ˆëŸ°']||0);
    const bb      = (s['ë³¼ë„·']||0);
    return singles*WAR_WEIGHTS.single + doubles*WAR_WEIGHTS.double +
           triples*WAR_WEIGHTS.triple + hr*WAR_WEIGHTS.hr + bb*WAR_WEIGHTS.bb;
  }
  function computeLeagueWoba(hitters){
    let num=0, den=0;
    hitters.forEach(h=>{ num += wobaNumeratorFromStats(h); den += calculatePA(h); });
    return den? num/den : 0;
  }
  function buildWarMap(hittersAll){
    const leagueWoba = computeLeagueWoba(hittersAll);
    const map = {};
    hittersAll.forEach(p=>{
      const PA = calculatePA(p);
      if(!PA){ map[p.name]=0; return; }
      const woba = wobaNumeratorFromStats(p)/PA;
      const wRAA = (woba - leagueWoba)/WOBASCALE * PA;
      const repRuns = REPLACEMENT_PER_600PA * (PA/600);
      const WAR = (wRAA + repRuns) / RUNS_PER_WIN;
      map[p.name] = WAR;
    });
    return map;
  }

  function getStatValue(p, stat) {
    switch(stat) {
      case 'íƒ€ìœ¨': return calculateAVG(p);
      case 'ì¶œë£¨ìœ¨': return calculateOBP(p);
      case 'OPS': return calculateOPS(p);
      case 'í™ˆëŸ°': case 'íƒ€ì ': case 'ìŠ¹ë¦¬':
      case 'ì„¸ì´ë¸Œ': case 'í™€ë“œ': case 'ì‚¼ì§„':
        return p.stats[stat] || 0;
      case 'ERA': return calculateERA(p);
      case 'WHIP': return calculateWHIP(p);
      case 'WAR': return p.__war || 0;
      default: return 0;
    }
  }
  function getStatDisplay(p, stat) {
    const val = getStatValue(p, stat);
    if (['íƒ€ìœ¨', 'ì¶œë£¨ìœ¨', 'OPS', 'WHIP'].includes(stat)) return val.toFixed(3);
    if (stat === 'ERA') return val.toFixed(2);
    if (stat === 'WAR') return val.toFixed(1);
    return val;
  }

  /* ===== ìˆœìœ„í‘œ ë Œë” ===== */
  function getMedalIcon(i){ return i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':''; }
  function createRankingTable(players, stat) {
    const table = document.createElement('table'); table.className = 'table';
    const thead = document.createElement('thead');
    const tbody = document.createElement('tbody');
    const headerRow = document.createElement('tr');
    ['ìˆœìœ„', 'ì„ ìˆ˜ëª…', stat].forEach((t, i) => {
      const th = document.createElement('th'); th.textContent = t;
      if (i === 2) {
        th.style.cursor = 'pointer';
        th.addEventListener('click', () => {
          currentSort.column = stat; currentSort.asc = !currentSort.asc;
          renderRanking(stat, currentSort.asc);
        });
        th.textContent += currentSort.asc ? ' â–²' : ' â–¼';
      }
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);

    players.forEach((p, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${getMedalIcon(i)}${i+1}</td>
        <td class="player-name" style="cursor:pointer;text-decoration:underline">${p.name}</td>
        <td>${getStatDisplay(p, stat)}</td>`;
      tr.querySelector('.player-name').onclick = () => {
        window.location.href = `player_detail.html?name=${encodeURIComponent(p.name)}&type=${encodeURIComponent(p.type)}`;
      };
      tbody.appendChild(tr);
    });
    table.appendChild(thead); table.appendChild(tbody); return table;
  }

  async function renderRanking(stat, asc = true) {
    rankingContent.innerHTML = '';
    const allPlayers = await loadPlayersFromJson();
    const isHitterStat = hitterStatsForRanking.includes(stat);
    let players = allPlayers.filter(p => isHitterStat ? p.type==='íƒ€ì' : p.type==='íˆ¬ìˆ˜');

    if (stat === 'WAR') {
      const hittersAll = allPlayers.filter(p=>p.type==='íƒ€ì');
      const warMap = buildWarMap(hittersAll);
      players.forEach(p => p.__war = warMap[p.name] || 0);
    }
    const keyword = searchInput.value.trim();
    players = filterByName(players, keyword);

    players.sort((a, b) => {
      const va = getStatValue(a, stat), vb = getStatValue(b, stat);
      return asc ? (va - vb) : (vb - va);
    });

    rankingContent.appendChild(createRankingTable(players, stat));
  }

  /* ===== MVP/íŒ€ í†µê³„ ===== */
  async function renderMvpRanking() {
    const players = (await loadPlayersFromJson()).filter(p => p.mvpCount > 0);
    if (!players.length) return mvpRankingSection.style.display = 'none';
    mvpRankingSection.style.display = 'block';

    const mvpMap = {};
    players.forEach(p => {
      if (!mvpMap[p.name]) mvpMap[p.name] = { ...p, teams: [p.team], types: [p.type] };
      else {
        mvpMap[p.name].mvpCount += p.mvpCount;
        if (!mvpMap[p.name].teams.includes(p.team)) mvpMap[p.name].teams.push(p.team);
      }
    });

    const list = Object.values(mvpMap).sort((a,b) => b.mvpCount - a.mvpCount);
    mvpRankingTableBody.innerHTML = '';
    list.forEach((p, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td class="player-name" style="cursor:pointer;text-decoration:underline">${p.name}</td><td>${p.teams.join(', ')}</td><td>${p.mvpCount}</td>`;
      tr.querySelector('.player-name').onclick = () => {
        window.location.href = `player_detail.html?name=${encodeURIComponent(p.name)}&type=${encodeURIComponent(p.types[0])}`;
      };
      mvpRankingTableBody.appendChild(tr);
    });
  }
  async function calculateTeamStats() {
    const players = await loadPlayersFromJson();
    const teams = {};
    players.forEach(p => {
      const t = teams[p.team] ||= {
        totalHits: 0, totalAtBats: 0, totalER: 0, totalInnings: 0,
        totalRuns: 0, totalRBI: 0, totalWins: 0, totalLosses: 0
      };
      if (p.type === 'íƒ€ì') {
        const H = (p.stats['1ë£¨íƒ€']||0)+(p.stats['2ë£¨íƒ€']||0)+(p.stats['3ë£¨íƒ€']||0)+(p.stats['í™ˆëŸ°']||0);
        const AB = calculateAB(p);
        t.totalHits += H; t.totalAtBats += AB; t.totalRBI += p.stats['íƒ€ì '] || 0;
      }
      if (p.type === 'íˆ¬ìˆ˜') {
        t.totalER += p.stats['ìì±…ì ']||0;
        t.totalInnings += p.stats['ì´ë‹']||0;
        t.totalWins += p.stats['ìŠ¹ë¦¬']||0;
        t.totalLosses += p.stats['íŒ¨ë°°']||0;
      }
    });
    teamStatsTableBody.innerHTML = '';
    for (const [team, t] of Object.entries(teams)) {
      const avg = t.totalAtBats ? t.totalHits / t.totalAtBats : 0;
      const era = t.totalInnings ? (t.totalER * 9 / t.totalInnings) : 0;
      const winRate = (t.totalWins + t.totalLosses) ? t.totalWins / (t.totalWins + t.totalLosses) : 0;
      teamStatsTableBody.innerHTML += `
        <tr>
          <td>${team}</td><td>${avg.toFixed(3)}</td><td>${era.toFixed(2)}</td>
          <td>â€“</td><td>${t.totalRBI}</td><td>${(winRate*100).toFixed(1)}%</td>
        </tr>`;
    }
    teamStatsSection.style.display = 'block';
  }

  /* ======== H2H / ê²Œì„ ê³µí†µ ìœ í‹¸ ======== */
  function fmtTs(ts){
    if(!ts) return '';
    const d = new Date(ts);
    if (isNaN(d.getTime())) return ts;
    const mm = (d.getMonth()+1).toString().padStart(2,'0');
    const dd = d.getDate().toString().padStart(2,'0');
    const hh = d.getHours().toString().padStart(2,'0');
    const mi = d.getMinutes().toString().padStart(2,'0');
    return `${d.getFullYear()}-${mm}-${dd} ${hh}:${mi}`;
  }
  function outcomeToText(o){
    if(!o) return '';
    const arr=[];
    if(o.hitterEvent||o.hitterEvt) arr.push(o.hitterEvent||o.hitterEvt);
    if(o.rbiDelta||o.rbi) arr.push(`RBI+${o.rbiDelta||o.rbi}`);
    if(o.runScoredDelta||o.run) arr.push(`R+${o.runScoredDelta||o.run}`);
    if(o.pitcherEvent||o.pitcherEvt) arr.push(`P:${o.pitcherEvent||o.pitcherEvt}`);
    if(o.pitcherDecision) arr.push(o.pitcherDecision);
    if(o.pitchCountDelta||o.pitchCount) arr.push(`PC+${o.pitchCountDelta||o.pitchCount}`);
    if(o.inningsDelta) arr.push(`IP+${o.inningsDelta}`);
    if(o.earnedRunsDelta||o.er) arr.push(`ER+${o.earnedRunsDelta||o.er}`);
    return arr.join(' Â· ');
  }

  /* ë‹¤í¬ ëª¨ë“œ í† ê¸€ */
  (function(){
    const root = document.documentElement;
    const btn = document.getElementById('themeToggle');
    const saved = localStorage.getItem('theme');
    if(saved){
      root.setAttribute('data-theme', saved);
      if(saved==='dark') btn.textContent='â˜€ï¸ ë¼ì´íŠ¸ ëª¨ë“œ';
    }
    btn.addEventListener('click', ()=>{
      const isDark = root.getAttribute('data-theme') === 'dark';
      const next = isDark ? '' : 'dark';
      if(next) root.setAttribute('data-theme', next); else root.removeAttribute('data-theme');
      localStorage.setItem('theme', next || '');
      btn.textContent = next==='dark' ? 'â˜€ï¸ ë¼ì´íŠ¸ ëª¨ë“œ' : 'ğŸŒ™ ë‹¤í¬ ëª¨ë“œ';
    });
  })();

  document.addEventListener('DOMContentLoaded', async () => {
    loadRecentMvp();
    await renderMvpRanking();
    await calculateTeamStats();
    await prepareH2HForm();
    await prepareGameList();
    await renderScoreboard();   // â† gamerecord.jsonì—ì„œ ìë™ ë¡œë“œ
  });

  goToInputBtn.onclick = () => {
    const pw = prompt("ê¸°ë¡ ì…ë ¥ í˜ì´ì§€ ì ‘ê·¼ì„ ìœ„í•œ ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    if (pw === "Leaders0903") location.href = "index.html";
    else alert("ì•”í˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
  };

  function clearActiveMenu() {
    [...hitterMenu.children, ...pitcherMenu.children, ...extraMenu.children].forEach(li => li.classList.remove('active'));
  }

  hitterMenu.onclick = e => {
    if (e.target.tagName === 'LI') {
      clearActiveMenu();
      e.target.classList.add('active');
      const stat = e.target.dataset.stat;
      currentSort.column = stat;
      currentSort.asc = !isDescPreferred(stat);
      searchInput.value = '';
      rankingContent.style.display='block';
      h2hSection.style.display='none';
      gamesSection.style.display='none';
      renderRanking(currentSort.column, currentSort.asc);
    }
  };

  pitcherMenu.onclick = e => {
    if (e.target.tagName === 'LI') {
      clearActiveMenu();
      e.target.classList.add('active');
      const stat = e.target.dataset.stat;
      currentSort.column = stat;
      currentSort.asc = !isDescPreferred(stat);
      searchInput.value = '';
      rankingContent.style.display='block';
      h2hSection.style.display='none';
      gamesSection.style.display='none';
      renderRanking(currentSort.column, currentSort.asc);
    }
  };

  extraMenu.onclick = e => {
    if (e.target.tagName === 'LI') {
      clearActiveMenu();
      e.target.classList.add('active');
      const view = e.target.dataset.view;
      rankingContent.style.display = 'block';   // ìƒë‹¨ ìœ ì§€
      if (view === 'h2h') {
        gamesSection.style.display = 'none';
        h2hSection.style.display = 'block';
      } else if (view === 'games') {
        h2hSection.style.display = 'none';
        gamesSection.style.display = 'block';
      }
    }
  };

  searchInput.oninput = () => {
    if (currentSort.column) renderRanking(currentSort.column, currentSort.asc);
  };

  /* ======================= gamerecord í˜¸í™˜ ì •ê·œí™” ======================= */
  function normGame(g){
    if(!g) return null;
    return {
      id: g.gameId || g.id,
      date: g.date,
      awayTeam: g.awayTeam || g.away || g.visitor,
      homeTeam: g.homeTeam || g.home,
    };
  }
  function normEvent(e){
    if(!e) return null;
    return {
      gameId: e.gameId || e.id || e.gid,
      ts: e.ts || e.timestamp,
      inning: e.inning,
      half: e.half || e.topbottom || e.tb,
      offenseTeam: e.offenseTeam || e.offense || e.battingTeam,
      defenseTeam: e.defenseTeam || e.defense || e.fieldingTeam,
      hitterName: e.hitterName || e.batterName || e.hitter || e.batter,
      pitcherName: e.pitcherName || e.pitcher,
      hitterEvent: e.hitterEvent,
      rbiDelta: e.rbiDelta || e.rbi,
      runScoredDelta: e.runScoredDelta || e.run,
      pitcherEvent: e.pitcherEvent,
      pitcherDecision: e.pitcherDecision,
      pitchCountDelta: e.pitchCountDelta || e.pitchCount,
      inningsDelta: e.inningsDelta,
      earnedRunsDelta: e.earnedRunsDelta || e.er,
      outcome: e.outcome
    };
  }

  /* =============== H2H ì¤€ë¹„/ê²€ìƒ‰ =============== */
  async function prepareH2HForm(){
    const players = await loadPlayersFromJson();
    const pitchers = players.filter(p=>p.type==='íˆ¬ìˆ˜').map(p=>p.name);
    const hitters  = players.filter(p=>p.type==='íƒ€ì').map(p=>p.name);
    dlPitchers.innerHTML = pitchers.map(n=>`<option value="${n}">`).join('');
    dlHitters.innerHTML  = hitters.map(n=>`<option value="${n}">`).join('');

    const gr = await loadGameRecordJson();
    const options = (gr.games||[]).map(normGame).filter(Boolean);
    h2hGameSelect.innerHTML = '<option value="">ì „ì²´ ê²½ê¸°</option>' + options
      .sort((a,b)=>a.date.localeCompare(b.date))
      .map(g=>`<option value="${g.id}">${g.date} Â· ${g.awayTeam} @ ${g.homeTeam}</option>`).join('');
  }

  function normalizeOutcomeForAgg(ev){
    const o = ev.outcome || {
      hitterEvent: ev.hitterEvent, rbi: ev.rbiDelta, run: ev.runScoredDelta,
      pitcherEvent: ev.pitcherEvent, pitcherDecision: ev.pitcherDecision,
      pitchCount: ev.pitchCountDelta, inningsDelta: ev.inningsDelta, er: ev.earnedRunsDelta
    };
    const tag = (o.hitterEvt || o.hitterEvent || '').trim();
    const norm = {h:0, bb:0, so:0, sf:0, out:0, rbi:(o.rbi||o.rbiDelta||0), run:(o.run||o.runScoredDelta||0)};
    if (tag === '1ë£¨íƒ€') norm.h = 1;
    else if (tag === '2ë£¨íƒ€') norm.h = 2;
    else if (tag === '3ë£¨íƒ€') norm.h = 3;
    else if (tag === 'í™ˆëŸ°') norm.h = 4;
    else if (tag === 'ë³¼ë„·') norm.bb = 1;
    else if (tag === 'ì‚¼ì§„') norm.so = 1;
    else if (tag === 'í¬ìƒí”Œë¼ì´') norm.sf = 1;
    else if (tag === 'ë‚´ì•¼ë•…ë³¼' || tag === 'í”Œë¼ì´ì•„ì›ƒ' || tag==='') norm.out = 1;
    return norm;
  }
  function calcAggFromEvents(events){
    let PA=0,H=0,_2B=0,_3B=0,HR=0,BB=0,SO=0,RBI=0,R=0,AB=0,TB=0,SF=0;
    events.forEach(e=>{
      const o=e._o;
      PA += 1;
      if (o.h === 1){H++;AB++;TB+=1;}
      else if (o.h === 2){H++;_2B++;AB++;TB+=2;}
      else if (o.h === 3){H++;_3B++;AB++;TB+=3;}
      else if (o.h === 4){H++;HR++;AB++;TB+=4;}
      else if (o.bb){BB++;}
      else if (o.so){SO++;AB++;}
      else if (o.out){AB++;}
      if (o.sf){SF++;}
      RBI += (o.rbi||0); R += (o.run||0);
    });
    const OBPden = AB + BB + SF;
    const AVG = AB ? H/AB : 0;
    const OBP = OBPden ? (H + BB)/OBPden : 0;
    const SLG = AB ? TB/AB : 0;
    const OPS = OBP + SLG;
    return {PA,H,_2B,_3B,HR,BB,SO,RBI,R,AVG,OBP,SLG,OPS};
  }

  h2hSearchBtn.addEventListener('click', async ()=>{
    const pitcher = h2hPitcher.value.trim();
    const hitter  = h2hHitter.value.trim();
    if (!pitcher || !hitter) return alert('íˆ¬ìˆ˜ì™€ íƒ€ìë¥¼ ëª¨ë‘ ì…ë ¥/ì„ íƒí•˜ì„¸ìš”.');

    const gr = await loadGameRecordJson();
    const gameFilter = h2hGameSelect.value || '';
    let evs = (gr.events||[]).map(normEvent).filter(Boolean).filter(e =>
      (e.pitcherName===pitcher) && (e.hitterName===hitter) &&
      (!gameFilter || e.gameId===gameFilter)
    );

    // ì†ŒíŒ…
    const sort = h2hSort.value;
    if (sort === 'time_desc') evs.sort((a,b)=> (b.ts||0)-(a.ts||0));
    else if (sort === 'time_asc') evs.sort((a,b)=> (a.ts||0)-(b.ts||0));
    else if (sort === 'inning') {
      const halfRank = h=> (h==='ì´ˆ'?0:1);
      evs.sort((a,b)=> (a.inning-b.inning) || (halfRank(a.half)-halfRank(b.half)) || ((a.ts||0)-(b.ts||0)));
    }

    // í‘œ ë Œë”
    h2hTableBody.innerHTML = '';
    const gamesMap = {};
    (gr.games||[]).map(normGame).forEach(g=>g&& (gamesMap[g.id]=g));

    evs.forEach((e,i)=>{
      const g = gamesMap[e.gameId];
      const text = outcomeToText({
        hitterEvent: e.hitterEvent, rbi:e.rbiDelta, run:e.runScoredDelta,
        pitcherEvent: e.pitcherEvent, pitcherDecision:e.pitcherDecision,
        pitchCount: e.pitchCountDelta, inningsDelta: e.inningsDelta, er: e.earnedRunsDelta
      } || e.outcome);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${fmtTs(e.ts)}</td>
        <td>${g? `${g.date} Â· ${g.awayTeam} @ ${g.homeTeam}` : (e.gameId||'')}</td>
        <td>${e.inning}íšŒ ${e.half||''}</td>
        <td>${e.offenseTeam||''}</td>
        <td>${e.hitterName||''}</td>
        <td>${e.pitcherName||''}</td>
        <td>${text}</td>`;
      h2hTableBody.appendChild(tr);
      e._o = normalizeOutcomeForAgg(e);
    });

    h2hSummary.textContent = `ëŒ€ê²° ìˆ˜: ${evs.length}ê±´`;
    const agg = calcAggFromEvents(evs);
    h2hAggBody.innerHTML = `
      <tr>
        <td>${agg.PA}</td>
        <td>${(agg.H - agg._2B - agg._3B - agg.HR)}</td>
        <td>${agg._2B}</td>
        <td>${agg._3B}</td>
        <td>${agg.HR}</td>
        <td>${agg.BB}</td>
        <td>${agg.SO}</td>
        <td>${agg.RBI}</td>
        <td>${agg.R}</td>
        <td>${agg.AVG.toFixed(3)}</td>
        <td>${agg.OBP.toFixed(3)}</td>
        <td>${agg.SLG.toFixed(3)}</td>
        <td>${agg.OPS.toFixed(3)}</td>
      </tr>`;
  });

  /* =============== ê²½ê¸° ê¸°ë¡ ë³´ê¸° =============== */
  async function prepareGameList(){
    const gr = await loadGameRecordJson();
    const list = (gr.games||[]).map(normGame).filter(Boolean)
      .sort((a,b)=>a.date.localeCompare(b.date));
    gameSelect.innerHTML = '<option value="">(ì„ íƒ)</option>' +
      list.map(g=>`<option value="${g.id}">${g.date} Â· ${g.awayTeam} @ ${g.homeTeam}</option>`).join('');
  }

  gameLoadBtn.addEventListener('click', async ()=>{
    const id = gameSelect.value;
    if(!id) return alert('ê²½ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
    const gr = await loadGameRecordJson();
    const gamesMap = {};
    (gr.games||[]).map(normGame).forEach(g=>g && (gamesMap[g.id]=g));

    let evs = (gr.events||[]).map(normEvent).filter(e=>e && e.gameId===id);
    const teamF = gameTeamFilter.value;
    if (teamF) evs = evs.filter(e=> e.offenseTeam===teamF || e.defenseTeam===teamF);

    const sort = gameSort.value;
    if (sort === 'time_desc') evs.sort((a,b)=> (b.ts||0)-(a.ts||0));
    else if (sort === 'time_asc') evs.sort((a,b)=> (a.ts||0)-(b.ts||0));
    else if (sort === 'inning') {
      const halfRank = h=> (h==='ì´ˆ'?0:1);
      evs.sort((a,b)=> (a.inning-b.inning) || (halfRank(a.half)-halfRank(b.half)) || ((a.ts||0)-(b.ts||0)));
    }

    gameTableBody.innerHTML = '';
    evs.forEach((e,i)=>{
      const text = outcomeToText({
        hitterEvent: e.hitterEvent, rbi:e.rbiDelta, run:e.runScoredDelta,
        pitcherEvent: e.pitcherEvent, pitcherDecision:e.pitcherDecision,
        pitchCount: e.pitchCountDelta, inningsDelta: e.inningsDelta, er: e.earnedRunsDelta
      } || e.outcome);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${fmtTs(e.ts)}</td>
        <td>${e.inning}íšŒ ${e.half||''}</td>
        <td>${e.offenseTeam||''}</td>
        <td>${e.hitterName||''}</td>
        <td>${e.pitcherName||''}</td>
        <td>${text}</td>`;
      gameTableBody.appendChild(tr);
    });

    const g = gamesMap[id];
    gameSummary.textContent = g ? `ê²½ê¸°: ${g.awayTeam} @ ${g.homeTeam} Â· ${g.date} Â· ì´ë²¤íŠ¸ ${evs.length}ê±´` : `ì´ë²¤íŠ¸ ${evs.length}ê±´`;
  });

  /* =================== SCOREBOARD ë Œë” =================== */
  async function renderScoreboard(){
    const wrap = document.getElementById('sb-track');
    const gr = await loadGameRecordJson();
    const games = (gr.games||[]).map(normGame).filter(Boolean);
    if (!games.length){ wrap.textContent = ''; return; }

    // ì˜¤ëŠ˜ ê²½ê¸° ìš°ì„ , ì—†ìœ¼ë©´ ê°€ì¥ ìµœê·¼ ë‚ ì§œ
    const today = getTodayStr();
    let list = games.filter(g=>g.date===today);
    if (!list.length){
      const lastDate = games.map(g=>g.date).sort().pop();
      list = games.filter(g=>g.date===lastDate);
    }

    // ì ìˆ˜ëŠ” eventsì—ì„œ ê³„ì‚°(ê°„ë‹¨ í•©ê³„)
    const events = (gr.events||[]).map(normEvent).filter(Boolean);
    function calcScore(gameId){
      let home=0, away=0;
      events.filter(e=>e.gameId===gameId).forEach(e=>{
        const g = games.find(x=>x.id===gameId); if(!g) return;
        const r = Number(e.runScoredDelta||0);
        if(!r) return;
        if (e.offenseTeam===g.homeTeam) home += r;
        else if (e.offenseTeam===g.awayTeam) away += r;
      });
      return {home,away};
    }

    // ë‘ ë°° ì±„ì›Œ ë¬´í•œ ë§ˆí€´
    const items = list.map(g=>{
      const sc = calcScore(g.id);
      return `
        <div class="sb-item">
          <span class="sb-date">${g.date}</span>
          <span class="sb-away">${g.awayTeam}</span>
          <span class="sb-score">${sc.away}</span>
          <span class="sb-sep">/</span>
          <span class="sb-home">${g.homeTeam}</span>
          <span class="sb-score">${sc.home}</span>
        </div>`;
    }).join('');
    wrap.innerHTML = items + items; // ë¬´í•œ ë£¨í”„ ëŠë‚Œ

    // í•­ëª© ìˆ˜ì— ë”°ë¼ ì†ë„ ì¡°ì •
    const dur = Math.max(12, list.length * 8);
    wrap.style.animationDuration = dur + 's';
  }

</script>

</body>
</html>

