<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì„ ìˆ˜ ê¸°ë¡ ì¡°íšŒ ë° ë¶„ì•¼ë³„ ìˆœìœ„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
/* ===================== í…Œë§ˆ (ë¼ì´íŠ¸/ë‹¤í¬) ===================== */
:root{
  --bg:#f9faff; --text:#333; --card:#ffffff; --border:#dddddd; --brand:#1a73e8;
  --thead:#e8f0fe; --theadText:#1a73e8; --link:#1a73e8;

  /* SCOREBOARD */
  --sb-bg1:#0b1220; --sb-bg2:#101a30; --sb-line:rgba(255,255,255,.06);
  --sb-blue:#5aa0ff; --sb-red:#ff6b6b;

  /* MVP banner */
  --mvp-gold1:#E6C75A; --mvp-gold2:#D4AF37; --mvp-gold3:#8C6A00;
}
[data-theme="dark"]{
  --bg:#0f172a; --text:#e5e7eb; --card:#0b1220; --border:#22314d; --brand:#86b7ff;
  --thead:#13213a; --theadText:#cfe2ff; --link:#9ec5fe;
}

/* ===================== ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ===================== */
body{
  font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif;
  max-width: 1100px; margin: 32px auto; padding: 20px 16px;
  background: var(--bg); color: var(--text); overflow-x: hidden;
}
h1{ font-weight: 800; font-size: 2rem; color: var(--brand); text-align:center; margin: 0 0 12px; }

.top-actions{ display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; margin-bottom:14px; }
.btn{
  display:inline-flex; align-items:center; gap:6px;
  background: var(--card); color: var(--text);
  border:1px solid var(--border); border-radius:10px; padding:8px 12px;
  cursor:pointer; box-shadow: 0 2px 8px rgba(26,115,232,.12);
}
.btn.primary{ background: var(--brand); color:#fff; border-color: transparent; }
.btn:hover{ filter: brightness(.98); }
.btn:active{ transform: translateY(0.5px); }

/* ===================== ì»¨í…Œì´ë„ˆ ===================== */
.container{ display:flex; gap: 24px; min-height: 350px; flex-wrap: nowrap; }
nav.menu{
  width: 240px; background: var(--card); border:1px solid var(--border); border-radius:12px;
  box-shadow: 0 2px 8px rgb(26 115 232 / 0.15); padding:10px 0; flex-shrink:0;
}
nav.menu h2{ font-weight:800; font-size:1.05rem; color:var(--brand); padding:8px 14px; border-bottom:1px solid var(--border); margin:0 0 8px; }
nav.menu ul{ list-style:none; margin:0; padding:0; }
nav.menu li{
  margin: 4px 8px; padding: 10px 12px; border-radius:8px;
  font-weight:700; cursor:pointer; transition: .15s;
}
nav.menu li:hover{ background:rgba(134,183,255,.16); color:var(--brand); }
nav.menu li.active{ background:var(--brand); color:#fff; }

section.content{
  flex:1 1 700px; min-width: 0;
  background: var(--card); border:1px solid var(--border); border-radius:12px;
  box-shadow: 0 2px 8px rgb(26 115 232 / 0.15); padding: 16px; overflow-x:auto;
}

/* ===================== í…Œì´ë¸” ===================== */
.table{
  width:100%; border-collapse: collapse; margin-top:10px;
  table-layout: fixed;
}
th, td{
  border:1px solid var(--border); padding:10px 12px; text-align:center;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  font-size:.95rem;
}
th{ background: var(--thead); color: var(--theadText); font-weight:800; position: sticky; top:0; z-index:1; }
td.player-name{ color: var(--link); text-decoration: underline; cursor:pointer; }

p.no-data{ text-align:center; color:#8892a6; margin:18px 0; }

input[type="text"], select{ width:100%; padding:10px; border-radius:10px; border:1.5px solid var(--border); background:var(--card); color:var(--text); }

/* ì†Œì œëª© & í–‰ */
.subhead{ font-weight:900; color:var(--brand); margin:6px 0 8px; }
.row{ display:grid; grid-template-columns: repeat(3, minmax(140px,1fr)); gap:10px; }
.row-2{ display:grid; grid-template-columns: repeat(2, minmax(140px,1fr)); gap:10px; }
.tools{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px; }
.badge{ display:inline-block; padding:5px 10px; border-radius:999px; border:1px solid var(--border); background: var(--thead); color: var(--theadText); font-weight:800; }

/* ===================== ìŠ¤ì½”ì–´ë³´ë“œ ===================== */
#scoreboard{
  position:relative; width:100%; max-width:1100px;
  height: clamp(140px, 24vw, 180px);
  margin: 0 auto 16px; border-radius:18px; overflow:hidden;
  background: radial-gradient(120% 100% at 0% 0%, var(--sb-bg2), var(--sb-bg1));
  box-shadow: 0 0 0 1px rgba(255,255,255,.06), inset 0 0 24px rgba(255,255,255,.08), 0 12px 28px rgba(0,0,0,.22);
  display:flex; align-items:center; justify-content:center;
}
#sb-inner{
  display:flex; align-items:center; gap:14px;
  color:#eaf2ff; font-weight:1000; letter-spacing:.02em;
  padding: 16px 22px; border-radius:14px;
  background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
  box-shadow: inset 0 0 0 1px var(--sb-line), 0 10px 22px rgba(0,0,0,.18);
  font-size: clamp(24px, 5.2vw, 40px);
}
#sb-date{ font-size: clamp(12px, 2.8vw, 15px); font-weight:800; opacity:.8; margin-right:8px; white-space:nowrap; }
#sb-away{ color:var(--sb-blue); text-shadow:0 0 6px rgba(90,160,255,.35); }
#sb-home{ color:var(--sb-red);  text-shadow:0 0 6px rgba(255,107,107,.35); }
.sb-badge{ background:rgba(255,255,255,.1); padding:2px 12px; border-radius:999px; font-size: .85em; font-variant-numeric: tabular-nums; }
.sb-sep{ opacity:.6; font-weight:900; }

/* ===================== MVP ë°°ë„ˆ ===================== */
#mvpBanner{
  position:relative; width:100%; max-width:1100px; height:190px;
  margin: 0 auto 20px; border-radius:16px; overflow:hidden;
  background: linear-gradient(135deg, #0066FF 0 50%, #FF0033 50% 100%);
  box-shadow: 0 0 0 1px rgba(212,175,55,.55), inset 0 0 24px rgba(255,255,255,.18), 0 10px 28px rgba(0,0,0,.18);
  display:flex; align-items:center; justify-content:center;
}
#mvpBanner::before{
  content:""; position:absolute; inset:0;
  background:
    linear-gradient(45deg, rgba(255,255,255,.22) 1px, transparent 1px),
    linear-gradient(-45deg, rgba(255,255,255,.22) 1px, transparent 1px);
  background-size:22px 22px; mix-blend-mode:overlay; opacity:.22; pointer-events:none;
}
#mvpBanner::after{
  content:""; position:absolute; inset:0;
  background: linear-gradient(135deg, transparent 49.2%, rgba(255,215,120,.9) 50%, transparent 50.8%);
  pointer-events:none;
}
.mvp-core{ position:relative; z-index:2; text-align:center; padding:18px; }
#mvpMain{
  font-weight:1000; font-size:clamp(42px, 8vw, 92px); line-height:.95; letter-spacing:.01em;
  color:transparent; background:linear-gradient(180deg, var(--mvp-gold1) 0%, var(--mvp-gold2) 52%, var(--mvp-gold3) 100%);
  -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
  text-shadow:0 0 6px rgba(212,175,55,.35), 0 0 12px rgba(212,175,55,.25);
  animation:mvpPulse 2.2s ease-in-out infinite;
}
@keyframes mvpPulse{ 0%,100%{transform:scale(1)} 50%{transform:scale(1.06)} }
#mvpSub{ margin-top:8px; font-weight:800; font-size:.95rem; color:#fff; text-shadow:0 2px 4px rgba(0,0,0,.35); }

/* ===================== ëª¨ë°”ì¼ ë³´ê¸° ===================== */
body.compact .container{ flex-wrap: wrap; }
body.compact nav.menu{ width:100%; order:1; }
body.compact section.content{ order:2; width:100%; }
body.compact nav.menu ul{ display:flex; gap:6px; flex-wrap:wrap; padding:8px; }
body.compact nav.menu li{ flex: 1 0 auto; padding:8px; text-align:center; }
body.compact .row, body.compact .row-2{ grid-template-columns: 1fr; }

@media (max-width: 680px){
  body{ max-width:100%; margin: 0; padding: 12px 8px; }
  .container{ flex-wrap: wrap; gap:12px; }
  nav.menu{ width:100%; }
  section.content{ width:100%; }
  .btn{ padding:7px 10px; }
  th, td{ padding:8px 10px; }
}
footer{ margin-top:20px; opacity:.65; font-size:.9rem; }
  </style>
</head>
<body>
  <h1>ì„ ìˆ˜ ê¸°ë¡ ì¡°íšŒ ë° ë¶„ì•¼ë³„ ìˆœìœ„</h1>

  <div class="top-actions">
    <button id="themeToggle" class="btn" aria-label="Toggle Dark Mode">ğŸŒ™ ë‹¤í¬ ëª¨ë“œ</button>
    <button id="mobileToggle" class="btn" aria-label="Toggle Mobile Layout">ğŸ“± ëª¨ë°”ì¼ ë³´ê¸°</button>
    <button id="goToInputBtn" class="btn primary">ê¸°ë¡ ì…ë ¥ í˜ì´ì§€ë¡œ ì´ë™</button>
  </div>

  <!-- ===== SCOREBOARD ===== -->
  <div id="scoreboard">
    <div id="sb-inner">
      <span id="sb-date" class="sb-date"></span>
      <span id="sb-away" class="sb-team"></span>
      <span id="sb-away-score" class="sb-badge"></span>
      <span class="sb-sep">/</span>
      <span id="sb-home" class="sb-team"></span>
      <span id="sb-home-score" class="sb-badge"></span>
    </div>
  </div>

  <!-- ===== MVP ë°°ë„ˆ ===== -->
  <div id="mvpBanner">
    <div class="mvp-core">
      <div id="mvpMain">MVP: í•œê²°</div>
      <div id="mvpSub">CSIA Â· íƒ€ì</div>
    </div>
  </div>

  <input type="text" id="searchInput" placeholder="ì„ ìˆ˜ ì´ë¦„ ê²€ìƒ‰" autocomplete="off" />

  <div class="container">
    <nav class="menu">
      <h2>íƒ€ì ë¶„ì•¼</h2>
      <ul id="hitterMenu">
        <li data-stat="íƒ€ìœ¨">íƒ€ìœ¨</li>
        <li data-stat="í™ˆëŸ°">í™ˆëŸ°</li>
        <li data-stat="ì¶œë£¨ìœ¨">ì¶œë£¨ìœ¨</li>
        <li data-stat="OPS">OPS</li>
        <li data-stat="íƒ€ì ">íƒ€ì </li>
        <li data-stat="WAR">WAR</li>
      </ul>
      <h2>íˆ¬ìˆ˜ ë¶„ì•¼</h2>
      <ul id="pitcherMenu">
        <li data-stat="ìŠ¹ë¦¬">ìŠ¹ë¦¬</li>
        <li data-stat="ì„¸ì´ë¸Œ">ì„¸ì´ë¸Œ</li>
        <li data-stat="í™€ë“œ">í™€ë“œ</li>
        <li data-stat="ì‚¼ì§„">ì‚¼ì§„</li>
        <li data-stat="ERA">ERA</li>
        <li data-stat="WHIP">WHIP</li>
      </ul>

      <h2>ëŒ€ê²°/ê²½ê¸°</h2>
      <ul id="extraMenu">
        <li data-view="h2h">ëŒ€ê²° ê²€ìƒ‰</li>
        <li data-view="games">ê²½ê¸° ê¸°ë¡</li>
      </ul>
    </nav>

    <section class="content" id="rankingContent">
      <p class="no-data">ë¶„ì•¼ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
    </section>
  </div>

  <!-- ===== H2H ===== -->
  <section class="content" id="h2hSection" style="display:none; margin-top:16px;">
    <div class="subhead">íˆ¬ìˆ˜â€“íƒ€ì ë§ëŒ€ê²° ê²€ìƒ‰</div>
    <div class="row-2">
      <div>
        <label>íˆ¬ìˆ˜ ì„ íƒ</label>
        <input list="dlPitchers" id="h2hPitcher" placeholder="íˆ¬ìˆ˜ ì´ë¦„ ì…ë ¥ ë˜ëŠ” ì„ íƒ" />
      </div>
      <div>
        <label>íƒ€ì ì„ íƒ</label>
        <input list="dlHitters" id="h2hHitter" placeholder="íƒ€ì ì´ë¦„ ì…ë ¥ ë˜ëŠ” ì„ íƒ" />
      </div>
    </div>
    <datalist id="dlPitchers"></datalist>
    <datalist id="dlHitters"></datalist>

    <div class="row-2" style="margin-top:8px;">
      <div>
        <label>ê²½ê¸° ì„ íƒ(ì„ íƒ ì‚¬í•­)</label>
        <select id="h2hGameSelect"><option value="">ì „ì²´ ê²½ê¸°</option></select>
      </div>
      <div>
        <label>ì •ë ¬</label>
        <select id="h2hSort">
          <option value="time_desc">ìµœì‹ ìˆœ</option>
          <option value="time_asc">ì˜¤ë˜ëœìˆœ</option>
          <option value="inning">ì´ë‹ìˆœ</option>
        </select>
      </div>
    </div>

    <div class="tools">
      <button class="btn primary" id="h2hSearchBtn">ëŒ€ê²° ê²€ìƒ‰</button>
      <span class="badge" id="h2hSummary">ê²€ìƒ‰ ëŒ€ê¸°ì¤‘</span>
    </div>

    <div id="h2hResultWrap" style="margin-top:10px;">
      <table class="table" id="h2hTable">
        <thead>
          <tr>
            <th>#</th><th>ì‹œê°</th><th>ê²½ê¸°</th><th>ì´ë‹</th><th>ê³µê²©íŒ€</th>
            <th>íƒ€ì</th><th>íˆ¬ìˆ˜</th><th>ê²°ê³¼ ìš”ì•½</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:10px;">
        <div class="subhead">ìš”ì•½(í˜„ì¬ ê²°ê³¼ì§‘í•©)</div>
        <table class="table" id="h2hAggTable">
          <thead>
            <tr>
              <th>íƒ€ì„</th><th>ì•ˆíƒ€</th><th>2B</th><th>3B</th><th>HR</th><th>BB</th><th>SO</th>
              <th>RBI</th><th>R</th><th>AVG</th><th>OBP</th><th>SLG</th><th>OPS</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ===== ê²½ê¸° ê¸°ë¡ ===== -->
  <section class="content" id="gamesSection" style="display:none; margin-top:16px;">
    <div class="subhead">ê²½ê¸° ê¸°ë¡ ë³´ê¸°</div>
    <div class="row">
      <div>
        <label>ê²½ê¸° ì„ íƒ</label>
        <select id="gameSelect"><option value="">(ì„ íƒ)</option></select>
      </div>
      <div>
        <label>íŒ€ í•„í„°(ì„ íƒ)</label>
        <select id="gameTeamFilter">
          <option value="">ì „ì²´</option>
          <option value="Leaders">Leaders</option>
          <option value="CSIA">CSIA</option>
        </select>
      </div>
      <div>
        <label>ì •ë ¬</label>
        <select id="gameSort">
          <option value="inning">ì´ë‹ìˆœ</option>
          <option value="time_desc">ìµœì‹ ìˆœ</option>
          <option value="time_asc">ì˜¤ë˜ëœìˆœ</option>
        </select>
      </div>
    </div>

    <div class="tools">
      <button class="btn primary" id="gameLoadBtn">ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <span class="badge" id="gameSummary">ì„ íƒ ëŒ€ê¸°ì¤‘</span>
    </div>

    <table class="table" id="gameTable" style="margin-top:10px;">
      <thead>
        <tr>
          <th>#</th><th>ì‹œê°</th><th>ì´ë‹</th><th>ê³µê²©íŒ€</th><th>íƒ€ì</th><th>íˆ¬ìˆ˜</th><th>ê²°ê³¼ ìš”ì•½</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="gameNoData" class="no-data" style="display:none;">í•´ë‹¹ ê²½ê¸°ì˜ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
  </section>

  <div id="mvpRankingSection" style="display:none; margin-top:16px;">
    <h3>MVP ìˆœìœ„</h3>
    <table id="mvpRankingTable" class="table">
      <thead>
        <tr><th>ìˆœìœ„</th><th>ì„ ìˆ˜ëª…</th><th>íŒ€</th><th>MVP íšŸìˆ˜</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="teamStatsSection" style="display:none; margin-top:16px;">
    <h3>íŒ€ë³„ ì£¼ìš” í†µê³„</h3>
    <table id="teamStatsTable" class="table">
      <thead>
        <tr><th>íŒ€ëª…</th><th>íŒ€ íƒ€ìœ¨</th><th>íŒ€ ìì±…ì </th><th>íŒ€ ë“ì </th><th>íŒ€ íƒ€ì </th><th>íŒ€ ìŠ¹ë¥ </th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <footer>ì‚¬ì´íŠ¸ ì•„ì´ë””ì–´ ê¸°íš ë° ê°œë°œ: ì´ì›ì¤€</footer>

<script>
/* ======================= í™˜ê²½ì„¤ì • ======================= */
const SCOREBOARD = {
  date: '2025-09-05',
  awayTeam: 'CSIA',
  awayScore: 2,
  homeTeam: 'Leaders',
  homeScore: 2
};
const PLAYER_JSON_URL = "https://alex4u-jun.github.io/bs_record/players.json";

/* ë‘ ê°œì˜ gamerecordë¥¼ í•©ì³ì„œ ì‚¬ìš© */
const GAMERECORD_JSON_URLS = [
  "https://alex4u-jun.github.io/bs_record/gamerecord_1.json",
  "https://alex4u-jun.github.io/bs_record/gamerecord_2.json",
];

/* ======================= ìê²©ìš”ê±´(ê·œì •) ì„¤ì • ======================= */
const QUALIFIER = {
  hitter: { mode: 'percentile', percentile: 0.70, floor: 0 },
  pitcher: { mode: 'none' }
};

/* ======================= ì „ì—­ ìºì‹œ ======================= */
let __allPlayersCache = null;
let __hitterPercentileCutoffPA = 0;

/* ======================= ë°ì´í„° ë¡œë” ======================= */
async function loadPlayersFromJson(){
  try{
    const res = await fetch(PLAYER_JSON_URL, {cache:'no-store'});
    if(!res.ok) throw new Error('players fetch fail');
    return await res.json();
  }catch(e){ console.error(e); return []; }
}
async function loadGameRecordJsonMerged(){
  try{
    const fetched = await Promise.allSettled(
      GAMERECORD_JSON_URLS.map(u=>fetch(u, {cache:'no-store'}))
    );
    const jsons = [];
    for(const fr of fetched){
      if(fr.status==='fulfilled' && fr.value.ok){
        jsons.push(await fr.value.json());
      }
    }
    const out = {version:"merged", games:[], events:[]};
    const gset = new Set(), eset = new Set();
    jsons.forEach(j=>{
      (j.games||[]).forEach(g=>{
        const id = g.gameId ?? g.id;
        if(!gset.has(id)){
          gset.add(id);
          out.games.push(g);
        }
      });
      (j.events||[]).forEach(e=>{
        const id=e.id || `${e.gameId}_${e.inning}_${e.half}_${e.hitterName}_${e.pitcherName}_${e.createdAt||e.updatedAt||e.ts||''}`;
        if(!eset.has(id)){ eset.add(id); out.events.push(e); }
      });
    });
    return out;
  }catch(e){ console.error(e); return {version:"0", games:[], events:[]}; }
}

/* ======================= ë³´ì¡° ìœ í‹¸ ======================= */
function isAscPreferred(stat){ return ['ERA','WHIP'].includes(stat); }
function filterByName(players, keyword){
  if(!keyword) return players;
  const lower = keyword.toLowerCase();
  return players.filter(p=>p.name.toLowerCase().includes(lower));
}
function fmtTs(ts){
  if(!ts) return '';
  const d = new Date(ts); if(isNaN(d)) return ts;
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const mi = String(d.getMinutes()).padStart(2,'0');
  return `${d.getFullYear()}-${mm}-${dd} ${hh}:${mi}`;
}
function outcomeToText(o){
  if(!o) return '';
  const arr=[];
  if(o.hitterEvent||o.hitterEvt) arr.push(o.hitterEvent||o.hitterEvt);
  if(o.rbiDelta||o.rbi) arr.push(`RBI+${o.rbiDelta||o.rbi}`);
  if(o.runScoredDelta||o.run) arr.push(`R+${o.runScoredDelta||o.run}`);
  if(o.pitcherEvent||o.pitcherEvt) arr.push(`P:${o.pitcherEvent||o.pitcherEvt}`);
  if(o.pitcherDecision) arr.push(o.pitcherDecision);
  if(o.pitchCountDelta||o.pitchCount) arr.push(`PC+${o.pitchCountDelta||o.pitchCount}`);
  if(o.inningsDelta) arr.push(`IP+${o.inningsDelta}`);
  if(o.earnedRunsDelta||o.er) arr.push(`ER+${o.earnedRunsDelta||o.er}`);
  return arr.join(' Â· ');
}

/* ===== íƒ€ì/íˆ¬ìˆ˜ ì§€í‘œ ê³„ì‚° ===== */
function calculateAB(p){
  const H   = (p.stats['1ë£¨íƒ€']||0)+(p.stats['2ë£¨íƒ€']||0)+(p.stats['3ë£¨íƒ€']||0)+(p.stats['í™ˆëŸ°']||0);
  const OUT = (p.stats['ì‚¼ì§„']||0) + (p.stats['ë‚´ì•¼ë•…ë³¼']||0) + (p.stats['í”Œë¼ì´ì•„ì›ƒ']||0);
  const ROE = (p.stats['ìˆ˜ë¹„ ì‹¤ì±…']||0);
  return H + OUT + ROE;
}
function playerPA(p){
  if (p.PA != null && Number.isFinite(+p.PA)) return +p.PA;
  const AB = calculateAB(p);
  const BB = p.stats['ë³¼ë„·']||0;
  const SF = p.stats['í¬ìƒí”Œë¼ì´']||0;
  return AB + BB + SF;
}
function calculateAVG(p){
  const H = (p.stats['1ë£¨íƒ€']||0)+(p.stats['2ë£¨íƒ€']||0)+(p.stats['3ë£¨íƒ€']||0)+(p.stats['í™ˆëŸ°']||0);
  const AB = calculateAB(p); return AB? H/AB : 0;
}
function calculateOBP(p){
  const H = (p.stats['1ë£¨íƒ€']||0)+(p.stats['2ë£¨íƒ€']||0)+(p.stats['3ë£¨íƒ€']||0)+(p.stats['í™ˆëŸ°']||0);
  const BB = p.stats['ë³¼ë„·']||0, HBP=0;
  const AB = calculateAB(p), SF = p.stats['í¬ìƒí”Œë¼ì´']||0;
  const den = AB + BB + SF + HBP; return den? (H+BB+HBP)/den : 0;
}
function calculateSLG(p){
  const s=p.stats||{}, singles=(s['1ë£¨íƒ€']||0), doubles=(s['2ë£¨íƒ€']||0), triples=(s['3ë£¨íƒ€']||0), hr=(s['í™ˆëŸ°']||0);
  const AB = calculateAB(p), TB = singles + doubles*2 + triples*3 + hr*4;
  return AB? TB/AB : 0;
}
function calculateOPS(p){ return calculateOBP(p)+calculateSLG(p); }
function calculateERA(p){ const ER=p.stats['ìì±…ì ']||0, IP=p.stats['ì´ë‹']||0; return IP? (ER*9)/IP : 0; }
function calculateWHIP(p){ const BB=p.stats['ë³¼ë„·']||0, H=p.stats['í”¼ì•ˆíƒ€']||0, IP=p.stats['ì´ë‹']||0; return IP? (BB+H)/IP : 0; }

/* ê°„ë‹¨ WAR */
const WAR_WEIGHTS = { single:0.90, double:1.25, triple:1.60, hr:2.00, bb:0.70 };
const WOBASCALE = 1.15, RUNS_PER_WIN = 10, REPLACEMENT_PER_600PA = 20;
function wobaNumeratorFromStats(p){
  const s=p.stats||{};
  return (s['1ë£¨íƒ€']||0)*WAR_WEIGHTS.single + (s['2ë£¨íƒ€']||0)*WAR_WEIGHTS.double +
         (s['3ë£¨íƒ€']||0)*WAR_WEIGHTS.triple + (s['í™ˆëŸ°']||0)*WAR_WEIGHTS.hr + (s['ë³¼ë„·']||0)*WAR_WEIGHTS.bb;
}
function computeLeagueWoba(hitters){
  let num=0, den=0; hitters.forEach(h=>{ num+=wobaNumeratorFromStats(h); den+=playerPA(h); });
  return den? num/den : 0;
}
function buildWarMap(hittersAll){
  const league = computeLeagueWoba(hittersAll); const map={};
  hittersAll.forEach(p=>{
    const PA=playerPA(p); if(!PA){ map[p.name]=0; return; }
    const woba = wobaNumeratorFromStats(p)/PA;
    const wRAA = (woba - league)/WOBASCALE * PA;
    const rep = REPLACEMENT_PER_600PA*(PA/600);
    map[p.name] = (wRAA + rep)/RUNS_PER_WIN;
  });
  return map;
}
function getStatValue(p, stat){
  switch(stat){
    case 'íƒ€ìœ¨': return calculateAVG(p);
    case 'ì¶œë£¨ìœ¨': return calculateOBP(p);
    case 'OPS': return calculateOPS(p);
    case 'í™ˆëŸ°': case 'íƒ€ì ': case 'ìŠ¹ë¦¬': case 'ì„¸ì´ë¸Œ': case 'í™€ë“œ': case 'ì‚¼ì§„': return p.stats[stat]||0;
    case 'ERA': return calculateERA(p);
    case 'WHIP': return calculateWHIP(p);
    case 'WAR': return p.__war||0;
    default: return 0;
  }
}
function getStatDisplay(p, stat){
  const v = getStatValue(p, stat);
  if(['íƒ€ìœ¨','ì¶œë£¨ìœ¨','OPS','WHIP'].includes(stat)) return v.toFixed(3);
  if(stat==='ERA') return v.toFixed(2);
  if(stat==='WAR') return v.toFixed(1);
  return v;
}
function getMedalIcon(i){ return i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':''; }

/* ======================= í¼ì„¼íƒ€ì¼ ê·œì • ê³„ì‚° ======================= */
function computePercentileCutoffPA(allPlayers, pct=QUALIFIER.hitter.percentile, floor=QUALIFIER.hitter.floor){
  const paList = allPlayers
    .filter(p=>p.type==='íƒ€ì')
    .map(playerPA)
    .filter(x=>Number.isFinite(x) && x>=0)
  .sort((a,b)=>a-b);

  if (paList.length === 0) return floor||0;
  const q = 1 - (pct ?? 0.7);
  const idx = Math.floor((paList.length-1) * q);
  const cutoff = paList[idx];
  return Math.max(cutoff, floor||0);
}

/* ======================= ê·œì • ì ìš© ======================= */
function applyQualifiersSplit(list, stat){
  const isH = ['íƒ€ìœ¨','í™ˆëŸ°','ì¶œë£¨ìœ¨','OPS','íƒ€ì ','WAR'].includes(stat);
  const qualified = [], nonQualified = [];
  list.forEach(p=>{
    if(isH){
      const need = __hitterPercentileCutoffPA || 0;
      const have = playerPA(p);
      (have >= need ? qualified : nonQualified).push({...p, __need:need, __have:have});
    }else{
      const have = (p.stats['ì´ë‹']||0);
      qualified.push({...p, __need:null, __have:have});
    }
  });
  return {qualified, nonQualified};
}

/* ======================= ë­í‚¹ ë Œë” ======================= */
function createRankingTable(players, stat, nonQualifiers){
  const table=document.createElement('table'); table.className='table';
  const thead=document.createElement('thead'); const tbody=document.createElement('tbody');
  const hr=document.createElement('tr');
  ['ìˆœìœ„','ì„ ìˆ˜ëª…',stat].forEach((t,i)=>{
    const th=document.createElement('th'); th.textContent=t;
    if(i===2){
      th.style.cursor='pointer';
      th.addEventListener('click',()=>{ currentSort.asc=!currentSort.asc; renderRanking(stat, currentSort.asc); });
      th.textContent += currentSort.asc?' â–²':' â–¼';
      th.title='í—¤ë” í´ë¦­ìœ¼ë¡œ ì •ë ¬ ì „í™˜';
    }
    hr.appendChild(th);
  });
  thead.appendChild(hr);

  players.forEach((p,i)=>{
    const unit = ['íƒ€ìœ¨','í™ˆëŸ°','ì¶œë£¨ìœ¨','OPS','íƒ€ì ','WAR'].includes(stat) ? 'PA' : 'IP';
    const tipNeed = (p.__need==null) ? '' : `í•„ìš” ${p.__need} ${unit} / `;
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${getMedalIcon(i)}${i+1}</td>
                    <td class="player-name" title="${tipNeed}ë³´ìœ  ${p.__have||0}">
                      ${p.name}
                    </td>
                    <td>${getStatDisplay(p,stat)}</td>`;
    tr.querySelector('.player-name').onclick = ()=>{ location.href = `player_detail.html?name=${encodeURIComponent(p.name)}&type=${encodeURIComponent(p.type)}`; };
    tbody.appendChild(tr);
  });

  if(nonQualifiers && nonQualifiers.length){
    const sep=document.createElement('tr');
    sep.innerHTML=`<td colspan="3" style="border-top:3px solid #c43; text-align:center; font-weight:800;">ê·œì • ë¯¸ë‹¬</td>`;
    tbody.appendChild(sep);
    nonQualifiers.forEach(p=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>â€“</td>
                      <td class="player-name" title="í•„ìš” ${p.__need||0} PA / ë³´ìœ  ${p.__have||0}">
                        ${p.name}
                      </td>
                      <td>${getStatDisplay(p,stat)}</td>`;
      tr.querySelector('.player-name').onclick = ()=>{ location.href = `player_detail.html?name=${encodeURIComponent(p.name)}&type=${encodeURIComponent(p.type)}`; };
      tbody.appendChild(tr);
    });
  }

  table.appendChild(thead); table.appendChild(tbody); return table;
}
function hitterTieBreakerDesc(a,b,stat){
  const va=getStatValue(a,stat), vb=getStatValue(b,stat);
  if(vb!==va) return vb-va;
  return playerPA(b) - playerPA(a);
}
function pitcherTieBreakerDesc(a,b,stat){
  const va=getStatValue(a,stat), vb=getStatValue(b,stat);
  if(vb!==va) return vb-va;
  return (b.stats['ì´ë‹']||0) - (a.stats['ì´ë‹']||0);
}
async function renderRanking(stat, asc=true){
  rankingContent.innerHTML='';
  const all = __allPlayersCache || await loadPlayersFromJson();
  const isH = ['íƒ€ìœ¨','í™ˆëŸ°','ì¶œë£¨ìœ¨','OPS','íƒ€ì ','WAR'].includes(stat);
  let list = all.filter(p=> isH ? p.type==='íƒ€ì' : p.type==='íˆ¬ìˆ˜');
  if(stat==='WAR'){ const map=buildWarMap(all.filter(p=>p.type==='íƒ€ì')); list.forEach(p=>p.__war=map[p.name]||0); }
  list = filterByName(list, (searchInput.value||'').trim());

  if(asc){ list.sort((a,b)=>getStatValue(a,stat)-getStatValue(b,stat)); }
  else{ if(isH) list.sort((a,b)=>hitterTieBreakerDesc(a,b,stat)); else list.sort((a,b)=>pitcherTieBreakerDesc(a,b,stat)); }

  const {qualified, nonQualified} = applyQualifiersSplit(list, stat);
  rankingContent.appendChild(createRankingTable(qualified, stat, nonQualified));
}

/* ======================= MVP/íŒ€ í†µê³„ ======================= */
const mvpMain = document.getElementById('mvpMain');
const mvpSub  = document.getElementById('mvpSub');
const mvpRankingSection = document.getElementById('mvpRankingSection');
const mvpRankingTableBody = document.querySelector('#mvpRankingTable tbody');
const teamStatsSection = document.getElementById('teamStatsSection');
const teamStatsTableBody = document.querySelector('#teamStatsTable tbody');

function loadRecentMvp(){
  const raw=localStorage.getItem('lastMvp');
  if(raw){
    try{
      const m=JSON.parse(raw);
      mvpMain.textContent = `MVP: ${m.name}`;
      mvpSub.textContent  = `${m.team} Â· ${m.type}`;
      return;
    }catch(_){}
  }
  mvpMain.textContent = 'MVP: í•œê²°';
  mvpSub.textContent  = 'CSIA Â· íƒ€ì';
}
async function renderMvpRanking(){
  const players=(__allPlayersCache || await loadPlayersFromJson()).filter(p=>p.mvpCount>0);
  if(!players.length){ mvpRankingSection.style.display='none'; return; }
  mvpRankingSection.style.display='block';
  const map={};
  players.forEach(p=>{
    if(!map[p.name]) map[p.name]={...p, teams:[p.team], types:[p.type]};
    else{ map[p.name].mvpCount+=p.mvpCount; if(!map[p.name].teams.includes(p.team)) map[p.name].teams.push(p.team); }
  });
  const list=Object.values(map).sort((a,b)=>b.mvpCount-a.mvpCount);
  mvpRankingTableBody.innerHTML='';
  list.forEach((p,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td class="player-name">${p.name}</td><td>${p.teams.join(', ')}</td><td>${p.mvpCount}</td>`;
    tr.querySelector('.player-name').onclick=()=>{ location.href=`player_detail.html?name=${encodeURIComponent(p.name)}&type=${encodeURIComponent(p.types[0])}`; };
    mvpRankingTableBody.appendChild(tr);
  });
}
async function calculateTeamStats(){
  const players=__allPlayersCache || await loadPlayersFromJson(); const teams={};
  players.forEach(p=>{
    const t = teams[p.team] ||= { totalHits:0, totalAtBats:0, totalER:0, totalInnings:0, totalRBI:0, W:0, L:0 };
    if(p.type==='íƒ€ì'){
      const H=(p.stats['1ë£¨íƒ€']||0)+(p.stats['2ë£¨íƒ€']||0)+(p.stats['3ë£¨íƒ€']||0)+(p.stats['í™ˆëŸ°']||0);
      const AB=calculateAB(p); t.totalHits+=H; t.totalAtBats+=AB; t.totalRBI+=(p.stats['íƒ€ì ']||0);
    }else{
      t.totalER+=(p.stats['ìì±…ì ']||0); t.totalInnings+=(p.stats['ì´ë‹']||0);
      t.W+=(p.stats['ìŠ¹ë¦¬']||0); t.L+=(p.stats['íŒ¨ë°°']||0);
    }
  });
  teamStatsTableBody.innerHTML='';
  Object.entries(teams).forEach(([team,t])=>{
    const avg = t.totalAtBats? t.totalHits/t.totalAtBats : 0;
    const era = t.totalInnings? (t.totalER*9/t.totalInnings) : 0;
    const winRate = (t.W+t.L)? t.W/(t.W+t.L) : 0;
    teamStatsTableBody.innerHTML += `<tr><td>${team}</td><td>${avg.toFixed(3)}</td><td>${era.toFixed(2)}</td><td>â€“</td><td>${t.totalRBI}</td><td>${(winRate*100).toFixed(1)}%</td></tr>`;
  });
  teamStatsSection.style.display='block';
}

/* ======================= gamerecord ì •ê·œí™” ======================= */
/* âœ… IDë¥¼ ë¬¸ìì—´ë¡œ í†µì¼(íƒ€ì… ë¶ˆì¼ì¹˜ ë°©ì§€) */
function normGame(g){
  if(!g) return null;
  const rawId = g.gameId ?? g.id;
  const idStr = (rawId==null) ? '' : String(rawId);
  return {
    id: idStr,
    date: g.date || '',
    awayTeam: g.awayTeam||g.away||g.visitor||'',
    homeTeam: g.homeTeam||g.home||''
  };
}
function normEvent(e){
  if(!e) return null;
  const rawGid = e.gameId ?? e.id ?? e.gid;
  const gidStr = (rawGid==null) ? '' : String(rawGid);
  return {
    gameId: gidStr,
    ts: e.ts||e.timestamp||e.createdAt||e.updatedAt||null,
    inning: Number.isFinite(+e.inning) ? +e.inning : e.inning,  // ìˆ«ì ìš°ì„ 
    half: e.half||e.topbottom||e.tb||'',
    offenseTeam: e.offenseTeam||e.offense||e.battingTeam||'',
    defenseTeam: e.defenseTeam||e.defense||e.fieldingTeam||'',
    hitterName: e.hitterName||e.batterName||e.hitter||e.batter||'',
    pitcherName: e.pitcherName||e.pitcher||'',
    hitterEvent: e.hitterEvent,
    rbiDelta: e.rbiDelta||e.rbi,
    runScoredDelta: e.runScoredDelta||e.run,
    pitcherEvent: e.pitcherEvent,
    pitcherDecision: e.pitcherDecision,
    pitchCountDelta: e.pitchCountDelta||e.pitchCount,
    inningsDelta: e.inningsDelta,
    earnedRunsDelta: e.earnedRunsDelta||e.er,
    outcome: e.outcome
  };
}

/* ======================= H2H ì¤€ë¹„/ê²€ìƒ‰ ======================= */
const h2hSection = document.getElementById('h2hSection');
const h2hPitcher = document.getElementById('h2hPitcher');
const h2hHitter = document.getElementById('h2hHitter');
const dlPitchers = document.getElementById('dlPitchers');
const dlHitters  = document.getElementById('dlHitters');
const h2hGameSelect = document.getElementById('h2hGameSelect');
const h2hSort = document.getElementById('h2hSort');
const h2hSearchBtn = document.getElementById('h2hSearchBtn');
const h2hSummary = document.getElementById('h2hSummary');
const h2hTableBody = document.querySelector('#h2hTable tbody');
const h2hAggBody = document.querySelector('#h2hAggTable tbody');

async function prepareH2HForm(){
  const players=__allPlayersCache || await loadPlayersFromJson();
  const pitchers=players.filter(p=>p.type==='íˆ¬ìˆ˜').map(p=>p.name);
  const hitters =players.filter(p=>p.type==='íƒ€ì').map(p=>p.name);
  dlPitchers.innerHTML = pitchers.map(n=>`<option value="${n}">`).join('');
  dlHitters.innerHTML  = hitters.map(n=>`<option value="${n}">`).join('');
  const gr=await loadGameRecordJsonMerged();
  const options=(gr.games||[]).map(normGame).filter(Boolean);
  h2hGameSelect.innerHTML = '<option value="">ì „ì²´ ê²½ê¸°</option>' + options
    .sort((a,b)=>(a.date||'').localeCompare(b.date||''))
    .map(g=>`<option value="${g.id}">${g.date||'(ë‚ ì§œì—†ìŒ)'} Â· ${g.awayTeam} @ ${g.homeTeam}</option>`)
    .join('');
}
function normalizeOutcomeForAgg(ev){
  const o = ev.outcome || { hitterEvent:ev.hitterEvent, rbi:ev.rbiDelta, run:ev.runScoredDelta, pitcherEvent:ev.pitcherEvent, pitcherDecision:ev.pitcherDecision, pitchCount:ev.pitchCountDelta, inningsDelta:ev.inningsDelta, er:ev.earnedRunsDelta };
  const tag=(o.hitterEvt||o.hitterEvent||'').trim();
  const r={h:0, bb:0, so:0, sf:0, out:0, rbi:(o.rbi||o.rbiDelta||0), run:(o.run||o.runScoredDelta||0)};
  if(tag==='1ë£¨íƒ€') r.h=1; else if(tag==='2ë£¨íƒ€') r.h=2; else if(tag==='3ë£¨íƒ€') r.h=3; else if(tag==='í™ˆëŸ°') r.h=4;
  else if(tag==='ë³¼ë„·') r.bb=1; else if(tag==='ì‚¼ì§„') r.so=1; else if(tag==='í¬ìƒí”Œë¼ì´') r.sf=1; else r.out=1;
  return r;
}
function calcAggFromEvents(events){
  let PA=0,H=0,_2B=0,_3B=0,HR=0,BB=0,SO=0,RBI=0,R=0,AB=0,TB=0,SF=0;
  events.forEach(e=>{
    const o=e._o; PA++;
    if(o.h===1){H++;AB++;TB+=1;} else if(o.h===2){H++;_2B++;AB++;TB+=2;}
    else if(o.h===3){H++;_3B++;AB++;TB+=3;} else if(o.h===4){H++;HR++;AB++;TB+=4;}
    else if(o.bb){BB++;} else if(o.so){SO++;AB++;} else if(o.out){AB++;}
    if(o.sf) SF++;
    RBI += (o.rbi||0); R += (o.run||0);
  });
  const AVG = AB? H/AB : 0;
  const OBPden = AB + BB + SF;
  const OBP = OBPden ? (H + BB)/OBPden : 0;
  const SLG = AB ? TB/AB : 0;
  const OPS = OBP + SLG;
  return {PA,H,_2B,_3B,HR,BB,SO,RBI,R,AVG,OBP,SLG,OPS};
}
h2hSearchBtn.addEventListener('click', async ()=>{
  const pitcher=h2hPitcher.value.trim();
  const hitter =h2hHitter.value.trim();
  if(!pitcher && !hitter) return alert('íˆ¬ìˆ˜ ë˜ëŠ” íƒ€ì ì¤‘ ìµœì†Œ í•œ ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');

  const gr = await loadGameRecordJsonMerged();
  const gamesMap={}; (gr.games||[]).map(normGame).forEach(g=>g && (gamesMap[g.id]=g));
  const gameFilter = h2hGameSelect.value || '';

  let evs = (gr.events||[]).map(normEvent).filter(Boolean).filter(e=>{
    const okPitch = pitcher ? (e.pitcherName===pitcher) : true;
    const okHitter = hitter ? (e.hitterName===hitter) : true;
    const okGame = gameFilter ? (String(e.gameId)===String(gameFilter)) : true; // âœ… íƒ€ì… í†µì¼ ë¹„êµ
    return okPitch && okHitter && okGame;
  });

  const sort=h2hSort.value;
  if(sort==='time_desc') evs.sort((a,b)=>(b.ts||0)-(a.ts||0));
  else if(sort==='time_asc') evs.sort((a,b)=>(a.ts||0)-(b.ts||0));
  else{
    const r=h=>h==='ì´ˆ'?0:1;
    evs.sort((a,b)=>(a.inning-b.inning)||(r(a.half)-r(b.half))||((a.ts||0)-(b.ts||0)));
  }

  h2hTableBody.innerHTML='';
  evs.forEach((e,i)=>{
    const g=gamesMap[e.gameId];
    const text=outcomeToText({hitterEvent:e.hitterEvent, rbi:e.rbiDelta, run:e.runScoredDelta, pitcherEvent:e.pitcherEvent, pitcherDecision:e.pitcherDecision, pitchCount:e.pitchCountDelta, inningsDelta:e.inningsDelta, er:e.earnedRunsDelta} || e.outcome);
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${fmtTs(e.ts)}</td><td>${g?`${g.date||''} Â· ${g.awayTeam} @ ${g.homeTeam}`:(e.gameId||'')}</td><td>${e.inning}íšŒ ${e.half||''}</td><td>${e.offenseTeam||''}</td><td>${e.hitterName||''}</td><td>${e.pitcherName||''}</td><td>${text}</td>`;
    h2hTableBody.appendChild(tr);
    e._o = normalizeOutcomeForAgg(e);
  });

  h2hSummary.textContent = `ì´ë²¤íŠ¸ ${evs.length}ê±´`;
  const agg=calcAggFromEvents(evs);
  h2hAggBody.innerHTML = `<tr><td>${agg.PA}</td><td>${(agg.H-agg._2B-agg._3B-agg.HR)}</td><td>${agg._2B}</td><td>${agg._3B}</td><td>${agg.HR}</td><td>${agg.BB}</td><td>${agg.SO}</td><td>${agg.RBI}</td><td>${agg.R}</td><td>${agg.AVG.toFixed(3)}</td><td>${agg.OBP.toFixed(3)}</td><td>${agg.SLG.toFixed(3)}</td><td>${agg.OPS.toFixed(3)}</td></tr>`;
});
[h2hSort,h2hGameSelect].forEach(el=>el.addEventListener('change',()=>h2hSearchBtn.click()));
[h2hPitcher,h2hHitter].forEach(el=>el.addEventListener('keydown',e=>{ if(e.key==='Enter') h2hSearchBtn.click(); }));

/* ======================= ê²½ê¸° ê¸°ë¡ ======================= */
const gamesSection = document.getElementById('gamesSection');
const gameSelect = document.getElementById('gameSelect');
const gameTeamFilter = document.getElementById('gameTeamFilter');
const gameSort = document.getElementById('gameSort');
const gameLoadBtn = document.getElementById('gameLoadBtn');
const gameSummary = document.getElementById('gameSummary');
const gameTableBody = document.querySelector('#gameTable tbody');
const gameNoData = document.getElementById('gameNoData');

async function prepareGameList(){
  const gr=await loadGameRecordJsonMerged();
  const list=(gr.games||[]).map(normGame).filter(g=>g && g.id);
  list.sort((a,b)=>(a.date||'').localeCompare(b.date||''));
  gameSelect.innerHTML = '<option value="">(ì„ íƒ)</option>'+list.map(g=>`<option value="${g.id}">${g.date||'(ë‚ ì§œì—†ìŒ)'} Â· ${g.awayTeam} @ ${g.homeTeam}</option>`).join('');
}
function sortEvents(evs, mode){
  if(mode==='time_desc') evs.sort((a,b)=>(b.ts||0)-(a.ts||0));
  else if(mode==='time_asc') evs.sort((a,b)=>(a.ts||0)-(b.ts||0));
  else{
    const rank=h=>h==='ì´ˆ'?0:1;
    evs.sort((a,b)=>(a.inning-b.inning)||(rank(a.half)-rank(b.half))||((a.ts||0)-(b.ts||0)));
  }
  return evs;
}
gameLoadBtn.addEventListener('click', async ()=>{
  const id=gameSelect.value;
  if(!id) return alert('ê²½ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
  const gr=await loadGameRecordJsonMerged();

  // âœ… íƒ€ì… í†µì¼ ë¹„êµ (ë¬¸ìì—´)
  let evs=(gr.events||[]).map(normEvent).filter(e=>e && String(e.gameId)===String(id));

  const team = gameTeamFilter.value;
  if(team) evs = evs.filter(e=> e.offenseTeam===team || e.defenseTeam===team);

  sortEvents(evs, gameSort.value);

  gameTableBody.innerHTML='';
  evs.forEach((e,i)=>{
    const text=outcomeToText({hitterEvent:e.hitterEvent, rbi:e.rbiDelta, run:e.runScoredDelta, pitcherEvent:e.pitcherEvent, pitcherDecision:e.pitcherDecision, pitchCount:e.pitchCountDelta, inningsDelta:e.inningsDelta, er:e.earnedRunsDelta} || e.outcome);
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${fmtTs(e.ts)}</td><td>${e.inning}íšŒ ${e.half||''}</td><td>${e.offenseTeam||''}</td><td>${e.hitterName||''}</td><td>${e.pitcherName||''}</td><td>${text}</td>`;
    gameTableBody.appendChild(tr);
  });

  gameSummary.textContent = `ì´ë²¤íŠ¸ ${evs.length}ê±´`;
  gameNoData.style.display = evs.length ? 'none' : 'block';
});
[gameTeamFilter, gameSort].forEach(el=>el.addEventListener('change', ()=>{ if(gameSelect.value) gameLoadBtn.click(); }));

/* ======================= ë©”ë‰´/ê²€ìƒ‰ ======================= */
const rankingContent = document.getElementById('rankingContent');
const hitterMenu = document.getElementById('hitterMenu');
const pitcherMenu = document.getElementById('pitcherMenu');
const extraMenu = document.getElementById('extraMenu');
const searchInput = document.getElementById('searchInput');

const goToInputBtn = document.getElementById('goToInputBtn');
const themeToggle = document.getElementById('themeToggle');
const mobileToggle = document.getElementById('mobileToggle');

const hitterStatsForRanking = ['íƒ€ìœ¨', 'í™ˆëŸ°', 'ì¶œë£¨ìœ¨', 'OPS', 'íƒ€ì ', 'WAR'];
const pitcherStatsForRanking = ['ìŠ¹ë¦¬', 'ì„¸ì´ë¸Œ', 'í™€ë“œ', 'ì‚¼ì§„', 'ERA', 'WHIP'];
let currentSort = { column: null, asc: true };

(function(){
  const root = document.documentElement;
  const saved = localStorage.getItem('theme');
  if(saved){ root.setAttribute('data-theme', saved); themeToggle.textContent = saved==='dark'?'â˜€ï¸ ë¼ì´íŠ¸ ëª¨ë“œ':'ğŸŒ™ ë‹¤í¬ ëª¨ë“œ'; }
  themeToggle.addEventListener('click', ()=>{
    const isDark = root.getAttribute('data-theme') === 'dark';
    const next = isDark ? '' : 'dark';
    if(next) root.setAttribute('data-theme', next); else root.removeAttribute('data-theme');
    localStorage.setItem('theme', next||'');
    themeToggle.textContent = next==='dark'?'â˜€ï¸ ë¼ì´íŠ¸ ëª¨ë“œ':'ğŸŒ™ ë‹¤í¬ ëª¨ë“œ';
  });

  const savedCompact = localStorage.getItem('record_mobile');
  if(savedCompact === '1') document.body.classList.add('compact');
  mobileToggle.textContent = document.body.classList.contains('compact') ? 'ğŸ–¥ï¸ ë°ìŠ¤í¬í†± ë³´ê¸°' : 'ğŸ“± ëª¨ë°”ì¼ ë³´ê¸°';
  mobileToggle.addEventListener('click', ()=>{
    document.body.classList.toggle('compact');
    localStorage.setItem('record_mobile', document.body.classList.contains('compact') ? '1' : '0');
    mobileToggle.textContent = document.body.classList.contains('compact') ? 'ğŸ–¥ï¸ ë°ìŠ¤í¬í†± ë³´ê¸°' : 'ğŸ“± ëª¨ë°”ì¼ ë³´ê¸°';
  });
})();

function clearActiveMenu(){ [...hitterMenu.children, ...pitcherMenu.children, ...extraMenu.children].forEach(li=>li.classList.remove('active')); }
function activateRanking(stat){
  currentSort.column = stat;
  currentSort.asc = isAscPreferred(stat);
  searchInput.value='';
  rankingContent.style.display='block'; h2hSection.style.display='none'; gamesSection.style.display='none';
  renderRanking(currentSort.column, currentSort.asc);
}
hitterMenu.onclick = e=>{ if(e.target.tagName==='LI'){ clearActiveMenu(); e.target.classList.add('active'); activateRanking(e.target.dataset.stat); } };
pitcherMenu.onclick = e=>{ if(e.target.tagName==='LI'){ clearActiveMenu(); e.target.classList.add('active'); activateRanking(e.target.dataset.stat); } };
extraMenu.onclick = e=>{
  if(e.target.tagName!=='LI') return;
  clearActiveMenu(); e.target.classList.add('active'); rankingContent.style.display='block';
  const v=e.target.dataset.view;
  if(v==='h2h'){ gamesSection.style.display='none'; h2hSection.style.display='block'; }
  else if(v==='games'){ h2hSection.style.display='none'; gamesSection.style.display='block'; }
};
searchInput.oninput = ()=>{ if(currentSort.column) renderRanking(currentSort.column, currentSort.asc); };

/* ======================= ì´ˆê¸° ë Œë” ======================= */
document.addEventListener('DOMContentLoaded', async ()=>{
  // ìŠ¤ì½”ì–´ë³´ë“œ
  const sb=SCOREBOARD;
  document.getElementById('sb-date').textContent = sb.date||'';
  document.getElementById('sb-away').textContent = sb.awayTeam||'';
  document.getElementById('sb-away-score').textContent = String(sb.awayScore??'');
  document.getElementById('sb-home').textContent = sb.homeTeam||'';
  document.getElementById('sb-home-score').textContent = String(sb.homeScore??'');

  // players.json ë¯¸ë¦¬ ë¡œë“œ & ìºì‹œ
  __allPlayersCache = await loadPlayersFromJson();

  loadRecentMvp();
  await renderMvpRanking();
  await calculateTeamStats();
  await prepareH2HForm();
  await prepareGameList();

  // íƒ€ì í¼ì„¼íƒ€ì¼ ê·œì • ì»·ì˜¤í”„ ê³„ì‚°(ë™ë¥  í¬í•¨)
  __hitterPercentileCutoffPA = computePercentileCutoffPA(__allPlayersCache);
  // ì„ íƒëœ ì§€í‘œê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ ë Œë”
  if(currentSort.column) renderRanking(currentSort.column, currentSort.asc);
});

/* ======================= ì ‘ê·¼ ì œì–´ ======================= */
goToInputBtn.onclick = ()=>{
  const pw = prompt("ê¸°ë¡ ì…ë ¥ í˜ì´ì§€ ì ‘ê·¼ì„ ìœ„í•œ ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
  if(pw === "Leaders0903") location.href = "index.html";
  else alert("ì•”í˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
};
</script>
</body>
</html>

