<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>선수 기록 블로그</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f9fc;
      padding: 30px;
      max-width: 1000px;
      margin: auto;
    }
    h1 {
      color: #1a73e8;
      text-align: center;
    }
    nav {
      text-align: center;
      margin-bottom: 20px;
    }
    nav a {
      text-decoration: none;
      padding: 10px 18px;
      background: #1a73e8;
      color: white;
      border-radius: 5px;
      font-weight: bold;
    }
    input[type="text"] {
      padding: 8px 12px;
      width: 300px;
      font-size: 1rem;
      margin-bottom: 20px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .stat-menu {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 25px;
    }
    .stat-menu li {
      list-style: none;
      background: #e3edf8;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
    }
    .stat-menu li.active {
      background: #1a73e8;
      color: white;
      font-weight: bold;
    }
    .section-title {
      margin-top: 40px;
      font-size: 1.4rem;
      color: #333;
      border-bottom: 2px solid #1a73e8;
      padding-bottom: 6px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #e8f0fe;
      color: #1a73e8;
    }
    .no-data {
      text-align: center;
      color: #888;
      margin-top: 20px;
    }
    #recentMvpInfo {
      margin-top: 20px;
      text-align: center;
      font-size: 1.2rem;
    }
    #recentMvpInfo img {
      vertical-align: middle;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <h1>선수 기록 블로그</h1>
  <nav>
    <a href="index.html">기록 입력 페이지로 이동</a>
  </nav>

  <input type="text" id="searchInput" placeholder="선수 이름 검색..." />

  <div>
    <ul id="hitterMenu" class="stat-menu">
      <li data-stat="타율">타율</li>
      <li data-stat="출루율">출루율</li>
      <li data-stat="OPS">OPS</li>
      <li data-stat="홈런">홈런</li>
      <li data-stat="타점">타점</li>
    </ul>
    <ul id="pitcherMenu" class="stat-menu">
      <li data-stat="승리">승리</li>
      <li data-stat="세이브">세이브</li>
      <li data-stat="홀드">홀드</li>
      <li data-stat="삼진">삼진</li>
      <li data-stat="ERA">ERA</li>
      <li data-stat="WHIP">WHIP</li>
    </ul>
  </div>

  <div id="rankingContent"></div>

  <div id="recentMvpInfo" class="section-title">최근 MVP 정보 불러오는 중...</div>

  <script>
    const searchInput = document.getElementById('searchInput');
    const hitterMenu = document.getElementById('hitterMenu');
    const pitcherMenu = document.getElementById('pitcherMenu');
    const rankingContent = document.getElementById('rankingContent');
    const recentMvpInfo = document.getElementById('recentMvpInfo');

    const hitterStatsForRanking = ['타율', '홈런', '출루율', 'OPS', '타점'];
    const pitcherStatsForRanking = ['승리', '세이브', '홀드', '삼진', 'ERA', 'WHIP'];
    let players = [];
    let currentSort = { column: null, asc: false };

    async function fetchPlayers() {
      const res = await fetch('players.js');
      const text = await res.text();
      const data = JSON.parse(text.match(/\[(.|\n)*\]/)[0]);
      return data;
    }

    function calculateAVG(p) {
      const H = (p.stats['1루타']||0)+(p.stats['2루타']||0)+(p.stats['3루타']||0)+(p.stats['홈런']||0);
      const AB = H + (p.stats['삼진']||0)+(p.stats['내야땅볼']||0)+(p.stats['플라이아웃']||0);
      return AB === 0 ? 0 : H / AB;
    }
    function calculateOBP(p) {
      const H = (p.stats['1루타']||0)+(p.stats['2루타']||0)+(p.stats['3루타']||0)+(p.stats['홈런']||0);
      const BB = p.stats['볼넷']||0;
      const SF = p.stats['희생플라이']||0;
      const AB = H + (p.stats['삼진']||0)+(p.stats['내야땅볼']||0)+(p.stats['플라이아웃']||0);
      const denom = AB + BB + SF;
      return denom === 0 ? 0 : (H + BB) / denom;
    }
    function calculateSLG(p) {
      const AB = (p.stats['1루타']||0)+(p.stats['2루타']||0)+(p.stats['3루타']||0)+(p.stats['홈런']||0)+(p.stats['삼진']||0)+(p.stats['내야땅볼']||0)+(p.stats['플라이아웃']||0);
      if (AB === 0) return 0;
      const totalBases = (p.stats['1루타']||0) + 2*(p.stats['2루타']||0) + 3*(p.stats['3루타']||0) + 4*(p.stats['홈런']||0);
      return totalBases / AB;
    }
    function calculateOPS(p) { return calculateOBP(p) + calculateSLG(p); }
    function calculateERA(p) {
      const ER = p.stats['자책점']||0;
      const IP = p.stats['이닝']||0;
      return IP === 0 ? 0 : (ER * 9) / IP;
    }
    function calculateWHIP(p) {
      const BB = p.stats['볼넷']||0;
      const H = p.stats['피안타']||0;
      const IP = p.stats['이닝']||0;
      return IP === 0 ? 0 : (BB + H) / IP;
    }

    function getStatValue(p, stat) {
      switch (stat) {
        case '타율': return calculateAVG(p);
        case '출루율': return calculateOBP(p);
        case 'OPS': return calculateOPS(p);
        case '홈런': return p.stats['홈런'] || 0;
        case '타점': return p.stats['타점'] || 0;
        case '승리': return p.stats['승리'] || 0;
        case '세이브': return p.stats['세이브'] || 0;
        case '홀드': return p.stats['홀드'] || 0;
        case '삼진': return p.stats['삼진'] || 0;
        case 'ERA': return calculateERA(p);
        case 'WHIP': return calculateWHIP(p);
        default: return 0;
      }
    }

    function getStatDisplay(p, stat) {
      const val = getStatValue(p, stat);
      if (['타율', '출루율', 'OPS', 'WHIP'].includes(stat)) return val.toFixed(3);
      if (stat === 'ERA') return val.toFixed(2);
      return val;
    }

    function renderRanking(stat) {
      let filtered = players.filter(p =>
        hitterStatsForRanking.includes(stat) ? p.type === '타자' : p.type === '투수'
      );

      const keyword = searchInput.value.trim().toLowerCase();
      if (keyword) {
        filtered = filtered.filter(p => p.name.toLowerCase().includes(keyword));
      }

      filtered.sort((a, b) => {
        const aVal = getStatValue(a, stat);
        const bVal = getStatValue(b, stat);
        return currentSort.asc ? aVal - bVal : bVal - aVal;
      });

      rankingContent.innerHTML = '';
      if (filtered.length === 0) {
        rankingContent.innerHTML = '<p class="no-data">선수 기록이 없습니다.</p>';
        return;
      }

      const table = document.createElement('table');
      table.innerHTML = `
        <thead><tr><th>순위</th><th>이름</th><th>${stat}</th></tr></thead>
        <tbody>
          ${filtered.map((p, i) => `
            <tr>
              <td>${i + 1}</td>
              <td>${p.name}</td>
              <td>${getStatDisplay(p, stat)}</td>
            </tr>
          `).join('')}
        </tbody>
      `;
      rankingContent.appendChild(table);
    }

    function loadRecentMvp() {
      if (players.length === 0) {
        recentMvpInfo.textContent = '선택된 MVP가 없습니다.';
        return;
      }

      const mvp = players.reduce((acc, curr) => {
        return (curr.mvpCount || 0) > (acc.mvpCount || 0) ? curr : acc;
      }, { mvpCount: 0 });

      recentMvpInfo.innerHTML = `
        <img src="mvp_logo.png" alt="MVP" style="height:40px;" />
        <span>${mvp.name} (${mvp.team} / ${mvp.type})</span>
      `;
    }

    function initMenus() {
      function handleMenuClick(e, isPitcher) {
        if (e.target.tagName !== 'LI') return;
        [...(isPitcher ? pitcherMenu.children : hitterMenu.children)].forEach(li => li.classList.remove('active'));
        e.target.classList.add('active');
        currentSort.column = e.target.getAttribute('data-stat');
        currentSort.asc = false;
        renderRanking(currentSort.column);
      }

      hitterMenu.addEventListener('click', e => handleMenuClick(e, false));
      pitcherMenu.addEventListener('click', e => handleMenuClick(e, true));
    }

    searchInput.addEventListener('input', () => {
      if (currentSort.column) renderRanking(currentSort.column);
    });

    document.addEventListener('DOMContentLoaded', async () => {
      players = await fetchPlayers();
      initMenus();
      loadRecentMvp();
      renderRanking('타율');
      hitterMenu.querySelector('[data-stat="타율"]').classList.add('active');
    });
  </script>
</body>
</html>
