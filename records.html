<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CSIALeaders | 기록실</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
/* ===================== THEME ===================== */
:root{
  --bg:#f6f8fd; --bg-grad1:#edf1ff;
  --text:#1f2937; --sub:#6b7280;
  --brand:#375dfb; --brand-2:#89a4ff;
  --card:#ffffff; --muted:#eef2ff; --border:#e5e7eb;
  --ring:rgba(55,93,251,.3); --good:#12b886; --bad:#ef4444;
  --shadow:0 10px 30px rgba(0,0,0,.06);
}
[data-theme="dark"]{
  /* 다크모드 대비 강화 + 그라데이션 유지 */
  --bg:#0b1224; --bg-grad1:#070f22;
  --text:#e9f1ff; --sub:#bcd0ff;
  --brand:#8fb2ff; --brand-2:#a7c2ff;
  --card:#0f1a30; --muted:#162347; --border:#243565;
  --ring:rgba(143,178,255,.35);
  --shadow:0 12px 30px rgba(0,0,0,.45);
}
*{ box-sizing:border-box }
html,body{ height:100% }
body{
  margin:0; color:var(--text);
  background: radial-gradient(120% 120% at 0% 0%, var(--bg-grad1) 0%, var(--bg) 55%) fixed;
  font-family: Pretendard, system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif;
}

/* ===================== TOP NAV ===================== */
.header{
  position:sticky; top:0; z-index:50;
  background:rgba(255,255,255,.55); backdrop-filter:saturate(180%) blur(14px);
  border-bottom:1px solid var(--border);
}
[data-theme="dark"] .header{ background:rgba(15,26,46,.6) }

.wrap{ max-width:1180px; margin:0 auto; padding:14px 16px; }
.brand{ font-weight:900; letter-spacing:.2px; font-size:22px; color:var(--brand); text-decoration:none }
.nav{ display:flex; gap:8px; align-items:center; width:100%; justify-content:space-between }

.tabs{ display:flex; gap:8px; flex-wrap:wrap; }
.tab{
  padding:8px 14px; border-radius:999px; color:var(--sub); font-weight:800; cursor:pointer;
  border:1px solid transparent; transition:.15s; user-select:none;
}
.tab.active{ color:#fff; background:var(--brand); box-shadow:0 6px 18px var(--ring); }
.tab:hover{ color:var(--brand); background:var(--muted) }

.iconbtn{
  border:1.5px solid var(--border); background:var(--card); color:var(--text);
  border-radius:12px; padding:8px 10px; cursor:pointer; box-shadow:var(--shadow);
}
.iconbtn.primary{ background:var(--brand); color:#fff; border-color:transparent }
.iconbtn:hover{ transform:translateY(-1px) }

/* ===================== GRID ===================== */
.section{ max-width:1180px; margin:18px auto; padding:0 16px; }
.grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:14px; }
.card{
  grid-column: span 6 / span 6;
  background:var(--card); border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow);
  padding:18px;
}
.card.sm{ grid-column: span 3 / span 3; }
.card.lg{ grid-column: 1 / -1; }
.card h3{ margin:0 0 6px; font-size:28px; letter-spacing:.2px }
.card .sub{ color:var(--sub); font-weight:700 }

/* ===================== HOME – Tiles ===================== */
.tile{
  display:flex; align-items:center; justify-content:center; min-height:120px;
  border:1px dashed var(--border); border-radius:16px; background:linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.1));
  font-size:22px; font-weight:900; letter-spacing:.2px; color:#3443a8; text-align:center;
}
[data-theme="dark"] .tile{ color:#cfe0ff; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); }
.tile .sub{ display:block; font-size:13px; margin-top:4px; color:var(--sub); font-weight:700 }
.tile:hover{ outline:3px solid var(--ring) }

/* ===================== HOME – Scoreboard & MVP ===================== */
.scoreboard{
  border-radius:18px; overflow:hidden; padding:28px; color:#e8f0ff;
  background: radial-gradient(140% 110% at 0% 0%, #0f1a35, #0a1228);
  border:1px solid rgba(255,255,255,.06); box-shadow:inset 0 0 40px rgba(255,255,255,.08), var(--shadow);
  min-height:220px; display:flex; align-items:center; justify-content:center;
}
.sb-inner{ text-align:center }
.sb-line{
  display:flex; align-items:center; gap:14px; font-weight:1000;
  font-size:40px; flex-wrap:nowrap; justify-content:center; white-space:nowrap;
}
.sb-badge{ padding:6px 14px; border-radius:999px; background:rgba(255,255,255,.12); font-size:28px }
.sb-away{ color:#6aa4ff; text-shadow:0 0 6px rgba(106,164,255,.4) }
.sb-home{ color:#ff7b7b; text-shadow:0 0 6px rgba(255,123,123,.4) }
.sb-date{ display:block; margin-bottom:8px; font-weight:800; color:#bcd3ff }

/* MVP banner (작게) */
#mvpBanner{
  display:grid; place-items:center; min-height:120px;
  background:linear-gradient(135deg,#2f67ff 0 50%,#ff2f59 50% 100%); color:#fff;
  border-radius:18px;
}
#mvpMain{ font-size:34px; font-weight:1000; line-height:1; text-shadow:0 4px 16px rgba(0,0,0,.35); white-space:nowrap }
#mvpSub{ font-weight:800; opacity:.9; margin-top:6px }

/* ===================== TABLE ===================== */
.table{ width:100%; border-collapse:collapse; table-layout:fixed; }
th,td{ border:1px solid var(--border); padding:10px 12px; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
th{ position:sticky; top:0; background:var(--muted); color:#2d3f9e; font-weight:900; z-index:1 }
[data-theme="dark"] th{ color:#d5e3ff; }
td.name{ color:#2f5bff; font-weight:800; cursor:pointer; text-decoration:underline }

/* H2H: 긴 칸 줄바꿈 & 축소 */
#h2hTable th, #h2hTable td{ white-space:normal; overflow:visible; text-overflow:clip; }
#h2hTable td.compact, #h2hTable th.compact{ font-size:.92em; line-height:1.15; word-break:break-word; }
#h2hTools{ display:flex; align-items:center; gap:10px; }
#h2hTools .spacer{ flex:1 1 auto; }   /* 검색 버튼 오른쪽으로 */

/* ========= 가로 스크롤 유틸 (디자인 유지하며 기능만 추가) ========= */
.scroll-x{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
.wide-table{ table-layout:auto; min-width:980px; }
.wide-table th, .wide-table td{ white-space:nowrap; overflow:visible; text-overflow:clip; }

/* helpers */
.row{ display:grid; grid-template-columns:repeat(3,minmax(140px,1fr)); gap:10px }
.row-2{ display:grid; grid-template-columns:repeat(2,minmax(140px,1fr)); gap:10px }
.tools{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:10px }
.pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:var(--muted); font-weight:800; color:#31406f }
[data-theme="dark"] .pill{ color:#cfe0ff }
.badge{ padding:5px 10px; border-radius:999px; border:1px solid var(--border); background:var(--muted); color:#2d3f9e; font-weight:900 }
[data-theme="dark"] .badge{ color:#d5e3ff }
input,select{ width:100%; padding:10px; border-radius:12px; border:1.5px solid var(--border); background:var(--card); color:var(--text) }
.no-data{ text-align:center; color:var(--sub); padding:16px }

/* disclosure */
details.disclosure{ border:1px solid var(--border); border-radius:14px; background:var(--card); box-shadow:var(--shadow); overflow:hidden; margin-top:10px }
details.disclosure summary{
  list-style:none; cursor:pointer; user-select:none; padding:12px 14px; font-weight:900; background:linear-gradient(180deg, var(--muted), transparent);
  display:flex; align-items:center; justify-content:space-between;
}
details.disclosure[open] summary{ border-bottom:1px solid var(--border) }

/* Member cards */
.people-grid{ display:grid; gap:10px; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); margin-top:12px; }
.person-card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:var(--shadow); transition:.15s; }
.person-card:hover{ transform:translateY(-2px); box-shadow:0 12px 24px rgba(55,93,251,.12) }
.person-name{ font-weight:900; margin-bottom:6px }
.person-sub{ color:var(--sub); font-weight:700; font-size:.95rem }

/* schedule list cards */
.game-card{ margin-top:12px; border-radius:16px; border:1px solid var(--border); background:var(--card); box-shadow:var(--shadow); padding:14px }
.game-head{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:space-between }
.game-title{ font-weight:900 }
.score-pill{ display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; background:var(--muted); font-weight:900 }

/* ==== 기록/통계 상단 툴바 리디자인 ==== */
.tools.column{ display:flex; flex-direction:column; gap:18px; }
.menu-row{ display:flex; align-items:center; gap:22px; flex-wrap:wrap; }

.chip-label{
  border:1.5px solid var(--border);
  background:var(--muted);
  color:var(--text);
  padding:8px 14px;
  border-radius:999px;
  font-weight:900;
  cursor:pointer;
  box-shadow:var(--shadow);
}
.chip-label.active{
  background:var(--brand);
  color:#fff;
  border-color:transparent;
  box-shadow:0 8px 20px var(--ring);
}

.menu-chips{
  list-style:none; display:flex; gap:28px; flex-wrap:wrap; margin:0; padding:0;
}
.menu-chips .tab{
  padding:0; border:none; background:none; cursor:pointer;
  color:var(--text); font-weight:900; letter-spacing:.2px;
  opacity:.75; transition:opacity .15s, transform .04s;
}
.menu-chips .tab:hover{ opacity:1; transform:translateY(-1px); }
.menu-chips .tab.active{ opacity:1; color:var(--brand); }

/* 모바일 간격 미세조정 */
@media (max-width:560px){
  .menu-chips{ gap:18px; }
}


/* ===================== MOBILE LAYOUT (<=560px) ===================== */
@media (max-width: 560px){
  .wrap{ padding:10px 12px }
  /* 헤더 3줄 레이아웃 */
  .topbar{
    display:grid; grid-template-rows:auto auto auto; gap:8px;
  }
  .brand{ font-size:20px }
  .tabs{
    display:grid; grid-template-columns:repeat(5,1fr); gap:6px;
  }
  .tab{ padding:8px 8px; text-align:center }
  .actions-row{
    display:flex; gap:8px; justify-content:flex-end;
  }
  /* 상단 바가 공간 차지 줄이도록 */
  .header{ border-bottom-width:0.5px }
  .tile{ min-height:90px; font-size:18px }
  .card{ padding:14px }
  .section{ margin:12px auto }
  /* 점수판 한 줄 강제 + 크기 자동조절 */
  .sb-line{ font-size:clamp(18px, 6vw, 30px); gap:10px }
  .sb-badge{ font-size:clamp(16px, 5vw, 24px); padding:4px 10px }
  .sb-date{ font-size:12px }
  /* MVP 한 줄 */
  #mvpMain{ font-size:clamp(18px, 7vw, 26px) }
  #mvpBanner{ min-height:90px }

  /* MVP 순위: 표 크기는 유지, 글씨/패딩만 축소 (잘림 방지) */
  #mvpRankingTable th, #mvpRankingTable td{
    font-size:12px; padding:6px 4px;
    white-space:nowrap; overflow:visible; text-overflow:clip;
  }
}

/* ===================== DESKTOP RESPONSIVE ===================== */
@media (max-width: 880px){
  .grid{ grid-template-columns: repeat(6, 1fr) }
  .card{ grid-column: 1 / -1 }
  .row,.row-2{ grid-template-columns:1fr }
}
.vote-btn{
  border:1px solid var(--border);
  border-radius:999px;
  padding:4px 8px;
  background:var(--brand);
  color:#fff;
  font-weight:700;
  margin-left:8px;
  cursor:pointer;
}
.vote-btn:hover{ background:var(--brand-2); }
</style>
</head>
<body>
  <!-- ===================== HEADER ===================== -->
  <div class="header">
    <div class="wrap topbar">
      <!-- 1줄: 브랜드 -->
      <div><a href="#" id="brandHome" class="brand">CSIALeaders</a></div>

      <!-- 2줄: 5개 탭 동일 크기 -->
      <div class="tabs">
        <span class="tab active" data-target="home">홈</span>
        <span class="tab" data-target="member">부원 소개</span>
        <span class="tab" data-target="record">기록 및 통계</span>
        <span class="tab" data-target="h2h">매치업 검색</span>
        <span class="tab" data-target="games">경기</span>
      </div>

      <!-- 3줄: 우측 정렬 액션 -->
      <div class="actions-row">
        <button id="themeToggle" class="iconbtn" title="테마 전환">🌙</button>
        <button id="goToInput" class="iconbtn primary">기록 입력</button>
      </div>
    </div>
  </div>

  <!-- ===================== HOME ===================== -->
  <section class="section" id="sec-home">
    <div class="grid">
      <!-- 4 tiles -->
      <a class="card sm tile" data-goto="record">stats<span class="sub">기록 및 통계</span></a>
      <a class="card sm tile" data-goto="h2h">H2H<span class="sub">매치업 검색</span></a>
      <a class="card sm tile" data-goto="games">games<span class="sub">경기 일정/결과</span></a>
      <a class="card sm tile" data-goto="member">member<span class="sub">부원 소개</span></a>

      <!-- Big Scoreboard -->
      <div class="card lg scoreboard">
        <div class="sb-inner">
          <span class="sb-date" id="sb-date">2025-09-19</span>
          <div class="sb-line">
            <span class="sb-away" id="sb-away">CSIA</span>
            <span class="sb-badge" id="sb-away-score">1</span>
            <span style="opacity:.75; font-weight:900">:</span>
            <span class="sb-badge" id="sb-home-score">5</span>
            <span class="sb-home" id="sb-home">Leaders</span>
          </div>
        </div>
      </div>

      <!-- Small MVP banner -->
      <div class="card lg" id="mvpBanner">
        <div style="text-align:center">
          <div id="mvpMain">MVP: 진승우</div>
          <div id="mvpSub">(Leaders/타자)</div>
        </div>
      </div>
    </div>
    <div class="card lg" id="mvpVoteBox">
        <h3>MVP 투표</h3>
        <div class="sub">오늘의 MVP를 직접 투표하세요! (브라우저당 하루 1표)</div>
        <table class="table">
          <thead><tr><th>선수</th><th>팀</th><th>투표</th></tr></thead>
          <tbody>
            <tr><td>진승우</td><td>Leaders</td><td><button class="vote-btn" onclick="sendVote('진승우','Leaders')">투표</button></td></tr>
            <tr><td>이동권</td><td>CSIA</td><td><button class="vote-btn" onclick="sendVote('이동권','CSIA')">투표</button></td></tr>
          </tbody>
        </table>
        <p style="font-weight:700; margin-top:10px">실시간 집계 결과:</p>
        <ul id="mvpVoteResults" style="list-style:none; padding:0; font-weight:800"></ul>
      </div>
    </div>
  </section>

  <!-- ===================== MEMBER ===================== -->
  <section class="section" id="sec-member" hidden>
    <div class="card lg">
      <h3>부원 소개</h3>
      <div class="sub">소속 팀 · 포지션 · 학년 · 반 · 나이</div>
      <div class="tools" style="margin-top:10px">
        <input id="memSearch" placeholder="이름 검색" />
        <select id="memTeam"><option value="">팀 전체</option></select>
        <select id="memPos"><option value="">포지션 전체</option></select>
      </div>
      <div class="people-grid" id="memberGrid"></div>
      <p class="no-data" id="memberNo">데이터 로딩 중…</p>
    </div>
  </section>

  <!-- ===================== RECORD ===================== -->
  <section class="section" id="sec-record" hidden>
    <div class="grid">
      <div class="card lg">
        <h3>기록 및 통계</h3>
        <div class="sub">이름을 검색하면 해당 선수의 모든 스탯과 각 항목의 순위가 한 번에 표시됩니다. 특정 분야를 선택하면 전체 랭킹을 보여줍니다.</div>
        <div class="tools column" id="statToolbar">
  <input id="searchInput" placeholder="선수 이름 검색 (실시간)" style="max-width:340px">

  <!-- 1줄: 타자 분야 -->
  <div class="menu-row">
    <button class="chip-label active" id="chipHit">타자 분야</button>
    <ul id="hitterMenu" class="menu-chips">
      <li class="tab" data-stat="타율">타율</li>
      <li class="tab" data-stat="홈런">홈런</li>
      <li class="tab" data-stat="출루율">출루율</li>
      <li class="tab" data-stat="OPS">OPS</li>
      <li class="tab" data-stat="타점">타점</li>
      <li class="tab" data-stat="WAR">WAR</li>
    </ul>
  </div>

  <!-- 2줄: 투수 분야 -->
  <div class="menu-row">
    <button class="chip-label" id="chipPit">투수 분야</button>
    <ul id="pitcherMenu" class="menu-chips">
      <li class="tab" data-stat="승리">승리</li>
      <li class="tab" data-stat="세이브">세이브</li>
      <li class="tab" data-stat="홀드">홀드</li>
      <li class="tab" data-stat="삼진">삼진</li>
      <li class="tab" data-stat="ERA">ERA</li>
      <li class="tab" data-stat="WHIP">WHIP</li>
    </ul>
  </div>
</div>

      </div>

      <div class="card lg" id="rankingContent">
        <div class="no-data">이름을 입력하거나, 위에서 분야를 선택하세요.</div>
      </div>

      <div class="card lg" id="mvpRankBox">
        <h3>MVP 순위</h3>
        <table id="mvpRankingTable" class="table"><thead><tr><th>순위</th><th>선수명</th><th>팀</th><th>MVP</th></tr></thead><tbody><tr><td colspan="4" class="no-data">로딩 중…</td></tr></tbody></table>
      </div>

      <div class="card lg" id="teamStatsBox">
        <h3>팀별 주요 통계</h3>
        <!-- ⬇️ 가로 스크롤 래퍼 추가 -->
        <div class="scroll-x">
          <table id="teamStatsTable" class="table wide-table">
            <thead><tr><th>팀명</th><th>팀 타율</th><th>팀 ERA</th><th>팀 득점</th><th>팀 타점</th><th>승률</th></tr></thead>
            <tbody><tr><td colspan="6" class="no-data">로딩 중…</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- ===================== H2H ===================== -->
  <section class="section" id="sec-h2h" hidden>
    <div class="card lg">
      <h3>매치업 검색 (투수–타자)</h3>
      <div class="row-2" style="margin-top:10px">
        <div><label>투수</label><input list="dlPitchers" id="h2hPitcher" placeholder="투수 이름"/></div>
        <div><label>타자</label><input list="dlHitters" id="h2hHitter" placeholder="타자 이름"/></div>
      </div>
      <datalist id="dlPitchers"></datalist><datalist id="dlHitters"></datalist>
      <div class="row-2" style="margin-top:8px">
        <div><label>경기(선택)</label><select id="h2hGameSelect"><option value="">전체 경기</option></select></div>
        <div><label>정렬</label><select id="h2hSort"><option value="time_desc">최신순</option><option value="time_asc">오래된순</option><option value="inning">이닝순</option></select></div>
      </div>
      <div id="h2hTools" class="tools">
        <span class="badge" id="h2hSummary">대기중</span>
        <span class="spacer"></span>
        <button class="iconbtn primary" id="h2hSearchBtn">검색</button>
      </div>

      <!-- 표 1: 이벤트 목록 (가로 스크롤) -->
      <div class="scroll-x">
        <table class="table wide-table" id="h2hTable" style="margin-top:10px;">
          <thead>
            <tr>
              <th class="compact">#</th>
              <th class="compact">시각</th>
              <th class="compact">경기</th>
              <th>이닝</th><th>공격팀</th><th>타자</th><th>투수</th><th>결과</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 표 2: 집계 (가로 스크롤) -->
      <div class="scroll-x" style="margin-top:10px">
        <table class="table wide-table" id="h2hAggTable">
          <thead><tr>
            <th>타석</th><th>1B</th><th>2B</th><th>3B</th><th>HR</th><th>BB</th><th>SO</th>
            <th>RBI</th><th>R</th><th>AVG</th><th>OBP</th><th>SLG</th><th>OPS</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ===================== GAMES ===================== -->
  <section class="section" id="sec-games" hidden>
    <div class="card lg">
      <h3>경기 (일정 · 결과)</h3>
      <div id="gamesList"></div>
      <p id="gamesEmpty" class="no-data" hidden>표시할 경기가 없습니다.</p>
    </div>
  </section>

  <footer class="section" style="opacity:.65; font-weight:700">사이트 아이디어·개발: 이원준</footer>

<script>
/* ============= BASIC CONFIG ============= */
const SCOREBOARD = { date:'2025-09-19', awayTeam:'CSIA', awayScore:1, homeTeam:'Leaders', homeScore:5 };
const PLAYER_JSON_URL = "https://alex4u-jun.github.io/bs_record/players.json";
const MEMBER_JSON_URL = "https://alex4u-jun.github.io/bs_record/players_introduce.json"; // ⬅️ 부원 소개 전용
const GAMERECORD_JSON_URLS = [
  "https://alex4u-jun.github.io/bs_record/gamerecord_1.json",
  "https://alex4u-jun.github.io/bs_record/gamerecord_2.json",
  "https://alex4u-jun.github.io/bs_record/gamerecord_3.json",
  "https://alex4u-jun.github.io/bs_record/gamerecord_4.json",
];

/* ============= NAV / THEME ============= */
const tabs=[...document.querySelectorAll('.tab[data-target]')];
const sections={
  home:document.getElementById('sec-home'),
  member:document.getElementById('sec-member'),
  record:document.getElementById('sec-record'),
  h2h:document.getElementById('sec-h2h'),
  games:document.getElementById('sec-games')
};
function showSec(id){
  Object.values(sections).forEach(s=>s.hidden=true);
  tabs.forEach(t=>t.classList.toggle('active', t.dataset.target===id));
  (sections[id]||sections.home).hidden=false;
  window.scrollTo({top:0,behavior:'smooth'});
}
tabs.forEach(t=>t.addEventListener('click',()=>showSec(t.dataset.target)));
[...document.querySelectorAll('[data-goto]')].forEach(el=>el.onclick=()=>showSec(el.dataset.goto));
document.getElementById('brandHome').addEventListener('click',e=>{ e.preventDefault(); showSec('home'); });

const themeToggle=document.getElementById('themeToggle');
(function initTheme(){
  const root=document.documentElement;
  const saved=localStorage.getItem('theme');
  if(saved==='dark'){ root.setAttribute('data-theme','dark'); themeToggle.textContent='☀️'; }
  themeToggle.onclick=()=>{
    const dark = root.getAttribute('data-theme')==='dark';
    if(dark){ root.removeAttribute('data-theme'); localStorage.setItem('theme',''); themeToggle.textContent='🌙'; }
    else{ root.setAttribute('data-theme','dark'); localStorage.setItem('theme','dark'); themeToggle.textContent='☀️'; }
  };
})();
document.getElementById('goToInput').onclick=()=>{
  const pw=prompt("기록 입력 페이지 암호를 입력하세요."); if(pw==="Leaders0903") location.href="index.html";
  else alert("암호가 틀렸습니다.");
};

/* ============= SCOREBOARD + MVP ============= */
document.getElementById('sb-date').textContent=SCOREBOARD.date;
document.getElementById('sb-away').textContent=SCOREBOARD.awayTeam;
document.getElementById('sb-away-score').textContent=String(SCOREBOARD.awayScore);
document.getElementById('sb-home').textContent=SCOREBOARD.homeTeam;
document.getElementById('sb-home-score').textContent=String(SCOREBOARD.homeScore);
(function loadMvpFromLocal(){
  const raw=localStorage.getItem('lastMvp');
  if(raw){ try{ const m=JSON.parse(raw); mvpMain.textContent=`MVP: ${m.name}`; mvpSub.textContent=`${m.team} · ${m.type}`; }catch{} }
})();

/* ============= DATA LOADERS ============= */
let __players=null;
async function loadPlayers(){
  if(__players) return __players;
  try{
    const r=await fetch(PLAYER_JSON_URL,{cache:'no-store'});
    __players=await r.json();
    return __players;
  }catch(e){ console.error(e); return []; }
}

/* ⬇️ 부원 소개 전용 로더 (introduce → 실패 시 players.json 폴백 매핑) */
let __members = null;
async function loadMembers(){
  if(__members) return __members;
  try{
    const r = await fetch(MEMBER_JSON_URL, {cache:'no-store'});
    if(!r.ok) throw new Error('introduce not found');
    const arr = await r.json();
    __members = Array.isArray(arr) ? arr : [];
    return __members;
  }catch(_){
    // 폴백: players.json을 멤버 카드용으로 변환
    const ps = await loadPlayers();
    __members = ps.map(p=>({
      name: p.name,
      team: p.team || '',
      position: p.position || p.type || '',
      grade: p.grade ?? '',
      class: p.class ?? '',
      age: p.age ?? ''
    }));
    return __members;
  }
}

async function loadGameRecordMerged(){
  try{
    const settled=await Promise.allSettled(GAMERECORD_JSON_URLS.map(u=>fetch(u,{cache:'no-store'})));
    const out={games:[],events:[]}; const gset=new Set(), eset=new Set();
    for(const s of settled){
      if(s.status!=='fulfilled' || !s.value.ok) continue;
      const j=await s.value.json();
      (j.games||[]).forEach(g=>{
        const id=String(g.gameId||g.id||'');
        if(!gset.has(id)){ gset.add(id); out.games.push(g); }
      });
      (j.events||[]).forEach(e=>{
        // 중복 제거: gameId + id
        const gid=String(e.gameId||''); const eid=String(e.id||(e.createdAt??e.updatedAt??e.ts??Math.random()));
        const key = gid + "____" + eid;
        if(!eset.has(key)){ eset.add(key); out.events.push(e); }
      });
    }
    return out;
  }catch(e){ console.error(e); return {games:[],events:[]}; }
}
function normGame(g){
  const id=String(g.gameId||g.id||''); return { id, date:g.date||'', away:g.awayTeam||g.away||'CSIA', home:g.homeTeam||g.home||'Leaders' };
}
function normEvent(e){
  const ts = Number(e.ts ?? e.createdAt ?? e.updatedAt ?? 0);
  return {
    gameId:String(e.gameId || e.gid || ''), ts,
    inning:Number(e.inning), half:e.half||'',
    offense:e.offenseTeam||'', defense:e.defenseTeam||'',
    hitter:e.hitterName||'', pitcher:e.pitcherName||'',
    hitterEvent:e.hitterEvent||'', rbi:Number(e.rbiDelta||0), run:Number(e.runScoredDelta||0),
    pitcherEvent:e.pitcherEvent||'', pitchCount:Number(e.pitchCountDelta||0),
    inningsDelta:Number(e.inningsDelta||0), er:Number(e.earnedRunsDelta||0)
  };
}

/* 공용 포맷터 */
function fmtTs(ts){
  if(!ts) return '';
  const d=new Date(ts); if(isNaN(d)) return '';
  const mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
  const hh=String(d.getHours()).padStart(2,'0'), mi=String(d.getMinutes()).padStart(2,'0');
  return `${d.getFullYear()}-${mm}-${dd} ${hh}:${mi}`;
}
/* H2H 전용 축약 포맷터 */
function fmtHHMM(ts){
  if(!ts) return ''; const d=new Date(ts); if(isNaN(d)) return '';
  const hh=String(d.getHours()).padStart(2,'0'); const mi=String(d.getMinutes()).padStart(2,'0'); return `${hh}:${mi}`;
}
function date8(str){ return (str||'').replaceAll('-',''); }
function gameIdToDate8(e, gamesMap){
  const g = gamesMap[e.gameId];
  if(g && g.date) return date8(g.date);
  const m = String(e.gameId).match(/(\d{4})-(\d{2})-(\d{2})/);
  return m ? `${m[1]}${m[2]}${m[3]}` : String(e.gameId);
}

/* ============= MEMBER (카드) ============= */
const memberGrid=document.getElementById('memberGrid'), memberNo=document.getElementById('memberNo');
const memSearch=document.getElementById('memSearch'), memTeam=document.getElementById('memTeam'), memPos=document.getElementById('memPos');

function mkCard(p){
  const team = p.team || '-';
  const pos  = p.position || p.type || '-';
  const num  = (p.backNumber && String(p.backNumber).trim() !== '') ? p.backNumber : '-';
  const age  = (p.age != null) ? `${p.age}세` :
               (p.school === 'MS' ? '중학생' : p.school === 'HS' ? '고등학생' : '');

  const div = document.createElement('div');
  div.className = 'person-card';
  div.innerHTML = `
    <div class="person-name">${p.name}</div>
    <div class="person-sub">${team} · ${pos} · ${num} · ${age}</div>
  `;
  return div;
}


/** select 박스를 데이터에 맞춰 동적 세팅 (초기 1회) */
let __memberFiltersHydrated = false;
function hydrateMemberFilters(members){
  if(__memberFiltersHydrated) return;
  // 팀 옵션
  const teams = [...new Set(members.map(m=>m.team).filter(Boolean))].sort();
  memTeam.innerHTML = `<option value="">팀 전체</option>` + teams.map(t=>`<option>${t}</option>`).join('');
  // 포지션 옵션
  const poss = [...new Set(members.map(m=>(m.position||'').trim()).filter(Boolean))].sort();
  memPos.innerHTML = `<option value="">포지션 전체</option>` + poss.map(p=>`<option>${p}</option>`).join('');
  __memberFiltersHydrated = true;
}

async function renderMembers(){
  const members = await loadMembers();
  hydrateMemberFilters(members);

  memberNo.hidden = true;
  const kw = (memSearch.value||'').trim().toLowerCase();
  const t  = memTeam.value;
  const pos= memPos.value;

  const list = members.filter(p=>{
    const okKw = kw ? p.name.toLowerCase().includes(kw) : true;
    const okT  = t ? (p.team===t) : true;
    const okP  = pos ? ((p.position||'')===pos) : true;
    return okKw && okT && okP;
  });

  memberGrid.innerHTML = '';
  if(!list.length){
    memberNo.hidden = false;
    memberNo.textContent = '검색된 부원이 없습니다.';
    return;
  }
  list.forEach(p=>memberGrid.appendChild(mkCard(p)));
}
[memSearch, memTeam, memPos].forEach(el=>el.addEventListener('input', renderMembers));
renderMembers();

/* ============= RECORD (랭킹/개인요약) ============= */
const rankingContent=document.getElementById('rankingContent');
const searchInput=document.getElementById('searchInput');
const hitterMenu=document.getElementById('hitterMenu');
const pitcherMenu=document.getElementById('pitcherMenu');

function calcAB(p){ const s=p.stats||{}, H=(s['1루타']||0)+(s['2루타']||0)+(s['3루타']||0)+(s['홈런']||0); const OUT=(s['삼진']||0)+(s['내야땅볼']||0)+(s['플라이아웃']||0); const ROE=(s['수비 실책']||0); return H+OUT+ROE; }
function PAof(p){ if(p.PA!=null) return +p.PA; const AB=calcAB(p), BB=(p.stats||{})['볼넷']||0, SF=(p.stats||{})['희생플라이']||0; return AB+BB+SF; }
function AVG(p){ const s=p.stats||{}, H=(s['1루타']||0)+(s['2루타']||0)+(s['3루타']||0)+(s['홈런']||0); const AB=calcAB(p); return AB? H/AB:0 }
function OBP(p){ const s=p.stats||{}, H=(s['1루타']||0)+(s['2루타']||0)+(s['3루타']||0)+(s['홈런']||0); const BB=s['볼넷']||0, AB=calcAB(p), SF=s['희생플라이']||0; const den=AB+BB+SF; return den? (H+BB)/den:0 }
function SLG(p){ const s=p.stats||{}, AB=calcAB(p); const TB=(s['1루타']||0)+2*(s['2루타']||0)+3*(s['3루타']||0)+4*(s['홈런']||0); return AB? TB/AB:0 }
function OPS(p){ return OBP(p)+SLG(p) }
function ERA(p){ const s=p.stats||{}, ER=s['자책점']||0, IP=s['이닝']||0; return IP? (ER*9)/IP:0 }
function WHIP(p){ const s=p.stats||{}, BB=s['볼넷']||0, H=s['피안타']||0, IP=s['이닝']||0; return IP? (BB+H)/IP:0 }
const WWT={ single:.90,double:1.25,triple:1.6,hr:2,bb:.7 }, WOBASCALE=1.15, RPW=10, REP_PER_600=20;
function wobaNum(p){ const s=p.stats||{}; return (s['1루타']||0)*WWT.single + (s['2루타']||0)*WWT.double + (s['3루타']||0)*WWT.triple + (s['홈런']||0)*WWT.hr + (s['볼넷']||0)*WWT.bb }
function leagueWoba(hitters){ let num=0, den=0; hitters.forEach(h=>{ num+=wobaNum(h); den+=PAof(h); }); return den? num/den:0 }
function buildWar(hitters){ const L=leagueWoba(hitters), map={}; hitters.forEach(p=>{ const pa=PAof(p)||0; if(!pa) return map[p.name]=0; const woba=wobaNum(p)/pa; const wRAA=(woba-L)/WOBASCALE*pa; const rep=REP_PER_600*(pa/600); map[p.name]=(wRAA+rep)/RPW; }); return map; }
function getVal(p,stat){ switch(stat){ case '타율':return AVG(p); case '출루율':return OBP(p); case 'OPS':return OPS(p); case '홈런': case '타점': case '승리': case '세이브': case '홀드': case '삼진': return (p.stats||{})[stat]||0; case 'ERA':return ERA(p); case 'WHIP':return WHIP(p); case 'WAR':return p.__war||0; default:return 0; } }
function dispVal(p,stat){ const v=getVal(p,stat); if(['타율','출루율','OPS','WHIP'].includes(stat)) return v.toFixed(3); if(stat==='ERA') return v.toFixed(2); if(stat==='WAR') return v.toFixed(1); return v; }
function medal(i){ return i===0?'🥇':i===1?'🥈':i===2?'🥉':'' }
let __pctCut=0;
function pctCut(players,p=.7){ const list=players.filter(p=>p.type==='타자').map(PAof).filter(x=>Number.isFinite(x)&&x>=0).sort((a,b)=>a-b); if(!list.length) return 0; const idx=Math.floor((list.length-1)*(1-p)); return Math.max(list[idx],0); }
function isAscPreferred(stat){ return ['ERA','WHIP'].includes(stat) }

function tableRanking(players, stat, nonQ){
  const t=document.createElement('table'); t.className='table';
  t.innerHTML=`<thead><tr><th>순위</th><th>선수</th><th>${stat}</th></tr></thead><tbody></tbody>`;
  const tb=t.querySelector('tbody');
  players.forEach((p,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${medal(i)}${i+1}</td><td class="name">${p.name}</td><td>${dispVal(p,stat)}</td>`;
    tr.querySelector('.name').onclick=()=>location.href=`player_detail.html?name=${encodeURIComponent(p.name)}&type=${encodeURIComponent(p.type)}`;
    tb.appendChild(tr);
  });
  if(nonQ && nonQ.length){
    const sep=document.createElement('tr'); sep.innerHTML=`<td colspan="3" style="font-weight:900;color:#b02">규정 미달</td>`; tb.appendChild(sep);
    nonQ.forEach(p=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>–</td><td class="name">${p.name}</td><td>${dispVal(p,stat)}</td>`;
      tr.querySelector('.name').onclick=()=>location.href=`player_detail.html?name=${encodeURIComponent(p.name)}&type=${encodeURIComponent(p.type)}`;
      tb.appendChild(tr);
    });
  }
  return t;
}
function applyQual(list,stat){
  const isH=['타율','홈런','출루율','OPS','타점','WAR'].includes(stat);
  const A=[], B=[];
  list.forEach(p=>{
    if(isH){ const need=__pctCut; const have=PAof(p); (have>=need?A:B).push(p); }
    else{ A.push(p); }
  });
  return {A,B};
}
async function renderRanking(stat, asc){
  const all=await loadPlayers();
  const isH=['타율','홈런','출루율','OPS','타점','WAR'].includes(stat);
  let list=all.filter(p=> isH ? p.type==='타자' : p.type==='투수');
  if(stat==='WAR'){ const map=buildWar(all.filter(p=>p.type==='타자')); list.forEach(p=>p.__war=map[p.name]||0) }
  list.sort((a,b)=>{
    const va=getVal(a,stat), vb=getVal(b,stat);
    if(asc) return va-vb;
    if(vb!==va) return vb-va;
    return (isH ? (PAof(b)-PAof(a)) : (((b.stats||{})['이닝']||0)-((a.stats||{})['이닝']||0)));
  });
  const {A,B}=applyQual(list,stat);
  rankingContent.innerHTML=''; rankingContent.appendChild(tableRanking(A,stat,B));
}

/* 개인 요약 + 항목별 순위 */
function playerSummaryHTML(p, all){
  const Hstats = ['타율','출루율','OPS','홈런','타점','WAR'];
  const Pstats = ['ERA','WHIP','승리','세이브','홀드','삼진'];
  const warMap = buildWar(all.filter(x=>x.type==='타자'));
  if(p.type==='타자') p.__war = warMap[p.name]||0;

  function rankOf(stat){
    const pool = all.filter(x => (Hstats.includes(stat) ? x.type==='타자' : x.type==='투수'))
                    .map(x => ({name:x.name, val:getVal(x,stat)}));
    pool.sort((a,b)=> (['ERA','WHIP'].includes(stat)? a.val-b.val : b.val-a.val));
    const idx = pool.findIndex(z=>z.name===p.name);
    return idx<0 ? '-' : (idx+1);
  }
  function row(stat){ return `<tr><td>${stat}</td><td>${dispVal(p,stat)}</td><td>${rankOf(stat)}</td></tr>`; }
  const rows = (p.type==='타자'?Hstats:Pstats).map(row).join('');
  return `<h3 style="margin:0 0 8px">${p.name} · <span class="sub">${p.team} · ${p.type}</span></h3>
          <table class="table" style="margin-top:8px">
            <thead><tr><th>항목</th><th>값</th><th>순위</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>`;
}
async function renderBySearch(){
  const kw=(searchInput.value||'').trim().toLowerCase();
  if(!kw){ rankingContent.innerHTML='<div class="no-data">이름을 입력하거나, 위에서 분야를 선택하세요.</div>'; return; }
  const all=await loadPlayers();
  const matches = all.filter(p=>p.name.toLowerCase().includes(kw));
  if(!matches.length){ rankingContent.innerHTML='<div class="no-data">해당 선수 없음</div>'; return; }
  rankingContent.innerHTML = matches.map(p=>`<div style="margin-bottom:12px">${playerSummaryHTML(p, all)}</div>`).join('');
}
searchInput.addEventListener('input', ()=>{
  if(searchInput.value.trim()){
    [...hitterMenu.children, ...pitcherMenu.children].forEach(x=>x.classList.remove('active'));
    renderBySearch();
  }else{
    rankingContent.innerHTML='<div class="no-data">이름을 입력하거나, 위에서 분야를 선택하세요.</div>';
  }
});
hitterMenu.onclick=e=>{
  if(e.target.dataset.stat){
    searchInput.value='';
    [...hitterMenu.children, ...pitcherMenu.children].forEach(x=>x.classList.remove('active'));
    e.target.classList.add('active');
    renderRanking(e.target.dataset.stat, ['ERA','WHIP'].includes(e.target.dataset.stat));
  }
};
pitcherMenu.onclick=e=>{
  if(e.target.dataset.stat){
    searchInput.value='';
    [...hitterMenu.children, ...pitcherMenu.children].forEach(x=>x.classList.remove('active'));
    e.target.classList.add('active');
    renderRanking(e.target.dataset.stat, ['ERA','WHIP'].includes(e.target.dataset.stat));
  }
};
(async()=>{ __players=await loadPlayers(); __pctCut=pctCut(__players); })();

/* MVP & 팀 통계 */
const mvpTbody=document.querySelector('#mvpRankingTable tbody');
const teamTbody=document.querySelector('#teamStatsTable tbody');
(async function renderMvpAndTeam(){
  try{
    const ps=await loadPlayers();
    const mv=ps.filter(p=>p.mvpCount>0);
    if(mv.length){
      const map={}; mv.forEach(p=>{ if(!map[p.name]) map[p.name]={...p}; else map[p.name].mvpCount+=p.mvpCount; });
      const arr=Object.values(map).sort((a,b)=>b.mvpCount-a.mvpCount);
      mvpTbody.innerHTML=arr.map((p,i)=>`<tr><td>${i+1}</td><td class="name">${p.name}</td><td>${p.team}</td><td>${p.mvpCount}</td></tr>`).join('');
    }else{
      mvpTbody.innerHTML=`<tr><td colspan="4" class="no-data">MVP 데이터 없음</td></tr>`;
    }
    const teams={};
    ps.forEach(p=>{
      const t=teams[p.team] ||= { H:0, AB:0, ER:0, IP:0, RBI:0, W:0, L:0 };
      if(p.type==='타자'){ const s=p.stats||{}; t.H += (s['1루타']||0)+(s['2루타']||0)+(s['3루타']||0)+(s['홈런']||0); t.AB += calcAB(p); t.RBI += (s['타점']||0); }
      else{ const s=p.stats||{}; t.ER += (s['자책점']||0); t.IP += (s['이닝']||0); t.W += (s['승리']||0); t.L += (s['패배']||0); }
    });
    const rows = Object.entries(teams).map(([team,t])=>{
      const avg=t.AB? (t.H/t.AB).toFixed(3):'0.000';
      const era=t.IP? (t.ER*9/t.IP).toFixed(2):'0.00';
      const wr=(t.W+t.L)? ((t.W/(t.W+t.L))*100).toFixed(1)+'%':'-';
      return `<tr><td>${team}</td><td>${avg}</td><td>${era}</td><td>–</td><td>${t.RBI}</td><td>${wr}</td></tr>`;
    }).join('');
    teamTbody.innerHTML = rows || `<tr><td colspan="6" class="no-data">팀 통계 데이터 없음</td></tr>`;
  }catch(err){
    console.error(err);
    mvpTbody.innerHTML=`<tr><td colspan="4" class="no-data">MVP 로딩 실패</td></tr>`;
    teamTbody.innerHTML=`<tr><td colspan="6" class="no-data">팀 통계 로딩 실패</td></tr>`;
  }
})();

/* ============= H2H (검색/표시) ============= */
const h2hPitcher=document.getElementById('h2hPitcher'), h2hHitter=document.getElementById('h2hHitter');
const dlPitchers=document.getElementById('dlPitchers'), dlHitters=document.getElementById('dlHitters');
const h2hGameSelect=document.getElementById('h2hGameSelect'), h2hSort=document.getElementById('h2hSort');
const h2hSearchBtn=document.getElementById('h2hSearchBtn'), h2hSummary=document.getElementById('h2hSummary');
const h2hTbody=document.querySelector('#h2hTable tbody'), h2hAggBody=document.querySelector('#h2hAggTable tbody');

function oText(e){
  const arr=[]; if(e.hitterEvent) arr.push(e.hitterEvent); if(e.rbi) arr.push(`RBI+${e.rbi}`); if(e.run) arr.push(`R+${e.run}`);
  if(e.pitcherEvent) arr.push(`P:${e.pitcherEvent}`); if(e.pitchCount) arr.push(`PC+${e.pitchCount}`); if(e.inningsDelta) arr.push(`IP+${e.inningsDelta}`); if(e.er) arr.push(`ER+${e.er}`);
  return arr.join(" · ");
}
(async function prepH2H(){
  const ps=await loadPlayers(); dlPitchers.innerHTML=ps.filter(p=>p.type==='투수').map(p=>`<option value="${p.name}">`).join('');
  dlHitters.innerHTML=ps.filter(p=>p.type==='타자').map(p=>`<option value="${p.name}">`).join('');
  const gr=await loadGameRecordMerged(); const gs=(gr.games||[]).map(normGame);
  h2hGameSelect.innerHTML='<option value="">전체 경기</option>'+gs.sort((a,b)=>(a.date||'').localeCompare(b.date||'')).map(g=>`<option value="${g.id}">${g.date} · ${g.away} @ ${g.home}</option>`).join('');
})();
function aggFrom(events){
  let PA=0,H=0,_2B=0,_3B=0,HR=0,BB=0,SO=0,RBI=0,R=0,AB=0,TB=0,SF=0;
  for(const e of events){ PA++;
    const t=(e.hitterEvent||'').trim();
    if(t==='1루타'){H++;AB++;TB+=1} else if(t==='2루타'){H++;_2B++;AB++;TB+=2}
    else if(t==='3루타'){H++;_3B++;AB++;TB+=3} else if(t==='홈런'){H++;HR++;AB++;TB+=4}
    else if(t==='볼넷'){BB++} else if(t==='희생플라이'){SF++} else if(t){AB++; if(t==='삼진') SO++; }
    RBI += (e.rbi||0); R += (e.run||0);
  }
  const AVG=AB?H/AB:0; const OBPden=AB+BB+SF; const OBP=OBPden? (H+BB)/OBPden:0; const SLG=AB?TB/AB:0; const OPS=OBP+SLG;
  return {PA,H,_2B,_3B,HR,BB,SO,RBI,R,AVG,OBP,SLG,OPS};
}
h2hSearchBtn.onclick = async ()=>{
  const gr=await loadGameRecordMerged();
  const gamesMap={}; (gr.games||[]).map(normGame).forEach(g=>gamesMap[g.id]=g);
  const pitcher=h2hPitcher.value.trim(), hitter=h2hHitter.value.trim(); const gameFilter=h2hGameSelect.value||'';
  let evs=(gr.events||[]).map(normEvent).filter(e=>{
    const okP = pitcher ? e.pitcher===pitcher : true;
    const okH = hitter ? e.hitter===hitter : true;
    const okG = gameFilter ? (String(e.gameId)===String(gameFilter)) : true;
    return okP && okH && okG;
  });
  const sort=h2hSort.value;
  if(sort==='time_desc') evs.sort((a,b)=>(b.ts||0)-(a.ts||0));
  else if(sort==='time_asc') evs.sort((a,b)=>(a.ts||0)-(b.ts||0));
  else{ const r=h=>h==='초'?0:1; evs.sort((a,b)=>(a.inning-b.inning)||(r(a.half)-r(b.half))||((a.ts||0)-(b.ts||0))); }

  h2hTbody.innerHTML='';
  evs.forEach((e,i)=>{ const tr=document.createElement('tr');
    const timeCell = `<td class="compact">${fmtHHMM(e.ts)}</td>`;
    const gameCell = `<td class="compact">${gameIdToDate8(e, gamesMap)}</td>`;
    tr.innerHTML=`<td class="compact">${i+1}</td>${timeCell}${gameCell}<td>${e.inning}회 ${e.half}</td><td>${e.offense}</td><td>${e.hitter}</td><td>${e.pitcher}</td><td>${oText(e)}</td>`;
    h2hTbody.appendChild(tr);
  });
  h2hSummary.textContent=`이벤트 ${evs.length}건`;
  const a=aggFrom(evs);
  h2hAggBody.innerHTML=`<tr><td>${a.PA}</td><td>${a.H-a._2B-a._3B-a.HR}</td><td>${a._2B}</td><td>${a._3B}</td><td>${a.HR}</td><td>${a.BB}</td><td>${a.SO}</td><td>${a.RBI}</td><td>${a.R}</td><td>${a.AVG.toFixed(3)}</td><td>${a.OBP.toFixed(3)}</td><td>${a.SLG.toFixed(3)}</td><td>${a.OPS.toFixed(3)}</td></tr>`;
};

/* ============= GAMES : 전체 경기 리스트 ============= */
const gamesList = document.getElementById('gamesList');
const gamesEmpty = document.getElementById('gamesEmpty');

function abbrev(tag){
  switch(tag){
    case '1루타': return '안타';
    case '2루타': return '2루타';
    case '3루타': return '3루타';
    case '홈런':  return 'HR';
    case '볼넷':  return '볼넷';
    case '삼진':  return '삼진';
    case '희생플라이': return 'SF';
    case '내야땅볼': return '땅볼';
    case '플라이아웃': return '플';
    case '수비 실책':  return 'E';          // ⬅️ 추가: 실책도 매트릭스/이벤트표에 표시
    default: return tag||'';
  }
}
function computeBox(events, away, home){
  const by={}; by[away]={R:0,H:0,E:0}; by[home]={R:0,H:0,E:0};
  for(const e of events){
    const t=e.offense; if(!(t in by)) by[t]={R:0,H:0,E:0};
    by[t].R += (e.run||0);
    const h=e.hitterEvent||'';
    if(h==='1루타'||h==='2루타'||h==='3루타'||h==='홈런') by[t].H += 1;
    if(h==='수비 실책') by[t].E += 1; // 팀 실책 카운트(있으면)
  }
  return by;
}
function makeTable(headers, rows){
  const t=document.createElement('table'); t.className='table';
  const thead=document.createElement('thead'), tbody=document.createElement('tbody');
  const hr=document.createElement('tr'); headers.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; hr.appendChild(th); }); thead.appendChild(hr);
  rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=r.map(c=>`<td>${c}</td>`).join(''); tbody.appendChild(tr); });
  t.appendChild(thead); t.appendChild(tbody); return t;
}
function renderPAMatrix(events){
  const teamMap={};
  const maxInning = Math.max( ...events.map(e=>+e.inning||1), 9 );
  for(const e of events){
    const team=e.offense; const name=e.hitter;
    (teamMap[team] ||= {}); (teamMap[team][name] ||= {});
    const key=String(e.inning);
    const prev = teamMap[team][name][key] || '';
    const v = abbrev(e.hitterEvent);
    teamMap[team][name][key] = prev ? (prev+' / '+v) : v;
  }
  const wrap=document.createElement('div');
  Object.entries(teamMap).forEach(([team,rows])=>{
    const tbl=document.createElement('table'); tbl.className='table wide-table';
    const thead=document.createElement('thead'); const hdr=document.createElement('tr');
    hdr.innerHTML='<th>타자명</th>'+Array.from({length:maxInning},(_,i)=>`<th>${i+1}</th>`).join(''); thead.appendChild(hdr);
    const tbody=document.createElement('tbody');
    Object.keys(rows).sort().forEach(name=>{
      const tr=document.createElement('tr'); let cells=`<td class="name">${name}</td>`;
      for(let i=1;i<=maxInning;i++) cells+=`<td>${rows[name][String(i)]||''}</td>`;
      tr.innerHTML=cells; tbody.appendChild(tr);
    });
    tbl.appendChild(thead); tbl.appendChild(tbody);

    const scroller=document.createElement('div'); scroller.className='scroll-x';
    scroller.appendChild(tbl);

    const head=document.createElement('div'); head.style="font-weight:900;margin:8px 0";
    head.textContent = `팀: ${team}`;
    wrap.appendChild(head);
    wrap.appendChild(scroller);
  });
  return wrap;
}
function renderEventTable(events){
  const rows=events.map((e,i)=>[
    i+1, fmtTs(e.ts), `${e.inning}회 ${e.half}`, e.offense, e.hitter, e.pitcher,
    [e.hitterEvent && abbrev(e.hitterEvent), e.rbi?`RBI+${e.rbi}`:'', e.run?`R+${e.run}`:'', e.pitcherEvent?`P:${e.pitcherEvent}`:''].filter(Boolean).join(' · ')
  ]);
  const scroller=document.createElement('div'); scroller.className='scroll-x';
  const table=makeTable(['#','시각','이닝','공격팀','타자','투수','결과'], rows);
  table.classList.add('wide-table');
  scroller.appendChild(table);
  return scroller;
}
(async function renderScheduleList(){
  const gr=await loadGameRecordMerged();
  const games=(gr.games||[]).map(normGame).sort((a,b)=>(b.date||'').localeCompare(a.date||''));
  const allE=(gr.events||[]).map(normEvent);
  gamesList.innerHTML='';
  if(!games.length){ gamesEmpty.hidden=false; return; }
  gamesEmpty.hidden=true;

  games.forEach(g=>{
    const evs = allE.filter(e=>String(e.gameId)===String(g.id));
    const box = computeBox(evs, g.away, g.home);

    const card=document.createElement('div'); card.className='game-card';

    const head=document.createElement('div'); head.className='game-head';
    const title=document.createElement('div'); title.className='game-title'; title.textContent = `${g.date} · ${g.away} @ ${g.home}`;
    const score=document.createElement('div'); score.className='score-pill';
    const awayR = (box[g.away]?.R)||0, homeR=(box[g.home]?.R)||0;
    score.textContent = `${g.away} ${awayR} — ${homeR} ${g.home}`;
    head.appendChild(title); head.appendChild(score);
    card.appendChild(head);

    const rows = [
      [g.home, box[g.home]?.R||0, box[g.home]?.H||0, box[g.home]?.E||0],
      [g.away, box[g.away]?.R||0, box[g.away]?.H||0, box[g.away]?.E||0],
    ];
    card.appendChild( makeTable(['Team','R','H','E'], rows) );

    const paDet=document.createElement('details'); paDet.className='disclosure';
    paDet.innerHTML = `<summary>타석 매트릭스 (이닝별/타자) <span class="sub">펼치기</span></summary>`;
    paDet.appendChild( renderPAMatrix(evs) );
    card.appendChild(paDet);

    const evDet=document.createElement('details'); evDet.className='disclosure';
    evDet.innerHTML = `<summary>이벤트 ${evs.length}건 <span class="sub">펼치기</span></summary>`;
    evDet.appendChild( renderEventTable(evs) );
    card.appendChild(evDet);

    gamesList.appendChild(card);
  });
})();
  // === 통계 메뉴 그룹 칩 활성화 제어 ===
  const chipHit = document.getElementById('chipHit');
  const chipPit = document.getElementById('chipPit');
  function setGroupActive(which){          // 'hit' | 'pit' | null
    chipHit.classList.toggle('active', which==='hit');
    chipPit.classList.toggle('active', which==='pit');
  }

  // 기존 메뉴 핸들러에 그룹 활성화만 추가
  hitterMenu.onclick = async (e)=>{
    if(e.target?.dataset?.stat){
      setGroupActive('hit');
      searchInput.value=''; // 메뉴 클릭 시 검색 초기화(선택)
      [...hitterMenu.children, ...pitcherMenu.children].forEach(x=>x.classList.remove('active'));
      e.target.classList.add('active');
      renderRanking(e.target.dataset.stat, ['ERA','WHIP'].includes(e.target.dataset.stat));
    }
  };
  pitcherMenu.onclick = async (e)=>{
    if(e.target?.dataset?.stat){
      setGroupActive('pit');
      searchInput.value='';
      [...hitterMenu.children, ...pitcherMenu.children].forEach(x=>x.classList.remove('active'));
      e.target.classList.add('active');
      renderRanking(e.target.dataset.stat, ['ERA','WHIP'].includes(e.target.dataset.stat));
    }
  };

  // 검색 입력 시 두 그룹 칩 비활성화 + 메뉴 활성화 해제
  searchInput.addEventListener('input', ()=>{
    if(searchInput.value.trim()){
      setGroupActive(null);
      [...hitterMenu.children, ...pitcherMenu.children].forEach(x=>x.classList.remove('active'));
      renderBySearch();
    }else{
      document.getElementById('rankingContent').innerHTML =
        '<div class="no-data">이름을 입력하거나, 위에서 분야를 선택하세요.</div>';
    }
  });

  // 칩(텍스트) 클릭 시엔 동작 없음(장식), 필요하면 스크롤 포커싱 정도만:
  chipHit.onclick = ()=> window.scrollBy({top:1, behavior:'smooth'});
  chipPit.onclick = ()=> window.scrollBy({top:1, behavior:'smooth'});

const GAS_URL = "https://docs.google.com/spreadsheets/d/11bOxFo__bQOWE3L6lFp3mZ3-TNonPYrP5cKErY-p-k8/edit?usp=drivesdk"; // Google Apps Script 웹 앱 URL

function getVoterId(){
  let id = localStorage.getItem('mvp_voter_id');
  if(!id){
    id = crypto.getRandomValues(new Uint32Array(4)).join('-');
    localStorage.setItem('mvp_voter_id', id);
  }
  return id;
}
function votedKey(){ return 'mvp_voted_' + new Date().toISOString().slice(0,10); }

async function sendVote(player, team){
  if(localStorage.getItem(votedKey())){ alert('오늘 이미 투표했습니다!'); return; }
  const res = await fetch(GAS_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      player, team,
      voterId: getVoterId(),
      ua: navigator.userAgent.slice(0,120)
    })
  });
  if(res.ok){
    localStorage.setItem(votedKey(), '1');
    alert('투표 완료!');
    await refreshVoteCounts();
  } else {
    alert('투표 오류');
  }
}

async function fetchVoteCounts(){
  try{
    const res = await fetch(GAS_URL, { method:'GET' });
    if(!res.ok) return {};
    return await res.json();
  }catch(e){ return {}; }
}
async function refreshVoteCounts(){
  const counts = await fetchVoteCounts();
  const ul=document.getElementById('mvpVoteResults');
  ul.innerHTML='';
  Object.entries(counts).forEach(([name,cnt])=>{
    const li=document.createElement('li');
    li.textContent=`${name}: ${cnt}표`;
    ul.appendChild(li);
  });
}
window.addEventListener('load', refreshVoteCounts);
</script>
</body>
</html>

