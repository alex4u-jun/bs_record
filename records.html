<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>CSIALeaders | ê¸°ë¡ì‹¤</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
/* ===================== THEME ===================== */
:root{
  --bg:#f6f8fd; --bg-grad1:#edf1ff; --text:#1f2937; --sub:#6b7280;
  --brand:#375dfb; --brand-2:#89a4ff; --card:#ffffff; --muted:#eef2ff;
  --border:#e5e7eb; --ring:rgba(55,93,251,.3); --shadow:0 10px 30px rgba(0,0,0,.06);
}
[data-theme="dark"]{
  --bg:#0b1224; --bg-grad1:#070f22; --text:#e9f1ff; --sub:#bcd0ff;
  --brand:#8fb2ff; --brand-2:#a7c2ff; --card:#0f1a30; --muted:#162347; --border:#243565;
  --ring:rgba(143,178,255,.35); --shadow:0 12px 30px rgba(0,0,0,.45);
}
*{ box-sizing:border-box }
html,body{ height:100% }
body{
  margin:0; color:var(--text);
  background: radial-gradient(120% 120% at 0% 0%, var(--bg-grad1) 0%, var(--bg) 55%) fixed;
  font-family: Pretendard, system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif;
}

/* ===================== HEADER ===================== */
.header{ position:sticky; top:0; z-index:50; border-bottom:1px solid var(--border);
  background:rgba(255,255,255,.55); backdrop-filter:saturate(180%) blur(14px); }
[data-theme="dark"] .header{ background:rgba(15,26,46,.6) }
.wrap{ max-width:1180px; margin:0 auto; padding:10px 16px; }
.brand{ font-weight:900; letter-spacing:.2px; font-size:22px; color:var(--brand); text-decoration:none }
.tabs{ display:flex; gap:8px; flex-wrap:wrap; }
.tab{
  padding:8px 14px; border-radius:999px; color:var(--sub); font-weight:800; cursor:pointer;
  border:1px solid transparent; transition:.15s; user-select:none;
}
.tab.active{ color:#fff; background:var(--brand); box-shadow:0 6px 18px var(--ring); }
.iconbtn{ border:1.5px solid var(--border); background:var(--card); color:var(--text);
  border-radius:12px; padding:8px 10px; cursor:pointer; box-shadow:var(--shadow); }
.iconbtn.primary{ background:var(--brand); color:#fff; border-color:transparent }

/* ===== ëª¨ë°”ì¼ìš©: 3ì¤„ ë ˆì´ì•„ì›ƒ + í—¤ë” non-sticky ===== */
.header-grid{ display:flex; justify-content:space-between; align-items:center; gap:10px }
.actions{ display:flex; gap:8px; }

@media (max-width:640px){
  .header{ position:static; }          /* â† ìŠ¤í¬ë¡¤ ì‹œ í—¤ë”ê°€ ë”°ë¼ì˜¤ì§€ ì•ŠìŒ */
  .wrap{ padding:8px 12px }
  .header-grid{
    display:grid; grid-template-columns:1fr auto; grid-template-rows:auto auto auto; gap:6px 10px;
    align-items:center;
  }
  .brand{ grid-column:1/2; grid-row:1/2; font-size:20px }
  .tabs{ grid-column:1/3; grid-row:2/3; justify-content:space-between; gap:6px }
  .tab{ flex:1 1 18%; text-align:center; padding:8px 0; font-weight:900; }
  .actions{ grid-column:2/3; grid-row:3/4; justify-content:flex-end }
}

/* ===================== LAYOUT ===================== */
.section{ max-width:1180px; margin:18px auto; padding:0 16px; }
.grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:14px; }
.card{
  grid-column: span 6 / span 6; background:var(--card); border:1px solid var(--border);
  border-radius:18px; box-shadow:var(--shadow); padding:18px;
}
.card.sm{ grid-column: span 3 / span 3; }
.card.lg{ grid-column: 1 / -1; }
.card h3{ margin:0 0 6px; font-size:28px; letter-spacing:.2px }
.card .sub{ color:var(--sub); font-weight:700 }

/* ===================== HOME â€“ Scoreboard / MVP ===================== */
.scoreboard{
  border-radius:18px; overflow:hidden; padding:16px; color:#e8f0ff;
  background: radial-gradient(140% 110% at 0% 0%, #0f1a35, #0a1228);
  border:1px solid rgba(255,255,255,.06); box-shadow:inset 0 0 40px rgba(255,255,255,.08), var(--shadow);
  min-height:140px; display:flex; align-items:center; justify-content:center;
}
.sb-inner{ text-align:center }
.sb-line{ display:flex; align-items:center; gap:10px; font-weight:1000; flex-wrap:nowrap; justify-content:center }
.sb-line > *{ white-space:nowrap }
.sb-away{ color:#6aa4ff; text-shadow:0 0 6px rgba(106,164,255,.4) }
.sb-home{ color:#ff7b7b; text-shadow:0 0 6px rgba(255,123,123,.4) }
.sb-date{ display:block; margin-bottom:4px; font-weight:800; color:#bcd3ff; font-size:14px }
.sb-badge{ padding:4px 10px; border-radius:999px; background:rgba(255,255,255,.12); }

@media (max-width:640px){
  .sb-line{ font-size:clamp(22px, 7.5vw, 40px); }   /* â† ëª¨ë°”ì¼ì—ì„œ ë” í¬ê²Œ */
  .sb-badge{ font-size:1em; }                      /* ë°°ì§€ í…ìŠ¤íŠ¸ë„ í•¨ê»˜ í™•ëŒ€ */
}

/* MVP ë°°ë„ˆ(í•œì¤„) */
#mvpBanner{ display:grid; place-items:center; min-height:88px;
  background:linear-gradient(135deg,#2f67ff 0 50%,#ff2f59 50% 100%); color:#fff; border-radius:18px; }
#mvpBanner .one-line{ display:flex; gap:10px; align-items:center; font-weight:1000; white-space:nowrap; }

/* ===================== TABLES ===================== */
/* ê³µí†µ: í•œ ì¤„ ìœ ì§€ + ê°€ë¡œ ìŠ¤í¬ë¡¤ ë˜í¼ */
.table-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
.table{ width:100%; border-collapse:collapse; table-layout:auto; }
th,td{
  border:1px solid var(--border); padding:10px 12px; text-align:center;
  white-space:nowrap; word-break:keep-all;
}
th{ position:sticky; top:0; background:var(--muted); color:#2d3f9e; font-weight:900; z-index:1 }
[data-theme="dark"] th{ color:#d5e3ff; }
td.name{ color:#2f5bff; font-weight:800; cursor:pointer; text-decoration:underline }

/* í‘œ ìµœì†Œ ë„ˆë¹„(ëª¨ë°”ì¼ì—ì„œ ê°€ë¡œ ìŠ¤í¬ë¡¤ ìœ ë„) */
#h2hTable{ min-width: 780px; }
#h2hAggTable{ min-width: 680px; }
.pa-matrix{ min-width: 980px; }
.events-table{ min-width: 820px; }
.team-table{ min-width: 640px; }
.mvp-table{ min-width: 520px; }

/* === ëª¨ë°”ì¼ ì „ìš© ê¸€ì ì¶•ì†Œ ê·œì¹™ë“¤ === */
@media (max-width:640px){
  /* MVP ìˆœìœ„: ê¸€ì ê¸¸ë©´ ìë™ ì¶•ì†Œ */
  .mvp-table th, .mvp-table td{ font-size:clamp(11px, 3.4vw, 14px); }
  /* íŒ€ í†µê³„ / ë§¤ì¹˜ì—… / ë©”íŠ¸ë¦­ìŠ¤ëŠ” ì´ë¯¸ table-wrapìœ¼ë¡œ ê°€ë¡œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
}

/* ê¸°íƒ€ */
.tools{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:10px }
.pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:var(--muted); font-weight:800; color:#31406f }
.badge{ padding:5px 10px; border-radius:999px; border:1px solid var(--border); background:var(--muted); color:#2d3f9e; font-weight:900 }

/* ë°˜ì‘í˜• ì¹´ë“œ */
@media (max-width:880px){ .grid{ grid-template-columns: repeat(6, 1fr) } .card{ grid-column:1 / -1 } }
</style>
</head>
<body>
  <!-- ===================== HEADER ===================== -->
  <div class="header">
    <div class="wrap">
      <div class="header-grid">
        <a href="#" id="brandHome" class="brand">CSIALeaders</a>
        <div class="tabs">
          <span class="tab active" data-target="home">í™ˆ</span>
          <span class="tab" data-target="member">ë¶€ì› ì†Œê°œ</span>
          <span class="tab" data-target="record">ê¸°ë¡ ë° í†µê³„</span>
          <span class="tab" data-target="h2h">ë§¤ì¹˜ì—… ê²€ìƒ‰</span>
          <span class="tab" data-target="games">ê²½ê¸°</span>
        </div>
        <div class="actions">
          <button id="themeToggle" class="iconbtn" title="í…Œë§ˆ ì „í™˜">ğŸŒ™</button>
          <button id="goToInput" class="iconbtn primary">ê¸°ë¡ ì…ë ¥</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== HOME ===================== -->
  <section class="section" id="sec-home">
    <div class="grid">
      <a class="card sm tile" data-goto="record">stats<span class="sub">ê¸°ë¡ ë° í†µê³„</span></a>
      <a class="card sm tile" data-goto="h2h">H2H<span class="sub">ë§¤ì¹˜ì—… ê²€ìƒ‰</span></a>
      <a class="card sm tile" data-goto="games">games<span class="sub">ê²½ê¸° ì¼ì •/ê²°ê³¼</span></a>
      <a class="card sm tile" data-goto="member">member<span class="sub">ë¶€ì› ì†Œê°œ</span></a>

      <div class="card lg scoreboard">
        <div class="sb-inner">
          <span class="sb-date" id="sb-date">2025-09-12</span>
          <div class="sb-line">
            <span class="sb-away" id="sb-away">CSIA</span>
            <span class="sb-badge" id="sb-away-score">2</span>
            <span style="opacity:.75; font-weight:900">:</span>
            <span class="sb-badge" id="sb-home-score">2</span>
            <span class="sb-home" id="sb-home">Leaders</span>
          </div>
        </div>
      </div>

      <div class="card lg" id="mvpBanner">
        <div class="one-line"><span id="mvpMain">MVP: í•œê²°</span><span id="mvpSub">(CISA/íƒ€ì)</span></div>
      </div>
    </div>
  </section>

  <!-- ===================== MEMBER ===================== -->
  <section class="section" id="sec-member" hidden>
    <div class="card lg">
      <h3>ë¶€ì› ì†Œê°œ</h3>
      <div class="sub">ì†Œì† íŒ€ Â· í¬ì§€ì…˜ Â· í•™ë…„</div>
      <div class="tools" style="margin-top:10px">
        <input id="memSearch" placeholder="ì´ë¦„ ê²€ìƒ‰" />
        <select id="memTeam"><option value="">íŒ€ ì „ì²´</option><option>Leaders</option><option>CSIA</option></select>
        <select id="memPos"><option value="">í¬ì§€ì…˜ ì „ì²´</option><option>íˆ¬ìˆ˜</option><option>ë‚´ì•¼ìˆ˜</option><option>ì™¸ì•¼ìˆ˜</option><option>í¬ìˆ˜</option></select>
      </div>
      <div class="people-grid" id="memberGrid"></div>
      <p class="no-data" id="memberNo">ë°ì´í„° ë¡œë”© ì¤‘â€¦</p>
    </div>
  </section>

  <!-- ===================== RECORD ===================== -->
  <section class="section" id="sec-record" hidden>
    <div class="grid">
      <div class="card lg">
        <h3>ê¸°ë¡ ë° í†µê³„</h3>
        <div class="sub">ì´ë¦„ì„ ê²€ìƒ‰í•˜ë©´ í•´ë‹¹ ì„ ìˆ˜ì˜ ëª¨ë“  ìŠ¤íƒ¯ê³¼ ê° í•­ëª©ì˜ ìˆœìœ„ê°€ í•œ ë²ˆì— í‘œì‹œë©ë‹ˆë‹¤. íŠ¹ì • ë¶„ì•¼ë¥¼ ì„ íƒí•˜ë©´ ì „ì²´ ë­í‚¹ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.</div>
        <div class="tools">
          <input id="searchInput" placeholder="ì„ ìˆ˜ ì´ë¦„ ê²€ìƒ‰ (ì‹¤ì‹œê°„)" style="max-width:340px">
          <span class="pill">íƒ€ì ë¶„ì•¼</span>
          <ul id="hitterMenu" style="list-style:none; display:flex; gap:6px; flex-wrap:wrap; margin:0">
            <li class="tab" data-stat="íƒ€ìœ¨">íƒ€ìœ¨</li><li class="tab" data-stat="í™ˆëŸ°">í™ˆëŸ°</li><li class="tab" data-stat="ì¶œë£¨ìœ¨">ì¶œë£¨ìœ¨</li>
            <li class="tab" data-stat="OPS">OPS</li><li class="tab" data-stat="íƒ€ì ">íƒ€ì </li><li class="tab" data-stat="WAR">WAR</li>
          </ul>
          <span class="pill">íˆ¬ìˆ˜ ë¶„ì•¼</span>
          <ul id="pitcherMenu" style="list-style:none; display:flex; gap:6px; flex-wrap:wrap; margin:0">
            <li class="tab" data-stat="ìŠ¹ë¦¬">ìŠ¹ë¦¬</li><li class="tab" data-stat="ì„¸ì´ë¸Œ">ì„¸ì´ë¸Œ</li><li class="tab" data-stat="í™€ë“œ">í™€ë“œ</li>
            <li class="tab" data-stat="ì‚¼ì§„">ì‚¼ì§„</li><li class="tab" data-stat="ERA">ERA</li><li class="tab" data-stat="WHIP">WHIP</li>
          </ul>
        </div>
      </div>

      <div class="card lg" id="rankingContent">
        <div class="no-data">ì´ë¦„ì„ ì…ë ¥í•˜ê±°ë‚˜, ìœ„ì—ì„œ ë¶„ì•¼ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
      </div>

      <div class="card lg" id="mvpRankBox">
        <h3>MVP ìˆœìœ„</h3>
        <div class="table-wrap">
          <table id="mvpRankingTable" class="table mvp-table">
            <thead><tr><th>ìˆœìœ„</th><th>ì„ ìˆ˜ëª…</th><th>íŒ€</th><th>MVP</th></tr></thead>
            <tbody><tr><td colspan="4" class="no-data">ë¡œë”© ì¤‘â€¦</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="card lg" id="teamStatsBox">
        <h3>íŒ€ë³„ ì£¼ìš” í†µê³„</h3>
        <div class="table-wrap">
          <table id="teamStatsTable" class="table team-table">
            <thead><tr><th>íŒ€ëª…</th><th>íŒ€ íƒ€ìœ¨</th><th>íŒ€ ERA</th><th>íŒ€ ë“ì </th><th>íŒ€ íƒ€ì </th><th>ìŠ¹ë¥ </th></tr></thead>
            <tbody><tr><td colspan="6" class="no-data">ë¡œë”© ì¤‘â€¦</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- ===================== H2H ===================== -->
  <section class="section" id="sec-h2h" hidden>
    <div class="card lg">
      <h3>ë§¤ì¹˜ì—… ê²€ìƒ‰ (íˆ¬ìˆ˜â€“íƒ€ì)</h3>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px">
        <div><label>íˆ¬ìˆ˜</label><input list="dlPitchers" id="h2hPitcher" placeholder="íˆ¬ìˆ˜ ì´ë¦„"/></div>
        <div><label>íƒ€ì</label><input list="dlHitters" id="h2hHitter" placeholder="íƒ€ì ì´ë¦„"/></div>
      </div>
      <datalist id="dlPitchers"></datalist><datalist id="dlHitters"></datalist>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:8px">
        <div><label>ê²½ê¸°(ì„ íƒ)</label><select id="h2hGameSelect"><option value="">ì „ì²´ ê²½ê¸°</option></select></div>
        <div><label>ì •ë ¬</label><select id="h2hSort"><option value="time_desc">ìµœì‹ ìˆœ</option><option value="time_asc">ì˜¤ë˜ëœìˆœ</option><option value="inning">ì´ë‹ìˆœ</option></select></div>
      </div>

      <div class="tools" id="h2hTools">
        <span class="badge" id="h2hSummary">ëŒ€ê¸°ì¤‘</span>
        <span style="flex:1 1 auto"></span>
        <button class="iconbtn primary" id="h2hSearchBtn">ê²€ìƒ‰</button>
      </div>

      <!-- í‘œ ì „ì²´ëŠ” ì¢Œìš° ìŠ¤í¬ë¡¤ -->
      <div class="table-wrap">
        <table class="table" id="h2hTable" style="margin-top:10px;">
          <thead><tr><th>#</th><th>ì‹œê°</th><th>ê²½ê¸°</th><th>ì´ë‹</th><th>ê³µê²©íŒ€</th><th>íƒ€ì</th><th>íˆ¬ìˆ˜</th><th>ê²°ê³¼</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="margin-top:10px">
        <div class="pill">ìš”ì•½(í˜„ì¬ ê²°ê³¼ì§‘í•©)</div>
        <div class="table-wrap">
          <table class="table" id="h2hAggTable" style="margin-top:8px">
            <thead><tr>
              <th>íƒ€ì„</th><th>ì•ˆíƒ€</th><th>2B</th><th>3B</th><th>HR</th><th>BB</th><th>SO</th><th>RBI</th>
              <th>R</th><th>AVG</th><th>OBP</th><th>SLG</th><th>OPS</th>
            </tr></thead><tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- ===================== GAMES ===================== -->
  <section class="section" id="sec-games" hidden>
    <div class="card lg">
      <h3>ê²½ê¸° (ì¼ì • Â· ê²°ê³¼)</h3>
      <div id="gamesList"></div>
      <p id="gamesEmpty" class="no-data" hidden>í‘œì‹œí•  ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
  </section>

  <footer class="section" style="opacity:.65; font-weight:700">ì‚¬ì´íŠ¸ ì•„ì´ë””ì–´Â·ê°œë°œ: ì´ì›ì¤€</footer>

<script>
/* ===== ê³µìš© ìœ í‹¸ ===== */
const byId = id => document.getElementById(id);
const sb = (id, v) => (byId(id).textContent = v);

/* ===== ê¸°ë³¸ ì„¤ì • ===== */
const SCOREBOARD = { date:'2025-09-12', awayTeam:'CSIA', awayScore:2, homeTeam:'Leaders', homeScore:2 };
const PLAYER_JSON_URL = "https://alex4u-jun.github.io/bs_record/players.json";
const GAMERECORD_JSON_URLS = [
  "https://alex4u-jun.github.io/bs_record/gamerecord_1.json",
  "https://alex4u-jun.github.io/bs_record/gamerecord_2.json",
];

/* ===== ë‚´ë¹„ / í…Œë§ˆ ===== */
const tabs=[...document.querySelectorAll('.tab[data-target]')];
const sections={ home:byId('sec-home'), member:byId('sec-member'), record:byId('sec-record'), h2h:byId('sec-h2h'), games:byId('sec-games')};
function showSec(id){ Object.values(sections).forEach(s=>s.hidden=true); tabs.forEach(t=>t.classList.toggle('active', t.dataset.target===id)); (sections[id]||sections.home).hidden=false; window.scrollTo({top:0,behavior:'smooth'}); }
tabs.forEach(t=>t.addEventListener('click',()=>showSec(t.dataset.target)));
[...document.querySelectorAll('[data-goto]')].forEach(el=>el.onclick=()=>showSec(el.dataset.goto));
byId('brandHome').addEventListener('click',e=>{ e.preventDefault(); showSec('home'); });

const themeToggle=byId('themeToggle');
(function initTheme(){
  const root=document.documentElement;
  const saved=localStorage.getItem('theme');
  if(saved==='dark'){ root.setAttribute('data-theme','dark'); themeToggle.textContent='â˜€ï¸'; }
  themeToggle.onclick=()=>{ const dark=root.getAttribute('data-theme')==='dark';
    if(dark){ root.removeAttribute('data-theme'); localStorage.setItem('theme',''); themeToggle.textContent='ğŸŒ™'; }
    else{ root.setAttribute('data-theme','dark'); localStorage.setItem('theme','dark'); themeToggle.textContent='â˜€ï¸'; }
  };
})();
byId('goToInput').onclick=()=>{ const pw=prompt("ê¸°ë¡ ì…ë ¥ í˜ì´ì§€ ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); if(pw==="Leaders0903") location.href="index.html"; else alert("ì•”í˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); };

/* ===== Scoreboard & MVP ===== */
sb('sb-date',SCOREBOARD.date); sb('sb-away',SCOREBOARD.awayTeam); sb('sb-home',SCOREBOARD.homeTeam);
sb('sb-away-score',String(SCOREBOARD.awayScore)); sb('sb-home-score',String(SCOREBOARD.homeScore));
(function(){ const raw=localStorage.getItem('lastMvp'); if(raw){ try{ const m=JSON.parse(raw); byId('mvpMain').textContent=`MVP: ${m.name}`; byId('mvpSub').textContent=`${m.team} Â· ${m.type}`; }catch{} }})();

/* ===== ë°ì´í„° ë¡œë” ===== */
let __players=null;
async function loadPlayers(){ if(__players) return __players; try{ const r=await fetch(PLAYER_JSON_URL,{cache:'no-store'}); __players=await r.json(); return __players; }catch(e){ console.error(e); return []; } }
async function loadGameRecordMerged(){
  try{
    const settled=await Promise.allSettled(GAMERECORD_JSON_URLS.map(u=>fetch(u,{cache:'no-store'})));
    const out={games:[],events:[]}; const gset=new Set(), eset=new Set();
    for(const s of settled){
      if(s.status!=='fulfilled' || !s.value.ok) continue;
      const j=await s.value.json();
      (j.games||[]).forEach(g=>{ const id=String(g.gameId||g.id||''); if(!gset.has(id)){ gset.add(id); out.games.push(g); }});
      (j.events||[]).forEach(e=>{
        const gid=String(e.gameId||''); const eid=String(e.id||(e.createdAt??e.updatedAt??e.ts??Math.random()));
        const key = gid + "____" + eid;
        if(!eset.has(key)){ eset.add(key); out.events.push(e); }
      });
    }
    return out;
  }catch(e){ console.error(e); return {games:[],events:[]}; }
}
function normGame(g){ const id=String(g.gameId||g.id||''); return { id, date:g.date||'', away:g.awayTeam||g.away||'CSIA', home:g.homeTeam||g.home||'Leaders' }; }
function normEvent(e){
  const ts = Number(e.ts ?? e.createdAt ?? e.updatedAt ?? 0);
  return { gameId:String(e.gameId||e.gid||''), ts, inning:+e.inning, half:e.half||'', offense:e.offenseTeam||'',
    defense:e.defenseTeam||'', hitter:e.hitterName||'', pitcher:e.pitcherName||'', hitterEvent:e.hitterEvent||'',
    rbi:+(e.rbiDelta||0), run:+(e.runScoredDelta||0), pitcherEvent:e.pitcherEvent||'', pitchCount:+(e.pitchCountDelta||0),
    inningsDelta:+(e.inningsDelta||0), er:+(e.earnedRunsDelta||0) };
}
function fmtHHMM(ts){ if(!ts) return ''; const d=new Date(ts); if(isNaN(d)) return ''; const h=String(d.getHours()).padStart(2,'0'); const m=String(d.getMinutes()).padStart(2,'0'); return `${h}:${m}`; }
function gameIdToDate8(e, gamesMap){ const g=gamesMap[e.gameId]; if(g && g.date) return g.date.replaceAll('-',''); const m=String(e.gameId).match(/(\d{4})-(\d{2})-(\d{2})/); return m?`${m[1]}${m[2]}${m[3]}`:String(e.gameId); }

/* ===== MEMBER ì¹´ë“œ ===== */
const memberGrid=byId('memberGrid'), memberNo=byId('memberNo');
const memSearch=byId('memSearch'), memTeam=byId('memTeam'), memPos=byId('memPos');
function mkCard(p){ const d=document.createElement('div'); d.className='person-card'; d.innerHTML=`<div class="person-name">${p.name}</div><div class="person-sub">${p.team||'-'} Â· ${p.position||p.type||'-'} Â· ${p.grade||'-'}</div>`; return d; }
async function renderMembers(){
  const players=await loadPlayers(); memberNo.hidden=true;
  const kw=(memSearch.value||'').trim().toLowerCase(); const t=memTeam.value, pos=memPos.value;
  const list=players.filter(p=>{ const okKw=kw? p.name.toLowerCase().includes(kw):true; const okT=t? p.team===t:true; const okP=pos? ((p.position||p.type)===pos):true; return okKw&&okT&&okP; });
  memberGrid.innerHTML=''; if(!list.length){ memberNo.hidden=false; memberNo.textContent='ê²€ìƒ‰ëœ ë¶€ì›ì´ ì—†ìŠµë‹ˆë‹¤.'; return; }
  list.forEach(p=>memberGrid.appendChild(mkCard(p)));
}
[memSearch,memTeam,memPos].forEach(el=>el.addEventListener('input',renderMembers)); renderMembers();

/* ===== RECORD(ë­í‚¹/ê°œì¸ìš”ì•½) ===== */
const rankingContent=byId('rankingContent'); const searchInput=byId('searchInput'); const hitterMenu=byId('hitterMenu'); const pitcherMenu=byId('pitcherMenu');
function calcAB(p){ const s=p.stats||{}, H=(s['1ë£¨íƒ€']||0)+(s['2ë£¨íƒ€']||0)+(s['3ë£¨íƒ€']||0)+(s['í™ˆëŸ°']||0); const OUT=(s['ì‚¼ì§„']||0)+(s['ë‚´ì•¼ë•…ë³¼']||0)+(s['í”Œë¼ì´ì•„ì›ƒ']||0); const ROE=(s['ìˆ˜ë¹„ ì‹¤ì±…']||0); return H+OUT+ROE; }
function PAof(p){ if(p.PA!=null) return +p.PA; const AB=calcAB(p), BB=(p.stats||{})['ë³¼ë„·']||0, SF=(p.stats||{})['í¬ìƒí”Œë¼ì´']||0; return AB+BB+SF; }
function AVG(p){ const s=p.stats||{}, H=(s['1ë£¨íƒ€']||0)+(s['2ë£¨íƒ€']||0)+(s['3ë£¨íƒ€']||0)+(s['í™ˆëŸ°']||0); const AB=calcAB(p); return AB? H/AB:0 }
function OBP(p){ const s=p.stats||{}, H=(s['1ë£¨íƒ€']||0)+(s['2ë£¨íƒ€']||0)+(s['3ë£¨íƒ€']||0)+(s['í™ˆëŸ°']||0); const BB=s['ë³¼ë„·']||0, AB=calcAB(p), SF=s['í¬ìƒí”Œë¼ì´']||0; const den=AB+BB+SF; return den? (H+BB)/den:0 }
function SLG(p){ const s=p.stats||{}, AB=calcAB(p); const TB=(s['1ë£¨íƒ€']||0)+2*(s['2ë£¨íƒ€']||0)+3*(s['3ë£¨íƒ€']||0)+4*(s['í™ˆëŸ°']||0); return AB? TB/AB:0 }
function OPS(p){ return OBP(p)+SLG(p) }
function ERA(p){ const s=p.stats||{}, ER=s['ìì±…ì ']||0, IP=s['ì´ë‹']||0; return IP? (ER*9)/IP:0 }
function WHIP(p){ const s=p.stats||{}, BB=s['ë³¼ë„·']||0, H=s['í”¼ì•ˆíƒ€']||0, IP=s['ì´ë‹']||0; return IP? (BB+H)/IP:0 }
const WWT={ single:.90,double:1.25,triple:1.6,hr:2,bb:.7 }, WOBASCALE=1.15, RPW=10, REP_PER_600=20;
function wobaNum(p){ const s=p.stats||{}; return (s['1ë£¨íƒ€']||0)*WWT.single + (s['2ë£¨íƒ€']||0)*WWT.double + (s['3ë£¨íƒ€']||0)*WWT.triple + (s['í™ˆëŸ°']||0)*WWT.hr + (s['ë³¼ë„·']||0)*WWT.bb }
function leagueWoba(hitters){ let num=0, den=0; hitters.forEach(h=>{ num+=wobaNum(h); den+=PAof(h); }); return den? num/den:0 }
function buildWar(hitters){ const L=leagueWoba(hitters), map={}; hitters.forEach(p=>{ const pa=PAof(p)||0; if(!pa) return map[p.name]=0; const woba=wobaNum(p)/pa; const wRAA=(woba-L)/WOBASCALE*pa; const rep=REP_PER_600*(pa/600); map[p.name]=(wRAA+rep)/RPW; }); return map; }
function getVal(p,stat){ switch(stat){ case 'íƒ€ìœ¨':return AVG(p); case 'ì¶œë£¨ìœ¨':return OBP(p); case 'OPS':return OPS(p); case 'í™ˆëŸ°': case 'íƒ€ì ': case 'ìŠ¹ë¦¬': case 'ì„¸ì´ë¸Œ': case 'í™€ë“œ': case 'ì‚¼ì§„': return (p.stats||{})[stat]||0; case 'ERA':return ERA(p); case 'WHIP':return WHIP(p); case 'WAR':return p.__war||0; default:return 0; } }
function dispVal(p,stat){ const v=getVal(p,stat); if(['íƒ€ìœ¨','ì¶œë£¨ìœ¨','OPS','WHIP'].includes(stat)) return v.toFixed(3); if(stat==='ERA') return v.toFixed(2); if(stat==='WAR') return v.toFixed(1); return v; }
function medal(i){ return i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':'' }
let __pctCut=0;
function pctCut(players,p=.7){ const list=players.filter(p=>p.type==='íƒ€ì').map(PAof).filter(x=>Number.isFinite(x)&&x>=0).sort((a,b)=>a-b); if(!list.length) return 0; const idx=Math.floor((list.length-1)*(1-p)); return Math.max(list[idx],0); }

function tableRanking(players, stat, nonQ){
  const t=document.createElement('table'); t.className='table'; t.style.minWidth='520px';
  t.innerHTML=`<thead><tr><th>ìˆœìœ„</th><th>ì„ ìˆ˜</th><th>${stat}</th></tr></thead><tbody></tbody>`;
  const tb=t.querySelector('tbody');
  players.forEach((p,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${medal(i)}${i+1}</td><td class="name">${p.name}</td><td>${dispVal(p,stat)}</td>`; tr.querySelector('.name').onclick=()=>location.href=\`player_detail.html?name=\${encodeURIComponent(p.name)}&type=\${encodeURIComponent(p.type)}\`; tb.appendChild(tr); });
  if(nonQ && nonQ.length){ const sep=document.createElement('tr'); sep.innerHTML=`<td colspan="3" style="font-weight:900;color:#b02">ê·œì • ë¯¸ë‹¬</td>`; tb.appendChild(sep);
    nonQ.forEach(p=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>â€“</td><td class="name">${p.name}</td><td>${dispVal(p,stat)}</td>`; tr.querySelector('.name').onclick=()=>location.href=\`player_detail.html?name=\${encodeURIComponent(p.name)}&type=\${encodeURIComponent(p.type)}\`; tb.appendChild(tr); }); }
  const wrap=document.createElement('div'); wrap.className='table-wrap'; wrap.appendChild(t); return wrap;
}
function applyQual(list,stat){ const isH=['íƒ€ìœ¨','í™ˆëŸ°','ì¶œë£¨ìœ¨','OPS','íƒ€ì ','WAR'].includes(stat); const A=[],B=[]; list.forEach(p=>{ if(isH){ const need=__pctCut; const have=PAof(p); (have>=need?A:B).push(p); } else A.push(p); }); return {A,B}; }
async function renderRanking(stat, asc){
  const all=await loadPlayers();
  const isH=['íƒ€ìœ¨','í™ˆëŸ°','ì¶œë£¨ìœ¨','OPS','íƒ€ì ','WAR'].includes(stat);
  let list=all.filter(p=> isH ? p.type==='íƒ€ì' : p.type==='íˆ¬ìˆ˜');
  if(stat==='WAR'){ const map=buildWar(all.filter(p=>p.type==='íƒ€ì')); list.forEach(p=>p.__war=map[p.name]||0) }
  list.sort((a,b)=>{ const va=getVal(a,stat), vb=getVal(b,stat); if(asc) return va-vb; if(vb!==va) return vb-va; return (isH ? (PAof(b)-PAof(a)) : (((b.stats||{})['ì´ë‹']||0)-((a.stats||{})['ì´ë‹']||0))); });
  const {A,B}=applyQual(list,stat); rankingContent.innerHTML=''; rankingContent.appendChild(tableRanking(A,stat,B));
}
function playerSummaryHTML(p, all){
  const Hstats=['íƒ€ìœ¨','ì¶œë£¨ìœ¨','OPS','í™ˆëŸ°','íƒ€ì ','WAR'], Pstats=['ERA','WHIP','ìŠ¹ë¦¬','ì„¸ì´ë¸Œ','í™€ë“œ','ì‚¼ì§„'];
  const warMap = buildWar(all.filter(x=>x.type==='íƒ€ì')); if(p.type==='íƒ€ì') p.__war = warMap[p.name]||0;
  function rankOf(stat){ const pool = all.filter(x => (Hstats.includes(stat) ? x.type==='íƒ€ì' : x.type==='íˆ¬ìˆ˜')).map(x => ({name:x.name, val:getVal(x,stat)})); pool.sort((a,b)=> (['ERA','WHIP'].includes(stat)? a.val-b.val : b.val-a.val)); const idx = pool.findIndex(z=>z.name===p.name); return idx<0 ? '-' : (idx+1); }
  function row(stat){ return `<tr><td>${stat}</td><td>${dispVal(p,stat)}</td><td>${rankOf(stat)}</td></tr>`; }
  const rows = (p.type==='íƒ€ì'?Hstats:Pstats).map(row).join('');
  return `<h3 style="margin:0 0 8px">${p.name} Â· <span class="sub">${p.team} Â· ${p.type}</span></h3>
          <div class="table-wrap"><table class="table" style="min-width:520px;margin-top:8px">
            <thead><tr><th>í•­ëª©</th><th>ê°’</th><th>ìˆœìœ„</th></tr></thead>
            <tbody>${rows}</tbody>
          </table></div>`;
}
async function renderBySearch(){
  const kw=(searchInput.value||'').trim().toLowerCase();
  if(!kw){ rankingContent.innerHTML='<div class="no-data">ì´ë¦„ì„ ì…ë ¥í•˜ê±°ë‚˜, ìœ„ì—ì„œ ë¶„ì•¼ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>'; return; }
  const all=await loadPlayers();
  const matches = all.filter(p=>p.name.toLowerCase().includes(kw));
  if(!matches.length){ rankingContent.innerHTML='<div class="no-data">í•´ë‹¹ ì„ ìˆ˜ ì—†ìŒ</div>'; return; }
  rankingContent.innerHTML = matches.map(p=>`<div style="margin-bottom:12px">${playerSummaryHTML(p, all)}</div>`).join('');
}
searchInput.addEventListener('input', ()=>{ if(searchInput.value.trim()){ [...hitterMenu.children, ...pitcherMenu.children].forEach(x=>x.classList.remove('active')); renderBySearch(); } else { rankingContent.innerHTML='<div class="no-data">ì´ë¦„ì„ ì…ë ¥í•˜ê±°ë‚˜, ìœ„ì—ì„œ ë¶„ì•¼ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>'; }});
hitterMenu.onclick=e=>{ if(e.target.dataset.stat){ searchInput.value=''; [...hitterMenu.children, ...pitcherMenu.children].forEach(x=>x.classList.remove('active')); e.target.classList.add('active'); renderRanking(e.target.dataset.stat, ['ERA','WHIP'].includes(e.target.dataset.stat)); } };
pitcherMenu.onclick=e=>{ if(e.target.dataset.stat){ searchInput.value=''; [...hitterMenu.children, ...pitcherMenu.children].forEach(x=>x.classList.remove('active')); e.target.classList.add('active'); renderRanking(e.target.dataset.stat, ['ERA','WHIP'].includes(e.target.dataset.stat)); } };
(async()=>{ __players=await loadPlayers(); __pctCut=pctCut(__players); })();

/* ===== MVP & íŒ€ í†µê³„ ===== */
const mvpTbody=document.querySelector('#mvpRankingTable tbody');
const teamTbody=document.querySelector('#teamStatsTable tbody');
(async function renderMvpAndTeam(){
  try{
    const ps=await loadPlayers();
    const mv=ps.filter(p=>p.mvpCount>0);
    if(mv.length){
      const map={}; mv.forEach(p=>{ if(!map[p.name]) map[p.name]={...p}; else map[p.name].mvpCount+=p.mvpCount; });
      const arr=Object.values(map).sort((a,b)=>b.mvpCount-a.mvpCount);
      mvpTbody.innerHTML=arr.map((p,i)=>`<tr><td>${i+1}</td><td class="name">${p.name}</td><td>${p.team}</td><td>${p.mvpCount}</td></tr>`).join('');
    }else{
      mvpTbody.innerHTML=`<tr><td colspan="4" class="no-data">MVP ë°ì´í„° ì—†ìŒ</td></tr>`;
    }
    const teams={};
    ps.forEach(p=>{
      const t=teams[p.team] ||= { H:0, AB:0, ER:0, IP:0, RBI:0, W:0, L:0 };
      if(p.type==='íƒ€ì'){ const s=p.stats||{}; t.H += (s['1ë£¨íƒ€']||0)+(s['2ë£¨íƒ€']||0)+(s['3ë£¨íƒ€']||0)+(s['í™ˆëŸ°']||0); t.AB += calcAB(p); t.RBI += (s['íƒ€ì ']||0); }
      else{ const s=p.stats||{}; t.ER += (s['ìì±…ì ']||0); t.IP += (s['ì´ë‹']||0); t.W += (s['ìŠ¹ë¦¬']||0); t.L += (s['íŒ¨ë°°']||0); }
    });
    const rows = Object.entries(teams).map(([team,t])=>{
      const avg=t.AB? (t.H/t.AB).toFixed(3):'0.000';
      const era=t.IP? (t.ER*9/t.IP).toFixed(2):'0.00';
      const wr=(t.W+t.L)? ((t.W/(t.W+t.L))*100).toFixed(1)+'%':'-';
      return `<tr><td>${team}</td><td>${avg}</td><td>${era}</td><td>â€“</td><td>${t.RBI}</td><td>${wr}</td></tr>`;
    }).join('');
    teamTbody.innerHTML = rows || `<tr><td colspan="6" class="no-data">íŒ€ í†µê³„ ë°ì´í„° ì—†ìŒ</td></tr>`;
  }catch(err){
    console.error(err);
    mvpTbody.innerHTML=`<tr><td colspan="4" class="no-data">MVP ë¡œë”© ì‹¤íŒ¨</td></tr>`;
    teamTbody.innerHTML=`<tr><td colspan="6" class="no-data">íŒ€ í†µê³„ ë¡œë”© ì‹¤íŒ¨</td></tr>`;
  }
})();

/* ===== H2H ê²€ìƒ‰ ===== */
const h2hPitcher=byId('h2hPitcher'), h2hHitter=byId('h2hHitter');
const dlPitchers=byId('dlPitchers'), dlHitters=byId('dlHitters');
const h2hGameSelect=byId('h2hGameSelect'), h2hSort=byId('h2hSort');
const h2hSearchBtn=byId('h2hSearchBtn'), h2hSummary=byId('h2hSummary');
const h2hTbody=document.querySelector('#h2hTable tbody'), h2hAggBody=document.querySelector('#h2hAggTable tbody');

function oText(e){
  const arr=[]; if(e.hitterEvent) arr.push(e.hitterEvent); if(e.rbi) arr.push(`RBI+${e.rbi}`); if(e.run) arr.push(`R+${e.run}`);
  if(e.pitcherEvent) arr.push(`P:${e.pitcherEvent}`); if(e.pitchCount) arr.push(`PC+${e.pitchCount}`); if(e.inningsDelta) arr.push(`IP+${e.inningsDelta}`); if(e.er) arr.push(`ER+${e.er}`);
  return arr.join(" Â· ");
}
(async function prepH2H(){
  const ps=await loadPlayers(); dlPitchers.innerHTML=ps.filter(p=>p.type==='íˆ¬ìˆ˜').map(p=>`<option value="${p.name}">`).join('');
  dlHitters.innerHTML=ps.filter(p=>p.type==='íƒ€ì').map(p=>`<option value="${p.name}">`).join('');
  const gr=await loadGameRecordMerged(); const gs=(gr.games||[]).map(normGame);
  h2hGameSelect.innerHTML='<option value="">ì „ì²´ ê²½ê¸°</option>'+gs.sort((a,b)=>(a.date||'').localeCompare(b.date||'')).map(g=>`<option value="${g.id}">${g.date} Â· ${g.away} @ ${g.home}</option>`).join('');
})();

function aggFrom(events){
  let PA=0,H=0,_2B=0,_3B=0,HR=0,BB=0,SO=0,RBI=0,R=0,AB=0,TB=0,SF=0;
  for(const e of events){ PA++;
    const t=(e.hitterEvent||'').trim();
    if(t==='1ë£¨íƒ€'){H++;AB++;TB+=1} else if(t==='2ë£¨íƒ€'){H++;_2B++;AB++;TB+=2}
    else if(t==='3ë£¨íƒ€'){H++;_3B++;AB++;TB+=3} else if(t==='í™ˆëŸ°'){H++;HR++;AB++;TB+=4}
    else if(t==='ë³¼ë„·'){BB++} else if(t==='í¬ìƒí”Œë¼ì´'){SF++} else if(t){AB++; if(t==='ì‚¼ì§„') SO++; }
    RBI += (e.rbi||0); R += (e.run||0);
  }
  const AVG=AB?H/AB:0; const OBPden=AB+BB+SF; const OBP=OBPden? (H+BB)/OBPden:0; const SLG=AB?TB/AB:0; const OPS=OBP+SLG;
  return {PA,H,_2B,_3B,HR,BB,SO,RBI,R,AVG,OBP,SLG,OPS};
}
h2hSearchBtn.onclick = async ()=>{
  const gr=await loadGameRecordMerged();
  const gamesMap={}; (gr.games||[]).map(normGame).forEach(g=>gamesMap[g.id]=g);
  const pitcher=h2hPitcher.value.trim(), hitter=h2hHitter.value.trim(); const gameFilter=h2hGameSelect.value||'';
  let evs=(gr.events||[]).map(normEvent).filter(e=>{
    const okP = pitcher ? e.pitcher===pitcher : true;
    const okH = hitter ? e.hitter===hitter : true;
    const okG = gameFilter ? (String(e.gameId)===String(gameFilter)) : true;
    return okP && okH && okG;
  });
  const sort=h2hSort.value;
  if(sort==='time_desc') evs.sort((a,b)=>(b.ts||0)-(a.ts||0));
  else if(sort==='time_asc') evs.sort((a,b)=>(a.ts||0)-(b.ts||0));
  else{ const r=h=>h==='ì´ˆ'?0:1; evs.sort((a,b)=>(a.inning-b.inning)||(r(a.half)-r(b.half))||((a.ts||0)-(b.ts||0))); }

  h2hTbody.innerHTML='';
  evs.forEach((e,i)=>{ const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${fmtHHMM(e.ts)}</td><td>${gameIdToDate8(e, gamesMap)}</td><td>${e.inning}íšŒ ${e.half}</td><td>${e.offense}</td><td>${e.hitter}</td><td>${e.pitcher}</td><td>${oText(e)}</td>`;
    h2hTbody.appendChild(tr);
  });
  h2hSummary.textContent=`ì´ë²¤íŠ¸ ${evs.length}ê±´`;
  const a=aggFrom(evs);
  h2hAggBody.innerHTML=`<tr><td>${a.PA}</td><td>${a.H-a._2B-a._3B-a.HR}</td><td>${a._2B}</td><td>${a._3B}</td><td>${a.HR}</td><td>${a.BB}</td><td>${a.SO}</td><td>${a.RBI}</td><td>${a.R}</td><td>${a.AVG.toFixed(3)}</td><td>${a.OBP.toFixed(3)}</td><td>${a.SLG.toFixed(3)}</td><td>${a.OPS.toFixed(3)}</td></tr>`;
};

/* ===== GAMES ë¦¬ìŠ¤íŠ¸ ===== */
const gamesList = byId('gamesList'), gamesEmpty = byId('gamesEmpty');
function abbrev(tag){ switch(tag){ case '1ë£¨íƒ€': return '1ì•ˆ'; case '2ë£¨íƒ€': return '2ë£¨'; case '3ë£¨íƒ€': return '3ë£¨'; case 'í™ˆëŸ°': return 'HR'; case 'ë³¼ë„·': return 'BB'; case 'ì‚¼ì§„': return 'SO'; case 'í¬ìƒí”Œë¼ì´': return 'SF'; case 'ë‚´ì•¼ë•…ë³¼': return 'ë•…'; case 'í”Œë¼ì´ì•„ì›ƒ': return 'í”Œ'; default: return tag||''; } }
function computeBox(events, away, home){ const by={}; by[away]={R:0,H:0,E:0}; by[home]={R:0,H:0,E:0};
  for(const e of events){ const t=e.offense; if(!(t in by)) by[t]={R:0,H:0,E:0}; by[t].R += (e.run||0);
    const h=e.hitterEvent||''; if(h==='1ë£¨íƒ€'||h==='2ë£¨íƒ€'||h==='3ë£¨íƒ€'||h==='í™ˆëŸ°') by[t].H += 1; }
  return by;
}
function makeTable(headers, rows, cls=''){ const t=document.createElement('table'); t.className='table '+cls;
  const thead=document.createElement('thead'), tbody=document.createElement('tbody');
  const hr=document.createElement('tr'); headers.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; hr.appendChild(th); }); thead.appendChild(hr);
  rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=r.map(c=>`<td>${c}</td>`).join(''); tbody.appendChild(tr); }); t.appendChild(thead); t.appendChild(tbody); return t; }
function wrapScroll(el){ const w=document.createElement('div'); w.className='table-wrap'; w.appendChild(el); return w; }
function renderPAMatrix(events){
  const teamMap={}; const maxInning = Math.max( ...events.map(e=>+e.inning||1), 9 );
  for(const e of events){
    const team=e.offense; const name=e.hitter;
    (teamMap[team] ||= {}); (teamMap[team][name] ||= {});
    const key=String(e.inning);
    const prev = teamMap[team][name][key] || '';
    const v = abbrev(e.hitterEvent);
    teamMap[team][name][key] = prev ? (prev+' / '+v) : v;
  }
  const wrap=document.createElement('div');
  Object.entries(teamMap).forEach(([team,rows])=>{
    const head=document.createElement('div'); head.style="font-weight:900;margin:8px 0"; head.textContent=`íŒ€: ${team}`;
    const tbl=document.createElement('table'); tbl.className='table pa-matrix';
    const thead=document.createElement('thead'); const hdr=document.createElement('tr');
    hdr.innerHTML='<th>íƒ€ìëª…</th>'+Array.from({length:maxInning},(_,i)=>`<th>${i+1}</th>`).join(''); thead.appendChild(hdr);
    const tbody=document.createElement('tbody');
    Object.keys(rows).sort().forEach(name=>{
      const tr=document.createElement('tr'); let cells=`<td class="name">${name}</td>`;
      for(let i=1;i<=maxInning;i++) cells+=`<td>${rows[name][String(i)]||''}</td>`;
      tr.innerHTML=cells; tbody.appendChild(tr);
    });
    tbl.appendChild(thead); tbl.appendChild(tbody);
    wrap.appendChild(head); wrap.appendChild(wrapScroll(tbl));   /* â† ìŠ¤í¬ë¡¤ ë˜í•‘ */
  });
  return wrap;
}
function renderEventTable(events){
  const rows=events.map((e,i)=>[
    i+1, fmtHHMM(e.ts), `${e.inning}íšŒ ${e.half}`, e.offense, e.hitter, e.pitcher,
    [e.hitterEvent && abbrev(e.hitterEvent), e.rbi?`RBI+${e.rbi}`:'', e.run?`R+${e.run}`:'', e.pitcherEvent?`P:${e.pitcherEvent}`:''].filter(Boolean).join(' Â· ')
  ]);
  return wrapScroll( makeTable(['#','ì‹œê°','ì´ë‹','ê³µê²©íŒ€','íƒ€ì','íˆ¬ìˆ˜','ê²°ê³¼'], rows, 'events-table') );
}
(async function renderScheduleList(){
  const gr=await loadGameRecordMerged();
  const games=(gr.games||[]).map(normGame).sort((a,b)=>(b.date||'').localeCompare(a.date||'')); const allE=(gr.events||[]).map(normEvent);
  gamesList.innerHTML=''; if(!games.length){ gamesEmpty.hidden=false; return; } gamesEmpty.hidden=true;
  games.forEach(g=>{
    const evs = allE.filter(e=>String(e.gameId)===String(g.id));
    const box = computeBox(evs, g.away, g.home);

    const card=document.createElement('div'); card.className='game-card';
    const head=document.createElement('div'); head.className='game-head';
    const title=document.createElement('div'); title.className='game-title'; title.textContent = `${g.date} Â· ${g.away} @ ${g.home}`;
    const score=document.createElement('div'); score.className='score-pill';
    const awayR = (box[g.away]?.R)||0, homeR=(box[g.home]?.R)||0;
    score.textContent = `${g.away} ${awayR} â€” ${homeR} ${g.home}`;
    head.appendChild(title); head.appendChild(score);
    card.appendChild(head);

    const rows = [
      [g.home, box[g.home]?.R||0, box[g.home]?.H||0, box[g.home]?.E||0],
      [g.away, box[g.away]?.R||0, box[g.away]?.H||0, box[g.away]?.E||0],
    ];
    card.appendChild( wrapScroll( makeTable(['Team','R','H','E'], rows) ) );  /* â† í‘œ ìŠ¤í¬ë¡¤ */

    const paDet=document.createElement('details'); paDet.className='disclosure';
    paDet.innerHTML = `<summary>íƒ€ì„ ë§¤íŠ¸ë¦­ìŠ¤ (ì´ë‹ë³„/íƒ€ì) <span class="sub">í¼ì¹˜ê¸°</span></summary>`;
    paDet.appendChild( renderPAMatrix(evs) );     /* â† ë‚´ë¶€í‘œë„ ìŠ¤í¬ë¡¤ */
    card.appendChild(paDet);

    const evDet=document.createElement('details'); evDet.className='disclosure';
    evDet.innerHTML = `<summary>ì´ë²¤íŠ¸ ${evs.length}ê±´ <span class="sub">í¼ì¹˜ê¸°</span></summary>`;
    evDet.appendChild( renderEventTable(evs) );   /* â† ìŠ¤í¬ë¡¤ ë˜í•‘ */
    card.appendChild(evDet);

    gamesList.appendChild(card);
  });
})();
</script>
</body>
</html>

