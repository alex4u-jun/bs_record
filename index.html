<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì•¼êµ¬ ê¸°ë¡ ì…ë ¥</title>
  <style>
/* ======================= í…Œë§ˆ (ë¼ì´íŠ¸/ë‹¤í¬) ======================= */
:root{
  --bg:#f6f8fd;
  --text:#1f2937;
  --muted:#6b7280;
  --card:#ffffff;
  --border:#dce3f2;
  --brand:#196ae5;
  --brand-600:#1457b9;
  --pill-bg:#e9f1ff;
  --pill-text:#196ae5;
  --thead:#eef3ff;
  --theadText:#185ad9;

  --chip-bg:#fff;
  --chip-bd:#c7d6fb;
  --chip-sel:#196ae5;
  --chip-wrap:#f2f6ff;

  --shadow:0 6px 22px rgba(20,87,185,.08);
}
[data-theme="dark"]{
  --bg:#0b1220;
  --text:#e7ecf7;
  --muted:#9aa6bd;
  --card:#0f1629;
  --border:#1e2a44;
  --brand:#5aa2ff;
  --brand-600:#3b84eb;
  --pill-bg:#0e1b33;
  --pill-text:#b8d5ff;
  --thead:#101e38;
  --theadText:#cfe2ff;

  --chip-bg:#101a34;
  --chip-bd:#2a3d66;
  --chip-sel:linear-gradient(180deg,#5aa2ff 0%,#3c78ff 100%);
  --chip-wrap:#0f1629;

  --shadow:0 10px 28px rgba(7,14,28,.55);
}

/* ======================= ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ======================= */
body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
  max-width: 1200px;
  margin: 40px auto;
  padding: 20px 30px;
  background: var(--bg);
  color: var(--text);
  overflow-x: auto;
}
h1 {
  font-size: 2rem;
  font-weight: 800;
  color: var(--brand);
  margin-bottom: 18px;
  text-align: center;
  letter-spacing: .2px;
}
nav a {
  display: inline-block;
  padding: 10px 20px;
  margin-bottom: 18px;
  background: var(--brand);
  color: white;
  font-weight: 700;
  border-radius: 10px;
  text-decoration: none;
  box-shadow: var(--shadow);
  transition: transform .05s ease, filter .2s ease;
}
nav a:hover { filter: brightness(.97); transform: translateY(-1px); }

/* ë‹¤í¬ëª¨ë“œ í† ê¸€ */
#themeToggle{
  float:right;
  margin-top:-6px;
  margin-bottom:8px;
  padding:8px 12px;
  border-radius:10px;
  border:1px solid var(--border);
  background: var(--card);
  color: var(--text);
  cursor:pointer;
  box-shadow: var(--shadow);
}

/* ê³µí†µ ë²„íŠ¼ */
button {
  padding: 10px 18px;
  font-size: 0.98rem;
  font-weight: 700;
  border: 1px solid transparent;
  border-radius: 10px;
  background: var(--brand);
  color: white;
  cursor: pointer;
  transition: transform .05s ease, filter .18s ease, box-shadow .18s ease;
  box-shadow: var(--shadow);
}
button:hover { filter: brightness(.97); transform: translateY(-1px); }
button:active { transform: translateY(0); }
button.alt { background: var(--brand-600); }

/* ì…ë ¥/ì„ íƒ */
form {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-bottom: 16px;
  flex-wrap: wrap;
}
input[type="text"], select {
  padding: 10px 12px;
  font-size: 1rem;
  border: 1.5px solid var(--border);
  border-radius: 10px;
  width: 180px;
  min-width: 150px;
  background: var(--card);
  color: var(--text);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
  transition: box-shadow .2s ease, border-color .2s ease;
}
input[type="text"]:focus, select:focus,
.spin-input:focus {
  outline: none;
  border-color: var(--brand);
  box-shadow: 0 0 0 3px rgba(90,162,255,.28);
}

/* ì¹´ë“œ ì„¹ì…˜ */
.section {
  background: var(--card);
  padding: 20px 25px;
  border-radius: 14px;
  border:1px solid var(--border);
  box-shadow: var(--shadow);
  overflow-x: auto;
  margin-top: 18px;
}

/* ìƒë‹¨ ì œì–´ë°” */
.controlbar{
  display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom:10px;
}
.left-controls, .right-controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.pill{
  background: var(--pill-bg);
  color: var(--pill-text);
  padding:6px 12px; border-radius:999px; font-weight:800; border:1px solid var(--border);
}

/* ë¼ì¸ì—… 2ì—´ */
.lineup-2col{ display:grid; gap:16px; grid-template-columns: 1fr 1fr; }
.lineup-card{
  border:1px solid var(--border); border-radius:14px; padding:14px; background:var(--card);
  box-shadow: var(--shadow);
}
.lineup-title{ font-weight:900; color:var(--brand); margin-bottom:8px; letter-spacing:.2px; }
.lineup-table{ width:100%; border-collapse:collapse; min-width:420px; }
.lineup-table th, .lineup-table td{
  border:1px solid var(--border); padding:8px 10px; text-align:center; background:transparent; color:var(--text);
}
.lineup-table th{ background:var(--thead); color:var(--theadText); }

/* ë“€ì–¼ ê·¸ë¦¬ë“œ(íˆ¬ìˆ˜/íƒ€ì ì…ë ¥) */
.duel-grid{ display:flex; gap:30px; flex-wrap:wrap; }
#pitcherSearch, #hitterSearch{
  width: 100%; margin-bottom: 12px;
}
#pitcherSearchResults div, #hitterSearchResults div{
  padding:8px 10px; margin-bottom:6px; background:var(--thead);
  border:1px solid var(--border); border-radius:8px; cursor:pointer;
}
#pitcherEditSection, #hitterEditSection{
  background: var(--chip-wrap);
  border: 1px solid var(--border);
  padding: 15px 20px;
  border-radius: 12px;
  margin-top: 8px;
}
#pitcherNameDisplay, #hitterNameDisplay{ font-weight:900; color:var(--brand); margin-bottom:10px; cursor:pointer; text-decoration: underline dashed; }

/* ì¹©(ë‹¨ì¼ì„ íƒ) */
.group-title{ font-weight:800; color:var(--text); margin:10px 0 6px; }
.chip-group{
  display:flex; flex-wrap:wrap; gap:10px; background:var(--chip-wrap);
  border:1px dashed var(--border); border-radius:12px; padding:12px;
}
.chip{
  padding:10px 14px; border-radius:12px; border:1px solid var(--chip-bd); background:var(--chip-bg);
  cursor:pointer; user-select:none; transition:transform .05s ease, box-shadow .18s ease, filter .18s ease, background .18s ease;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
  font-weight:700;
}
.chip:hover{ filter: brightness(.98); transform: translateY(-1px); }
.chip.selected{
  background: var(--chip-sel); color:#fff; border-color: transparent;
  box-shadow: 0 6px 18px rgba(58,120,255,.35);
}

/* ìˆ«ì ì…ë ¥ + í° í™”ì‚´í‘œ(ì»¤ìŠ¤í…€ ìŠ¤í”¼ë„ˆ) */
.num-row{ display:flex; align-items:center; gap:12px; margin:10px 0; }
.num-row label{ min-width:92px; font-weight:800; color:var(--text); }
.spin-wrap{ display:flex; align-items:center; gap:8px; }
.spin-input{
  width:140px; padding:12px 14px; border:1.5px solid var(--border);
  border-radius:12px; font-size:1.02rem; background:var(--card); color:var(--text);
}
.spin-btn{
  width:42px; height:42px; font-size:18px; font-weight:900; line-height:1;
  border-radius:12px; border:1px solid var(--border); background:var(--thead); color:var(--text);
  cursor:pointer; box-shadow: var(--shadow);
}
.spin-btn:hover{ filter:brightness(1.03); transform: translateY(-1px); }
.spin-btn:active{ transform: translateY(0); }

/* í…Œì´ë¸”/ë¦¬ìŠ¤íŠ¸ */
.player-list > div {
  background: var(--card);
  border: 1px solid var(--border);
  padding: 16px 20px;
  border-radius: 14px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
  overflow-x: auto;
  max-width: 100%;
}
.player-list h3 {
  font-weight: 900; color: var(--brand); margin-bottom: 15px;
  display: flex; justify-content: space-between; align-items: center;
}
.delete-btn {
  color: #ff6b6b; font-size: 14px; padding: 6px 10px; border-radius: 10px;
  background: transparent; border:1px solid var(--border); cursor: pointer;
}
table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 900px; }
th, td { border: 1px solid var(--border); text-align: center; font-size: 0.92rem; white-space: nowrap; padding: 8px 6px; }
th { background: var(--thead); color: var(--theadText); font-weight: 800; user-select: none; }
td.buttons-cell{ padding:6px 6px; }
button.stat-btn{
  width:26px; height:26px; font-size:16px; line-height:1; padding:0; border-radius:8px;
  border:1px solid var(--border); background:var(--thead); cursor:pointer; margin:0 2px;
}
.muted{ color:var(--muted); font-size:0.92rem; }

/* ==== íˆìŠ¤í† ë¦¬ ë¦¬ìŠ¤íŠ¸ íŒ¨ë„ ==== */
.history-wrap{
  display:flex; gap:14px; align-items:flex-start; margin-top:12px; flex-wrap:wrap;
}
.history-panel{
  flex:1; min-width: 340px; max-height: 260px; overflow:auto;
  background: var(--card); border:1px solid var(--border); border-radius:12px; box-shadow: var(--shadow);
}
.history-head{
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 12px; position:sticky; top:0; background:var(--thead); color:var(--theadText);
  border-bottom:1px solid var(--border); border-top-left-radius:12px; border-top-right-radius:12px;
}
.history-list{ padding:8px; }
.history-item{
  padding:10px 12px; border:1px solid var(--border); border-radius:10px; margin-bottom:8px; cursor:pointer;
  display:flex; gap:10px; align-items:center; background:var(--chip-bg);
}
.history-item:hover{ filter:brightness(0.98); transform: translateY(-1px); }
.history-item.active{
  background: var(--pill-bg); border-color: var(--brand); box-shadow: 0 6px 18px rgba(58,120,255,.18);
}
.tag{
  font-size:.78rem; font-weight:800; padding:4px 8px; border-radius:999px; border:1px solid var(--border);
  background: var(--thead); color: var(--theadText); white-space:nowrap;
}
.hist-main{ display:flex; flex-direction:column; gap:2px; }
.hist-title{ font-weight:800; }
.hist-sub{ font-size:.86rem; color:var(--muted); }

/* ê³ ì • ìƒë‹¨/í•˜ë‹¨ ì´ë™ ë²„íŠ¼ */
#backToEditorBtn{
  position:fixed; left:16px; bottom:16px; z-index:1000;
  font-size:.85rem; padding:8px 10px; border-radius:10px; opacity:.92;
  box-shadow: var(--shadow);
}

/* í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼ */
.highlight{
  outline: 3px solid var(--brand);
  background: var(--pill-bg);
  transition: outline .3s ease;
}
  </style>
</head>
<body>
  <h1>ì„ ìˆ˜ ê¸°ë¡ ì…ë ¥ ë° ê´€ë¦¬</h1>
  <button id="themeToggle">ğŸŒ™ ë‹¤í¬ ëª¨ë“œ</button>
  <nav>
    <a href="records.html">ì„ ìˆ˜ ê¸°ë¡ ì¡°íšŒ í˜ì´ì§€ë¡œ ì´ë™</a>
  </nav>

  <!-- ì„ ìˆ˜ ì¶”ê°€ -->
  <form id="addPlayerForm">
    <input type="text" id="playerName" placeholder="ì„ ìˆ˜ ì´ë¦„" required />
    <select id="playerType">
      <option value="íƒ€ì">íƒ€ì</option>
      <option value="íˆ¬ìˆ˜">íˆ¬ìˆ˜</option>
    </select>
    <select id="playerTeam" required>
      <option value="" disabled selected>íŒ€ ì„ íƒ</option>
      <option value="Leaders">Leaders</option>
      <option value="CSIA">CSIA</option>
    </select>
    <button type="submit">ì„ ìˆ˜ ì¶”ê°€</button>
  </form>

  <!-- === íˆ¬íƒ€ ëŒ€ê²° + ë¼ì¸ì—… + ì´ë‹ === -->
  <section class="section" id="duelSection">
    <!-- ìƒë‹¨ ì œì–´ë°” -->
    <div class="controlbar">
      <div class="left-controls">
        <span class="pill" id="inningBadge">1íšŒ ì´ˆ Â· ê³µê²©: Leaders</span>
        <span class="pill" id="historyBadge">íˆìŠ¤í† ë¦¬ 0ê±´ Â· í¬ì¸í„° ìµœì‹ </span>
        <span class="pill" id="editBadge" style="display:none; background:#fff0f0; color:#d33;">í¸ì§‘ ëª¨ë“œ</span>
      </div>
      <div class="right-controls">
        <label for="firstTeamSel" class="muted">ì„ ê³µ íŒ€:</label>
        <select id="firstTeamSel">
          <option value="Leaders">Leaders</option>
          <option value="CSIA">CSIA</option>
        </select>
        <button id="applyFirstTeamBtn" class="alt">ì„ ê³µ ì ìš©</button>
        <button id="resetInningBtn" style="background:#e67e22;">ì´ë‹ ì´ˆê¸°í™”</button>
      </div>
    </div>

    <!-- ë¼ì¸ì—…: ì–‘ìª½ ë™ì‹œ í‘œì‹œ -->
    <div class="lineup-2col" style="margin-bottom:12px;">
      <div class="lineup-card">
        <div class="lineup-title">Leaders ë¼ì¸ì—…</div>
        <div id="lineupEditorLeaders"></div>
      </div>
      <div class="lineup-card">
        <div class="lineup-title">CSIA ë¼ì¸ì—…</div>
        <div id="lineupEditorCSIA"></div>
      </div>
    </div>

    <!-- ë¼ì¸ì—… ì§„í–‰ íˆ´ë°” -->
    <div class="lineup-footer" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:6px;">
      <button id="startLineupBtn" type="button">ë¼ì¸ì—… ì‹œì‘</button>
      <button id="prevBatterBtn" type="button">â—€ ì´ì „ íƒ€ì ë³´ê¸°</button>
      <button id="nextBatterBtn" type="button">ë‹¤ìŒ íƒ€ì â–¶</button>
      <span class="muted" id="currentBatterInfo">í˜„ì¬ íƒ€ì: -</span>
    </div>

    <div id="editorTop"></div>
    <!-- íˆ¬ìˆ˜/íƒ€ì ì…ë ¥ ê·¸ë¦¬ë“œ -->
    <div class="duel-grid">
      <!-- íˆ¬ìˆ˜ -->
      <div style="flex:1; min-width: 320px;">
        <h3>íˆ¬ìˆ˜ ì„ íƒ ë° ê¸°ë¡</h3>
        <input type="text" id="pitcherSearch" placeholder="íˆ¬ìˆ˜ ì´ë¦„ ê²€ìƒ‰" autocomplete="off" />
        <div id="pitcherSearchResults"></div>
        <div id="pitcherEditSection" style="display:none;">
          <div id="pitcherNameDisplay" title="ë“±ë¡ ì„ ìˆ˜ ëª©ë¡ì—ì„œ ìœ„ì¹˜ ë³´ê¸°"></div>

          <div class="num-row">
            <label>íˆ¬êµ¬ìˆ˜(+)</label>
            <div class="spin-wrap">
              <button class="spin-btn" data-spin="dec" data-target="pitcherPitchCountInput">â–¼</button>
              <input id="pitcherPitchCountInput" class="spin-input" type="number" min="0" step="1" value="0" />
              <button class="spin-btn" data-spin="inc" data-target="pitcherPitchCountInput">â–²</button>
            </div>
          </div>
          <div class="num-row">
            <label>ì´ë‹(+)</label>
            <div class="spin-wrap">
              <button class="spin-btn" data-spin="dec" data-target="pitcherInningsInput">â–¼</button>
              <input id="pitcherInningsInput" class="spin-input" type="number" min="0" step="0.1" value="0" />
              <button class="spin-btn" data-spin="inc" data-target="pitcherInningsInput">â–²</button>
            </div>
          </div>
          <div class="num-row">
            <label>ìì±…ì (+)</label>
            <div class="spin-wrap">
              <button class="spin-btn" data-spin="dec" data-target="pitcherERInput">â–¼</button>
              <input id="pitcherERInput" class="spin-input" type="number" min="0" step="1" value="0" />
              <button class="spin-btn" data-spin="inc" data-target="pitcherERInput">â–²</button>
            </div>
          </div>

          <!-- ë‹¨ì¼ ì„ íƒ ê·¸ë£¹ 1 -->
          <div class="group-title">ì´ë²ˆ ê²°ê³¼(íˆ¬ìˆ˜) â€“ íƒ1</div>
          <div id="pitcherGroup1" class="chip-group" role="group" aria-label="Pitcher Result Group 1"></div>

          <!-- ë‹¨ì¼ ì„ íƒ ê·¸ë£¹ 2 -->
          <div class="group-title">ìŠ¹íŒ¨/ì„¸ì´ë¸Œ â€“ íƒ1</div>
          <div id="pitcherGroup2" class="chip-group" role="group" aria-label="Pitcher Result Group 2"></div>
        </div>
      </div>

      <!-- íƒ€ì -->
      <div style="flex:1; min-width: 320px;">
        <h3>íƒ€ì ì„ íƒ ë° ê¸°ë¡</h3>
        <input type="text" id="hitterSearch" placeholder="(ë‹¨ë… ì„ íƒìš©) íƒ€ì ì´ë¦„ ê²€ìƒ‰" autocomplete="off" />
        <div id="hitterSearchResults"></div>
        <div id="hitterEditSection" style="display:none;">
          <div id="hitterNameDisplay" title="ë“±ë¡ ì„ ìˆ˜ ëª©ë¡ì—ì„œ ìœ„ì¹˜ ë³´ê¸°"></div>

          <div class="group-title">ì´ë²ˆ ê²°ê³¼(íƒ€ì) â€“ íƒ1</div>
          <div id="hitterGroup" class="chip-group" role="group" aria-label="Hitter Result Group"></div>

          <div class="num-row">
            <label>íƒ€ì (+)</label>
            <div class="spin-wrap">
              <button class="spin-btn" data-spin="dec" data-target="hitterRBIInput">â–¼</button>
              <input id="hitterRBIInput" class="spin-input" type="number" min="0" step="1" value="0" />
              <button class="spin-btn" data-spin="inc" data-target="hitterRBIInput">â–²</button>
            </div>
          </div>
          <div class="num-row">
            <label>ë“ì (+)</label>
            <div class="spin-wrap">
              <button class="spin-btn" data-spin="dec" data-target="hitterRUNInput">â–¼</button>
              <input id="hitterRUNInput" class="spin-input" type="number" min="0" step="1" value="0" />
              <button class="spin-btn" data-spin="inc" data-target="hitterRUNInput">â–²</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- í•˜ë‹¨ íˆ´ë°” -->
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
      <button id="saveDuelBtn">ëŒ€ê²° ê¸°ë¡ ì €ì¥(ì¦ë¶„ ë°˜ì˜ & ìë™ ë‹¤ìŒ íƒ€ì)</button>
      <button id="updateRecordBtn" class="alt" style="display:none;">ê¸°ë¡ ìˆ˜ì • ì €ì¥</button>
      <button id="deleteRecordBtn" style="display:none; background:#ff6b6b;">ê¸°ë¡ ì‚­ì œ</button>
      <button id="cancelEditBtn" class="alt" style="display:none;">ìˆ˜ì • ì·¨ì†Œ</button>

      <button id="historyBackBtn" class="alt">â—€ íˆìŠ¤í† ë¦¬ ì´ì „ ë³´ê¸°</button>
      <button id="historyForwardBtn" class="alt">íˆìŠ¤í† ë¦¬ ë‹¤ìŒ ë³´ê¸° â–¶</button>

      <button id="endHalfBtn" style="margin-left:auto; background:#e67e22;">ì´ë‹ ì¢…ë£Œ(ê³µìˆ˜ ì „í™˜)</button>
      <button id="prevInningBtn" style="background:#34a853;">â—€ ì´ì „ ì´ë‹ ë³´ê¸°</button>
      <button id="nextInningBtn" style="background:#34a853;">ë‹¤ìŒ ì´ë‹ ë³´ê¸° â–¶</button>
    </div>

    <!-- íˆìŠ¤í† ë¦¬ ëª©ë¡ íŒ¨ë„ -->
    <div class="history-wrap">
      <div class="history-panel" aria-label="íˆìŠ¤í† ë¦¬ ëª©ë¡">
        <div class="history-head">
          <div style="display:flex; gap:8px; align-items:center;">
            <strong>íˆìŠ¤í† ë¦¬ ëª©ë¡</strong>
            <span class="muted" id="historyCountLabel"></span>
          </div>
          <div style="display:flex; gap:6px; align-items:center;">
            <select id="historyFilter">
              <option value="all">ì „ì²´</option>
              <option value="current">í˜„ì¬ ì´ë‹ë§Œ</option>
            </select>
            <button id="clearSelBtn" class="alt" title="ì„ íƒ í•´ì œ">ì„ íƒ í•´ì œ</button>
            <button id="clearHistoryBtn" style="background:#ff6b6b;" title="ëª¨ë“  íˆìŠ¤í† ë¦¬ ì‚­ì œ">ì´ˆê¸°í™”</button>
          </div>
        </div>
        <div id="historyList" class="history-list"></div>
      </div>
    </div>
  </section>

  <!-- ë“±ë¡ ì„ ìˆ˜ ëª©ë¡ -->
  <section class="section" id="playerListSection">
    <h2 style="margin-top:0; color:var(--brand);">ë“±ë¡ ì„ ìˆ˜ ëª©ë¡</h2>
    <div class="player-list" id="playerList"></div>
  </section>

  <!-- MVP / JSON -->
  <div class="section" style="text-align:center;">
    <h2 style="color:var(--brand);">MVP ì„ ì •</h2>
    <select id="mvpSelect">
      <option value="" disabled selected>ì„ ìˆ˜ ì„ íƒ</option>
    </select>
    <button id="selectMvpBtn">MVP ì„ ì •</button>
    <p id="mvpMessage" class="muted"></p>

    <button id="exportJsonBtn" style="margin-top: 12px; background: #34a853;">JSON íŒŒì¼ë¡œ ë‚´ë³´ë‚´ê¸°</button>
    <div style="margin-top:12px;">
      <input type="file" id="importJsonFile" accept="application/json" />
      <button id="importJsonBtn" style="margin-top: 8px; background: #fbbc05;">JSON ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>
  </div>

  <!-- í•­ìƒ ê³ ì •: ì—ë””í„°ë¡œ ì˜¬ë¼ê°€ê¸° -->
  <button id="backToEditorBtn" title="íˆ¬ìˆ˜/íƒ€ì ì„ íƒ ë° ê¸°ë¡ìœ¼ë¡œ ê°€ê¸°">â–² ê¸°ë¡ ì…ë ¥ìœ¼ë¡œ</button>

<script>
/* ==== í…Œë§ˆ í† ê¸€ ==== */
(function(){
  const root=document.documentElement, btn=document.getElementById('themeToggle');
  const saved = localStorage.getItem('theme');
  if(saved){ root.setAttribute('data-theme', saved); btn.textContent = saved==='dark'?'â˜€ï¸ ë¼ì´íŠ¸ ëª¨ë“œ':'ğŸŒ™ ë‹¤í¬ ëª¨ë“œ'; }
  btn.addEventListener('click',()=>{
    const isDark = root.getAttribute('data-theme')==='dark';
    const next = isDark ? '' : 'dark';
    if(next) root.setAttribute('data-theme', next); else root.removeAttribute('data-theme');
    localStorage.setItem('theme', next||'');
    btn.textContent = next==='dark'?'â˜€ï¸ ë¼ì´íŠ¸ ëª¨ë“œ':'ğŸŒ™ ë‹¤í¬ ëª¨ë“œ';
  });
})();

/* ==== Storage Keys ==== */
const STORAGE_KEY = 'playersData';
const LINEUP_KEY_BY_TEAM = (team)=>`lineup_${team}`;
const LINEUP_IDX_KEY_BY_TEAM = (team)=>`lineup_idx_${team}`;
const HISTORY_KEY = 'duelHistory_v2';
const GAME_STATE_KEY = 'gameState_v2';
const FIRST_TEAM_KEY = 'firstTeam_sel';

/* ==== Data ==== */
let players = [];
let offenseTeam = 'Leaders';
let defenseTeam = 'CSIA';
let inning = 1;
let half = 'ì´ˆ';
let duelHistory = [];
let historyPtr = -1;     // í¬ì¸í„°(ì›ë³¸ ì¸ë±ìŠ¤)
let editIndex = -1;      // í¸ì§‘ ì¤‘ì¸ íˆìŠ¤í† ë¦¬ ì¸ë±ìŠ¤
let viewInning = 1;
let viewHalf = 'ì´ˆ';

const hitterStatsHeaders  = ['1ë£¨íƒ€','2ë£¨íƒ€','3ë£¨íƒ€','í™ˆëŸ°','ì‚¼ì§„','ë³¼ë„·','í¬ìƒí”Œë¼ì´','ë‚´ì•¼ë•…ë³¼','í”Œë¼ì´ì•„ì›ƒ','íƒ€ì ','ë“ì '];
const pitcherStatsHeaders = ['íˆ¬êµ¬ìˆ˜','ì‚¼ì§„','ë³¼ë„·','í”¼ì•ˆíƒ€','í”¼í™ˆëŸ°','ìì±…ì ','ì´ë‹','ìŠ¹ë¦¬','íŒ¨ë°°','í™€ë“œ','ì„¸ì´ë¸Œ','ì‚¬êµ¬'];

/* ==== Storage helpers ==== */
const savePlayers = (p)=>localStorage.setItem(STORAGE_KEY, JSON.stringify(p));
const loadPlayers = ()=>JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

function getLineup(team){
  const raw = localStorage.getItem(LINEUP_KEY_BY_TEAM(team));
  if(!raw) return {batters: [], pitcher: ''};
  try{
    const parsed = JSON.parse(raw);
    if(Array.isArray(parsed)) return {batters: parsed, pitcher: ''};
    if(parsed && typeof parsed==='object')
      return {batters: parsed.batters || [], pitcher: parsed.pitcher || ''};
  }catch(e){}
  return {batters: [], pitcher: ''};
}
function saveLineup(team, obj){ localStorage.setItem(LINEUP_KEY_BY_TEAM(team), JSON.stringify(obj)); }

const saveLineupIdx = (team, idx)=>localStorage.setItem(LINEUP_IDX_KEY_BY_TEAM(team), String(idx||0));
const loadLineupIdx = (team)=>parseInt(localStorage.getItem(LINEUP_IDX_KEY_BY_TEAM(team))||'0',10);

const saveHistory = ()=>localStorage.setItem(HISTORY_KEY, JSON.stringify(duelHistory));
const loadHistory = ()=>JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]');

const saveGameState = ()=>{ localStorage.setItem(GAME_STATE_KEY, JSON.stringify({offenseTeam, defenseTeam, inning, half})); };
const loadGameState = ()=>{
  const s = JSON.parse(localStorage.getItem(GAME_STATE_KEY)||'{}');
  offenseTeam = s.offenseTeam || 'Leaders';
  defenseTeam = s.defenseTeam || 'CSIA';
  inning = s.inning || 1;
  half = s.half || 'ì´ˆ';
};

/* ==== Init ==== */
function init(){
  players = loadPlayers();
  duelHistory = loadHistory();
  loadGameState();

  const savedFirst = localStorage.getItem(FIRST_TEAM_KEY);
  if(savedFirst){
    document.getElementById('firstTeamSel').value = savedFirst;
    setFirstTeam(savedFirst, false);
  }else{
    setFirstTeam(offenseTeam, false);
  }

  renderPlayerList();
  updateMvpSelect();
  setupSearchAndEdit();
  buildBothLineups();
  updateInningBadge();
  updateHistoryBadge();
  updateCurrentBatterInfo();
  ensureAutoPitcher();
  syncSearchInputs();

  // ì´ˆê¸° íˆìŠ¤í† ë¦¬ ëª©ë¡ ë Œë”
  renderHistoryList('all');

  // í•„í„°/ì„ íƒí•´ì œ/ì´ˆê¸°í™” ì´ë²¤íŠ¸
  document.getElementById('historyFilter').addEventListener('change', ()=>renderHistoryList());
  document.getElementById('clearSelBtn').addEventListener('click', ()=>{
    historyPtr = -1;
    exitEditMode();
    updateHistoryBadge();
    renderHistoryList();
  });
  document.getElementById('clearHistoryBtn').addEventListener('click', ()=>{
    if(!confirm('ëª¨ë“  íˆìŠ¤í† ë¦¬ë¥¼ ì‚­ì œí• ê¹Œìš”? ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
    // ëª©ë¡ë§Œ ì´ˆê¸°í™”(í†µê³„ëŠ” ìœ ì§€)
    duelHistory = [];
    saveHistory();
    historyPtr = -1;
    exitEditMode();
    updateHistoryBadge();
    renderHistoryList();
    alert('íˆìŠ¤í† ë¦¬ë¥¼ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.');
  });

  // í¸ì§‘ ë²„íŠ¼ ì´ë²¤íŠ¸
  document.getElementById('updateRecordBtn').addEventListener('click', onUpdateRecord);
  document.getElementById('deleteRecordBtn').addEventListener('click', onDeleteRecord);
  document.getElementById('cancelEditBtn').addEventListener('click', exitEditMode);

  // ì´ë¦„ í´ë¦­ â†’ ë“±ë¡ ì„ ìˆ˜ ìœ„ì¹˜ë¡œ ìŠ¤í¬ë¡¤
  document.getElementById('pitcherNameDisplay').addEventListener('click', ()=>scrollToPlayerFromDisplay('íˆ¬ìˆ˜'));
  document.getElementById('hitterNameDisplay').addEventListener('click', ()=>scrollToPlayerFromDisplay('íƒ€ì'));

  // ê³ ì •: ì—ë””í„°ë¡œ ì˜¬ë¼ê°€ê¸°
  document.getElementById('backToEditorBtn').addEventListener('click', ()=>{
    document.getElementById('editorTop')?.scrollIntoView({behavior:'smooth', block:'start'});
  });

  // íˆ¬ìˆ˜ ê²°ê³¼ì¹©(ì‚¼ì§„/ë³¼ë„·) â†’ íƒ€ì ìë™ ë™ê¸°í™”
  document.getElementById('pitcherGroup1').addEventListener('click', ()=>{
    setTimeout(()=>syncHitterFromPitcherResult(),0);
  });
}

/* ==== helpers ==== */
const currentBatters = ()=>getLineup(offenseTeam).batters;
const currentIdx = ()=>loadLineupIdx(offenseTeam);
const setCurrentIdx = (v)=>saveLineupIdx(offenseTeam, v);
function getCurrentBatter(){
  const lu = currentBatters();
  if(lu.length===0) return null;
  const idx = currentIdx()%lu.length;
  return lu[idx]||null;
}

/* ==== UI Utils ==== */
function updateInningBadge(){
  document.getElementById('inningBadge').textContent = `${inning}íšŒ ${half} Â· ê³µê²©: ${offenseTeam}`;
}
function updateHistoryBadge(){
  const total = duelHistory.length;
  const ptrText = (historyPtr===-1) ? 'ìµœì‹ ' : `${historyPtr+1}/${total}`;
  document.getElementById('historyBadge').textContent = `íˆìŠ¤í† ë¦¬ ${total}ê±´ Â· í¬ì¸í„° ${ptrText}`;
  renderHistoryList(); // active í‘œì‹œ ê°±ì‹ 
}
function updateCurrentBatterInfo(){
  const b = getCurrentBatter();
  document.getElementById('currentBatterInfo').textContent =
    b ? `í˜„ì¬ íƒ€ì: ${b}` : 'í˜„ì¬ íƒ€ì: (ë¼ì¸ì—… ë¹„ì–´ ìˆìŒ)';
}
function setEditMode(idx){
  editIndex = idx;
  document.getElementById('editBadge').style.display = 'inline-block';
  document.getElementById('updateRecordBtn').style.display = 'inline-block';
  document.getElementById('deleteRecordBtn').style.display = 'inline-block';
  document.getElementById('cancelEditBtn').style.display = 'inline-block';
}
function exitEditMode(){
  editIndex = -1;
  document.getElementById('editBadge').style.display = 'none';
  document.getElementById('updateRecordBtn').style.display = 'none';
  document.getElementById('deleteRecordBtn').style.display = 'none';
  document.getElementById('cancelEditBtn').style.display = 'none';
}

/* ==== íˆìŠ¤í† ë¦¬ ëª©ë¡ ==== */
function timeAgo(ts){
  if(!ts) return '';
  const diff = Date.now() - ts;
  const s = Math.floor(diff/1000);
  if(s<60) return `${s}s ì „`;
  const m = Math.floor(s/60);
  if(m<60) return `${m}m ì „`;
  const h = Math.floor(m/60);
  if(h<24) return `${h}h ì „`;
  const d = Math.floor(h/24);
  return `${d}d ì „`;
}
function formatOutcome(o){
  if(!o) return '';
  const parts=[];
  if(o.hitterEvt) parts.push(`íƒ€ì ${o.hitterEvt}`);
  if(o.rbi && o.rbi>0) parts.push(`íƒ€ì  +${o.rbi}`);
  if(o.run && o.run>0) parts.push(`ë“ì  +${o.run}`);
  if(o.pitcherEvt) parts.push(`íˆ¬ìˆ˜ ${o.pitcherEvt}`);
  if(o.pitcherDecision) parts.push(o.pitcherDecision);
  if(o.pitchCount) parts.push(`íˆ¬êµ¬ìˆ˜ +${o.pitchCount}`);
  if(o.inningsDelta) parts.push(`ì´ë‹ +${o.inningsDelta}`);
  if(o.er) parts.push(`ìì±…ì  +${o.er}`);
  return parts.join(' Â· ');
}
/** filter: 'all' | 'current' */
function renderHistoryList(filterVal){
  const listEl = document.getElementById('historyList');
  const countEl = document.getElementById('historyCountLabel');
  if(!listEl) return;
  const f = filterVal || document.getElementById('historyFilter')?.value || 'all';

  let items = duelHistory.map((r,idx)=>({r, idx})).reverse(); // ìµœì‹  ìœ„
  if(f==='current'){
    items = items.filter(x => x.r.inning===inning && x.r.half===half);
  }

  countEl.textContent = `(${items.length}ê±´)`;

  if(items.length===0){
    listEl.innerHTML = `<div class="muted" style="padding:10px 12px;">í‘œì‹œí•  íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }

  const activeIdx = (historyPtr===-1) ? -1 : historyPtr;
  listEl.innerHTML = items.map(({r, idx})=>{
    const title = `${r.inning}íšŒ ${r.half} Â· ${r.offenseTeam} ê³µê²©`;
    const sub   = `${r.hitterName}  vs  ${r.pitcherName}`;
    const res   = formatOutcome(r.outcome);
    const isActive = (activeIdx===idx);
    return `
      <div class="history-item ${isActive?'active':''}" data-idx="${idx}" title="í´ë¦­í•˜ì—¬ ë¶ˆëŸ¬ì˜¤ê¸°">
        <span class="tag">${timeAgo(r.ts)||'â€”'}</span>
        <div class="hist-main">
          <div class="hist-title">${title}</div>
          <div class="hist-sub">${sub}</div>
          <div class="hist-sub">${res || ''}</div>
        </div>
      </div>
    `;
  }).join('');
}

// ëª©ë¡ í´ë¦­ -> í•´ë‹¹ ê¸°ë¡ ë¡œë“œ + í¸ì§‘ ëª¨ë“œ + UIì— ê°’ ë°˜ì˜
document.addEventListener('click', (e)=>{
  const it = e.target.closest('.history-item');
  if(!it) return;
  const idx = parseInt(it.dataset.idx, 10);
  if(isNaN(idx)) return;
  historyPtr = idx;
  const rec = duelHistory[idx];
  loadFromHistory(rec);
  applyOutcomeToUI(rec.outcome);
  setEditMode(idx);
  updateHistoryBadge();
  syncSearchInputs();
});

/* ==== ì„ ê³µ/ì´ˆê¸°í™” ==== */
function setFirstTeam(team, persist=true){
  offenseTeam = team;
  defenseTeam = (team==='Leaders')?'CSIA':'Leaders';
  if(persist) localStorage.setItem(FIRST_TEAM_KEY, team);
  saveGameState();
  updateInningBadge();
  updateCurrentBatterInfo();
  ensureAutoPitcher();
  syncSearchInputs();
}
document.getElementById('applyFirstTeamBtn').addEventListener('click', ()=>{
  const team = document.getElementById('firstTeamSel').value;
  setFirstTeam(team, true);
  alert(`ì„ ê³µ íŒ€ì„ ${team}ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.`);
});
document.getElementById('resetInningBtn').addEventListener('click', ()=>{
  inning = 1; half='ì´ˆ';
  const first = document.getElementById('firstTeamSel').value;
  setFirstTeam(first, true);
  saveGameState();
  updateInningBadge();
  updateCurrentBatterInfo();
  alert('ì´ë‹ì´ 1íšŒ ì´ˆë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
});

/* === íˆ¬ìˆ˜ ì—ë””í„° ì—…ë°ì´íŠ¸ ìœ í‹¸ === */
function updatePitcherEditorByName(name, team){
  if(!name) return false;
  let p = players.find(x=>x.type==='íˆ¬ìˆ˜' && x.name===name && x.team===team);
  if(!p) p = players.find(x=>x.type==='íˆ¬ìˆ˜' && x.name===name);
  if(!p) return false;

  const pitcherEdit=document.getElementById('pitcherEditSection');
  pitcherEdit.style.display='block';
  renderPitcherEditor(p);
  document.getElementById('pitcherNameDisplay').textContent = `${p.name} (${p.team})`;
  document.getElementById('pitcherSearch').value = p.name;
  return true;
}

/* === íˆ¬/íƒ€ ê²€ìƒ‰ì¹¸ ìë™ ë™ê¸°í™” & ìˆ˜ë¹„íŒ€ íˆ¬ìˆ˜ ìë™ ë°˜ì˜ === */
function applyPitcherFromDefenseLineup(){
  const { pitcher } = getLineup(defenseTeam);
  if(!pitcher) return false;
  return updatePitcherEditorByName(pitcher, defenseTeam);
}
function ensureAutoPitcher(){
  if(applyPitcherFromDefenseLineup()) return;
  const cand = players.find(p=>p.type==='íˆ¬ìˆ˜' && p.team===defenseTeam);
  if(!cand) return;
  updatePitcherEditorByName(cand.name, defenseTeam);
}
function syncSearchInputs(){
  const curBatter = getCurrentBatter();
  if(curBatter) document.getElementById('hitterSearch').value = curBatter;
  const pName = (document.getElementById('pitcherNameDisplay').textContent||'').split(' (')[0].trim();
  if(pName) document.getElementById('pitcherSearch').value = pName;
}

/* ==== ì„ ìˆ˜ ì¶”ê°€ & ëª©ë¡ ==== */
const playerListDiv = document.getElementById('playerList');

document.getElementById('addPlayerForm').addEventListener('submit', e=>{
  e.preventDefault();
  const name = document.getElementById('playerName').value.trim();
  const type = document.getElementById('playerType').value;
  const team = document.getElementById('playerTeam').value;
  if(!name || !team) return alert('ëª¨ë“  ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.');
  if(players.some(p=>p.name===name && p.type===type)) return alert('ì´ë¯¸ ë“±ë¡ëœ ì„ ìˆ˜ì…ë‹ˆë‹¤.');

  const stats = (type==='íƒ€ì')
    ? hitterStatsHeaders.reduce((a,c)=>(a[c]=0,a),{})
    : pitcherStatsHeaders.reduce((a,c)=>(a[c]=0,a),{});
  players.push({name, type, team, stats, mvpCount:0});
  savePlayers(players);
  renderPlayerList(); updateMvpSelect(); buildBothLineups();
  e.target.reset();
  ensureAutoPitcher(); syncSearchInputs();
});

playerListDiv.addEventListener('click', e=>{
  const idx = parseInt(e.target.dataset.idx);
  if (e.target.classList.contains('delete-btn')) {
    if (confirm(`${players[idx].name} ì„ ìˆ˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      ['Leaders','CSIA'].forEach(t=>{
        const obj = getLineup(t);
        obj.batters = obj.batters.filter(n=>n!==players[idx].name);
        if(obj.pitcher === players[idx].name) obj.pitcher = '';
        saveLineup(t, obj);
      });
      players.splice(idx,1);
      savePlayers(players);
      renderPlayerList(); buildBothLineups(); updateMvpSelect();
      ensureAutoPitcher(); syncSearchInputs();
    }
  } else if (e.target.classList.contains('stat-btn')) {
    const stat = e.target.dataset.stat;
    const delta = parseInt(e.target.dataset.delta);
    if (stat === 'mvpCount') {
      const newVal = (players[idx].mvpCount || 0) + delta;
      if (newVal < 0) return;
      players[idx].mvpCount = newVal;
    } else {
      const newVal = (players[idx].stats[stat] || 0) + delta;
      if (newVal < 0) return;
      players[idx].stats[stat] = newVal;
    }
    savePlayers(players);
    renderPlayerList();
  }
});

function containerIdFor(name, type){
  return `player-card-${type}-${encodeURIComponent(name)}`;
}

function renderPlayerList(){
  playerListDiv.innerHTML = '';
  if(players.length===0){
    playerListDiv.textContent = 'ë“±ë¡ëœ ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.';
    return;
  }
  players.forEach((player, idx)=>{
    const container = document.createElement('div');
    container.id = containerIdFor(player.name, player.type);
    const keys = Object.keys(player.stats);
    let html = `<h3>${player.name} (${player.team} / ${player.type}) <button class="delete-btn" data-idx="${idx}">ì‚­ì œ</button></h3>`;
    html += '<table><thead><tr>'+keys.map(k=>`<th>${k}</th>`).join('')+'<th>MVP íšŸìˆ˜</th></tr></thead><tbody><tr>';
    html += keys.map(k=>`
      <td class="buttons-cell">
        <button class="stat-btn" data-idx="${idx}" data-stat="${k}" data-delta="1">â–²</button>
        <button class="stat-btn" data-idx="${idx}" data-stat="${k}" data-delta="-1">â–¼</button>
      </td>`).join('');
    html += `
      <td class="buttons-cell">
        <button class="stat-btn" data-idx="${idx}" data-stat="mvpCount" data-delta="1">â–²</button>
        <button class="stat-btn" data-idx="${idx}" data-stat="mvpCount" data-delta="-1">â–¼</button>
      </td>
    </tr><tr>`;
    html += keys.map(k=>`<td>${player.stats[k]}</td>`).join('');
    html += `<td>${player.mvpCount||0}</td></tr></tbody></table>`;
    container.innerHTML = html;
    playerListDiv.appendChild(container);
  });
}

/* ==== MVP ==== */
function updateMvpSelect(){
  const sel = document.getElementById('mvpSelect');
  sel.innerHTML = '<option value="" disabled selected>ì„ ìˆ˜ ì„ íƒ</option>';
  players.forEach((p,i)=>{
    const opt = document.createElement('option');
    opt.value=i; opt.textContent=`${p.name} (${p.team} / ${p.type})`;
    sel.appendChild(opt);
  });
}
document.getElementById('selectMvpBtn').addEventListener('click', ()=>{
  const sel=document.getElementById('mvpSelect');
  const idx=sel.value;
  if(idx===''||idx==null) return alert('ì„ ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
  players[idx].mvpCount=(players[idx].mvpCount||0)+1;
  savePlayers(players);
  document.getElementById('mvpMessage').textContent=`${players[idx].name} ì„ ìˆ˜ë¥¼ MVPë¡œ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤. (ëˆ„ì  ${players[idx].mvpCount})`;
  renderPlayerList();
});
document.getElementById('exportJsonBtn').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(players,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='players.json';
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
});
document.getElementById('importJsonBtn').addEventListener('click', async ()=>{
  const file = document.getElementById('importJsonFile').files?.[0];
  if(!file) return alert('JSON íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
  try{
    const data = JSON.parse(await file.text());
    if(!Array.isArray(data)) throw new Error('í˜•ì‹ ì˜¤ë¥˜');
    players=data; savePlayers(players);
    renderPlayerList(); updateMvpSelect(); buildBothLineups();
    ensureAutoPitcher(); syncSearchInputs();
    alert('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ');
  }catch(e){ alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+e.message); }
});

/* ==== ì¹© ìœ í‹¸ ==== */
function renderChipGroup(rootEl, options){
  rootEl.innerHTML = '';
  options.forEach(opt=>{
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.textContent = opt;
    chip.dataset.value = opt;
    chip.addEventListener('click', ()=>{
      if(chip.classList.contains('selected')){
        chip.classList.remove('selected');
        return;
      }
      [...rootEl.querySelectorAll('.chip')].forEach(c=>c.classList.remove('selected'));
      chip.classList.add('selected');
    });
    rootEl.appendChild(chip);
  });
}
function getSelectedValue(rootEl){
  const sel = rootEl.querySelector('.chip.selected');
  return sel ? sel.dataset.value : '';
}
function selectChipByValue(rootEl, value){
  if(!rootEl) return;
  [...rootEl.querySelectorAll('.chip')].forEach(c=>c.classList.remove('selected'));
  if(!value) return;
  const el = rootEl.querySelector(`.chip[data-value="${value}"]`);
  if(el) el.classList.add('selected');
}
function clearChipSelection(rootEl){
  rootEl && [...rootEl.querySelectorAll('.chip')].forEach(c=>c.classList.remove('selected'));
}
function syncHitterFromPitcherResult(val){
  const v = val || getSelectedValue(document.getElementById('pitcherGroup1'));
  if(v==='ì‚¼ì§„' || v==='ë³¼ë„·'){
    selectChipByValue(document.getElementById('hitterGroup'), v);
  }
}

/* ==== ì»¤ìŠ¤í…€ ìŠ¤í”¼ë„ˆ ==== */
document.addEventListener('click',(e)=>{
  const btn = e.target.closest('.spin-btn');
  if(!btn) return;
  const id = btn.dataset.target;
  const input = document.getElementById(id);
  const step = parseFloat(input.step||'1');
  const cur = parseFloat(input.value||'0')||0;
  const next = (btn.dataset.spin==='inc') ? cur+step : Math.max(0,cur-step);
  input.value = (step<1?next.toFixed(1):next.toFixed(0));
  input.dispatchEvent(new Event('change'));
});

/* ==== íˆ¬ìˆ˜/íƒ€ì ì—ë””í„° ==== */
function findPlayer(name,type){ return players.find(p=>p.name===name && p.type===type); }
function renderPitcherEditor(pitcher){
  document.getElementById('pitcherNameDisplay').textContent = `${pitcher.name} (${pitcher.team})`;
  renderChipGroup(document.getElementById('pitcherGroup1'), ['ì‚¼ì§„','ë³¼ë„·','í”¼ì•ˆíƒ€','í”¼í™ˆëŸ°','ì‚¬êµ¬']);
  renderChipGroup(document.getElementById('pitcherGroup2'), ['ìŠ¹ë¦¬','íŒ¨ë°°','í™€ë“œ','ì„¸ì´ë¸Œ']);
  document.getElementById('pitcherPitchCountInput').value = 0;
  document.getElementById('pitcherInningsInput').value = 0;
  document.getElementById('pitcherERInput').value = 0;
}
function renderHitterEditor(hitter){
  document.getElementById('hitterNameDisplay').textContent = `${hitter.name} (${hitter.team})`;
  renderChipGroup(document.getElementById('hitterGroup'),
    ['1ë£¨íƒ€','2ë£¨íƒ€','3ë£¨íƒ€','í™ˆëŸ°','ì‚¼ì§„','ë³¼ë„·','í¬ìƒí”Œë¼ì´','ë‚´ì•¼ë•…ë³¼','í”Œë¼ì´ì•„ì›ƒ']);
  document.getElementById('hitterRBIInput').value = 0;
  document.getElementById('hitterRUNInput').value = 0;
}

/* ==== ê²€ìƒ‰/ì„ íƒ ==== */
function setupSearchAndEdit(){
  const pitcherInput=document.getElementById('pitcherSearch');
  const hitterInput =document.getElementById('hitterSearch');
  const pitcherResults=document.getElementById('pitcherSearchResults');
  const hitterResults =document.getElementById('hitterSearchResults');
  const pitcherEdit=document.getElementById('pitcherEditSection');
  const hitterEdit =document.getElementById('hitterEditSection');

  function renderList(inputEl, resultsEl, type){
    const kw=inputEl.value.trim().toLowerCase();
    const list=players.filter(p=>p.type===type && p.name.toLowerCase().includes(kw));
    resultsEl.innerHTML=list.map(p=>`<div data-name="${p.name}">${p.name} (${p.team})</div>`).join('');
    resultsEl.style.display=list.length?'block':'none';
  }
  pitcherInput.addEventListener('input',()=>renderList(pitcherInput,pitcherResults,'íˆ¬ìˆ˜'));
  hitterInput .addEventListener('input',()=>renderList(hitterInput ,hitterResults ,'íƒ€ì'));

  pitcherResults.addEventListener('click',(e)=>{
    if(e.target.matches('div[data-name]')){
      const name=e.target.getAttribute('data-name');
      const p=findPlayer(name,'íˆ¬ìˆ˜'); if(!p) return;
      pitcherEdit.style.display='block';
      renderPitcherEditor(p);
      pitcherResults.style.display='none';
      if(p.team===defenseTeam){ const obj=getLineup(p.team); obj.pitcher=p.name; saveLineup(p.team,obj); }
      syncSearchInputs();
    }
  });
  hitterResults.addEventListener('click',(e)=>{
    if(e.target.matches('div[data-name]')){
      const name=e.target.getAttribute('data-name');
      const h=findPlayer(name,'íƒ€ì'); if(!h) return;
      hitterEdit.style.display='block';
      renderHitterEditor(h);
      hitterResults.style.display='none';
      const lu=currentBatters(); const i=lu.indexOf(name);
      if(i>=0){ setCurrentIdx(i); updateCurrentBatterInfo(); }
      syncSearchInputs();
    }
  });
}

/* ==== ë¼ì¸ì—…(ì–‘ìª½) ==== */
function buildBothLineups(){
  buildLineupEditor('Leaders', 'lineupEditorLeaders');
  buildLineupEditor('CSIA', 'lineupEditorCSIA');
}
function buildLineupEditor(team, mountId){
  const root=document.getElementById(mountId);
  const obj = getLineup(team);
  const batters = players.filter(p=>p.type==='íƒ€ì' && p.team===team).map(p=>p.name);
  const pitchers = players.filter(p=>p.type==='íˆ¬ìˆ˜' && p.team===team).map(p=>p.name);

  const dlB = `dl_b_${team}`;
  const dlP = `dl_p_${team}`;
  const dls = `
    <datalist id="${dlB}">${batters.map(n=>`<option value="${n}">`).join('')}</datalist>
    <datalist id="${dlP}">${pitchers.map(n=>`<option value="${n}">`).join('')}</datalist>
  `;

  let html = `
    ${dls}
    <table class="lineup-table">
      <thead><tr><th style="width:60px;">íƒ€ìˆœ</th><th>ì„±ëª…</th></tr></thead>
      <tbody>
        ${Array.from({length:9}).map((_,i)=>`
          <tr>
            <td>${i+1}</td>
            <td><input list="${dlB}" data-team="${team}" data-idx="${i}" class="lu-input" placeholder="ì´ë¦„ ì…ë ¥" value="${obj.batters[i]||''}"></td>
          </tr>
        `).join('')}
        <tr>
          <th>P</th>
          <td><input list="${dlP}" data-team="${team}" class="lu-pitcher" placeholder="íˆ¬ìˆ˜ ì´ë¦„" value="${obj.pitcher||''}"></td>
        </tr>
      </tbody>
    </table>
  `;
  root.innerHTML = html;

  root.querySelectorAll('.lu-input').forEach(inp=>{
    inp.addEventListener('change',()=>{
      const t=inp.dataset.team;
      const o=getLineup(t);
      const idx=parseInt(inp.dataset.idx,10);
      o.batters[idx]=inp.value.trim();
      if(!o.batters[idx]) o.batters.splice(idx,1);
      saveLineup(t, o);
      if(t===offenseTeam) updateCurrentBatterInfo();
      syncSearchInputs();
    });
  });

  const pitcherField = root.querySelector('.lu-pitcher');
  function handlePitcherField(){
    const t=pitcherField.dataset.team;
    const o=getLineup(t);
    o.pitcher = pitcherField.value.trim();
    saveLineup(t, o);
    if(t===defenseTeam){
      if(!updatePitcherEditorByName(o.pitcher, t)){
        applyPitcherFromDefenseLineup();
      }
      syncSearchInputs();
    }
  }
  pitcherField.addEventListener('change', handlePitcherField);
  pitcherField.addEventListener('input',  handlePitcherField); // datalist ì„ íƒ ì¦‰ì‹œ ë°˜ì˜
}

/* ==== ë¼ì¸ì—… ì§„í–‰ ì»¨íŠ¸ë¡¤ ==== */
document.getElementById('startLineupBtn').addEventListener('click', ()=>{
  const lu=currentBatters();
  if(lu.length===0) return alert('í˜„ì¬ ê³µê²© íŒ€ì˜ ë¼ì¸ì—…ì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.');
  saveLineupIdx(offenseTeam, 0);
  updateCurrentBatterInfo();

  const hitter = findPlayer(lu[0],'íƒ€ì');
  if(hitter){
    const ec=document.getElementById('hitterEditSection');
    ec.style.display='block';
    renderHitterEditor(hitter);
  }
  ensureAutoPitcher();
  syncSearchInputs();
});
document.getElementById('nextBatterBtn').addEventListener('click', ()=>{
  const lu=currentBatters();
  if(lu.length===0) return alert('ë¼ì¸ì—…ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
  const idx=(currentIdx()+1)%lu.length;
  setCurrentIdx(idx);
  updateCurrentBatterInfo();
  const hitter=findPlayer(lu[idx],'íƒ€ì');
  if(hitter){
    const ec=document.getElementById('hitterEditSection');
    ec.style.display='block';
    renderHitterEditor(hitter);
  }
  ensureAutoPitcher();
  syncSearchInputs();
});
document.getElementById('prevBatterBtn').addEventListener('click', ()=>{
  const list = duelHistory.filter(r=>true);
  if(list.length===0) return alert('ì´ì „ íƒ€ì ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
  if(historyPtr===-1) historyPtr = list.length;
  historyPtr = Math.max(0, historyPtr-1);
  loadFromHistory(list[historyPtr]);
  applyOutcomeToUI(list[historyPtr].outcome);
  setEditMode(historyPtr);
  updateHistoryBadge();
  syncSearchInputs();
});

/* ==== íˆìŠ¤í† ë¦¬ ë¡œë“œ ==== */
function loadFromHistory(rec){
  const p=findPlayer(rec.pitcherName,'íˆ¬ìˆ˜');
  if(p){
    const ec=document.getElementById('pitcherEditSection');
    ec.style.display='block';
    renderPitcherEditor(p);
    document.getElementById('pitcherNameDisplay').textContent = `${p.name} (${p.team})`;
    document.getElementById('pitcherSearch').value=p.name;
  }
  const h=findPlayer(rec.hitterName,'íƒ€ì');
  if(h){
    const ec=document.getElementById('hitterEditSection');
    ec.style.display='block';
    renderHitterEditor(h);
    document.getElementById('hitterNameDisplay').textContent = `${h.name} (${h.team})`;
    document.getElementById('hitterSearch').value=h.name;
    if(rec.offenseTeam===offenseTeam){
      const lu=currentBatters();
      const li=lu.indexOf(h.name);
      if(li>=0){ setCurrentIdx(li); updateCurrentBatterInfo(); }
    }
  }
}
function applyOutcomeToUI(outcome){
  if(!outcome) return;
  // ìˆ«ì ì…ë ¥
  document.getElementById('pitcherPitchCountInput').value = outcome.pitchCount || 0;
  document.getElementById('pitcherInningsInput').value   = outcome.inningsDelta || 0;
  document.getElementById('pitcherERInput').value        = outcome.er || 0;
  document.getElementById('hitterRBIInput').value        = outcome.rbi || 0;
  document.getElementById('hitterRUNInput').value        = outcome.run || 0;
  // ì¹© ì„ íƒ
  selectChipByValue(document.getElementById('pitcherGroup1'), outcome.pitcherEvt||'');
  selectChipByValue(document.getElementById('pitcherGroup2'), outcome.pitcherDecision||'');
  selectChipByValue(document.getElementById('hitterGroup'),   outcome.hitterEvt||'');
  // ì‚¼ì§„/ë³¼ë„· ìë™ ë™ê¸°í™”
  syncHitterFromPitcherResult(outcome.pitcherEvt);
}
document.getElementById('historyBackBtn').addEventListener('click', ()=>{
  if(duelHistory.length===0) return alert('íˆìŠ¤í† ë¦¬ ì—†ìŒ');
  if(historyPtr===-1) historyPtr = duelHistory.length-1;
  else historyPtr = Math.max(0, historyPtr-1);
  const rec = duelHistory[historyPtr];
  loadFromHistory(rec);
  applyOutcomeToUI(rec.outcome);
  setEditMode(historyPtr);
  updateHistoryBadge(); syncSearchInputs();
});
document.getElementById('historyForwardBtn').addEventListener('click', ()=>{
  if(duelHistory.length===0) return alert('íˆìŠ¤í† ë¦¬ ì—†ìŒ');
  if(historyPtr===-1) return;
  historyPtr++;
  if(historyPtr>=duelHistory.length){ historyPtr=-1; exitEditMode(); updateHistoryBadge(); syncSearchInputs(); return; }
  const rec = duelHistory[historyPtr];
  loadFromHistory(rec);
  applyOutcomeToUI(rec.outcome);
  setEditMode(historyPtr);
  updateHistoryBadge(); syncSearchInputs();
});

/* ==== í†µê³„ ë°˜ì˜/ë˜ëŒë¦¬ê¸° ==== */
function applyOutcomeToStats(pitcherName, hitterName, outcome, sign){
  if(!outcome) return;
  const p = findPlayer(pitcherName, 'íˆ¬ìˆ˜');
  const h = findPlayer(hitterName, 'íƒ€ì');
  const s = (v)=>sign*(v||0);

  if(p){
    p.stats['íˆ¬êµ¬ìˆ˜'] = (p.stats['íˆ¬êµ¬ìˆ˜']||0) + s(outcome.pitchCount);
    p.stats['ì´ë‹']   = (p.stats['ì´ë‹']  ||0) + s(outcome.inningsDelta);
    p.stats['ìì±…ì '] = (p.stats['ìì±…ì ']||0) + s(outcome.er);
    if(outcome.pitcherEvt){ p.stats[outcome.pitcherEvt] = (p.stats[outcome.pitcherEvt]||0) + s(1); }
    if(outcome.pitcherDecision){ p.stats[outcome.pitcherDecision] = (p.stats[outcome.pitcherDecision]||0) + s(1); }
  }
  if(h){
    if(outcome.hitterEvt){ h.stats[outcome.hitterEvt] = (h.stats[outcome.hitterEvt]||0) + s(1); }
    if(outcome.rbi){ h.stats['íƒ€ì '] = (h.stats['íƒ€ì ']||0) + s(outcome.rbi); }
    if(outcome.run){ h.stats['ë“ì '] = (h.stats['ë“ì ']||0) + s(outcome.run); }
  }
}

/* ==== í¸ì§‘: ì €ì¥/ì‚­ì œ ==== */
function readCurrentOutcomeFromUI(){
  const pitchCountDelta = Math.max(0, parseFloat(document.getElementById('pitcherPitchCountInput').value)||0);
  const inningsDelta    = Math.max(0, parseFloat(document.getElementById('pitcherInningsInput').value)||0);
  const erDelta         = Math.max(0, parseInt(document.getElementById('pitcherERInput').value)||0);
  const g1 = getSelectedValue(document.getElementById('pitcherGroup1'));
  const g2 = getSelectedValue(document.getElementById('pitcherGroup2'));
  const hitterEvt = getSelectedValue(document.getElementById('hitterGroup'));
  const rbiDelta  = Math.max(0, parseInt(document.getElementById('hitterRBIInput').value)||0);
  const runDelta  = Math.max(0, parseInt(document.getElementById('hitterRUNInput').value)||0);

  return {
    hitterEvt: hitterEvt || '',
    rbi: rbiDelta || 0,
    run: runDelta || 0,
    pitcherEvt: g1 || '',
    pitcherDecision: g2 || '',
    pitchCount: pitchCountDelta || 0,
    inningsDelta: inningsDelta || 0,
    er: erDelta || 0
  };
}

function onUpdateRecord(){
  if(editIndex<0){ alert('í¸ì§‘í•  íˆìŠ¤í† ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }
  const old = duelHistory[editIndex];

  // ë¡¤ë°±(ê¸°ì¡´ ì¦ë¶„ ì œê±°)
  applyOutcomeToStats(old.pitcherName, old.hitterName, old.outcome, -1);

  // í˜„ì¬ UI ê°’ ì½ê¸° (ì´ë¦„ë„ ë³€ê²½ ê°€ëŠ¥)
  const defLu = getLineup(defenseTeam);
  let pitcherName = defLu.pitcher || (document.getElementById('pitcherNameDisplay').textContent||'').split(' (')[0].trim();
  let hitterName  = (document.getElementById('hitterNameDisplay').textContent||'').split(' (')[0].trim();
  if(!pitcherName) pitcherName = old.pitcherName;
  if(!hitterName)  hitterName  = old.hitterName;

  const newOutcome = readCurrentOutcomeFromUI();

  // ì ìš©
  applyOutcomeToStats(pitcherName, hitterName, newOutcome, +1);
  savePlayers(players);

  // íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
  duelHistory[editIndex] = {
    ...old,
    pitcherName,
    hitterName,
    outcome: newOutcome,
    ts: Date.now()
  };
  saveHistory();

  renderPlayerList();
  updateHistoryBadge();
  alert('ê¸°ë¡ì„ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.');
}

function onDeleteRecord(){
  if(editIndex<0){ alert('ì‚­ì œí•  íˆìŠ¤í† ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }
  if(!confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”? ì„ ìˆ˜ í†µê³„ëŠ” ìë™ìœ¼ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.')) return;

  const old = duelHistory[editIndex];
  // ë¡¤ë°±
  applyOutcomeToStats(old.pitcherName, old.hitterName, old.outcome, -1);
  savePlayers(players);

  // ì œê±°
  duelHistory.splice(editIndex,1);
  saveHistory();

  // ìƒíƒœ ì •ë¦¬
  historyPtr = -1;
  exitEditMode();

  renderPlayerList();
  updateHistoryBadge();
  alert('ê¸°ë¡ì„ ì‚­ì œí•˜ê³  í†µê³„ë¥¼ ë˜ëŒë ¸ìŠµë‹ˆë‹¤.');
}

/* ==== ëŒ€ê²° ì €ì¥ (ì¦ë¶„ ë°˜ì˜) ==== */
document.getElementById('saveDuelBtn').addEventListener('click', ()=>{
  if(editIndex!==-1){
    alert('í¸ì§‘ ëª¨ë“œì—ì„œëŠ” "ê¸°ë¡ ìˆ˜ì • ì €ì¥" ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì„¸ìš”.');
    return;
  }

  const defLu = getLineup(defenseTeam);
  let pitcherName = defLu.pitcher || (document.getElementById('pitcherNameDisplay').textContent||'').split(' (')[0].trim();

  let hitterName = (document.getElementById('hitterNameDisplay').textContent||'').split(' (')[0].trim();
  const lu=currentBatters();
  if(lu.length>0){
    const idx=currentIdx()%lu.length;
    hitterName = lu[idx] || hitterName;
  }
  if(!pitcherName) return alert('íˆ¬ìˆ˜ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ë¼ì¸ì—…ì— íˆ¬ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
  if(!hitterName) return alert('íƒ€ìë¥¼ ì„ íƒí•˜ê±°ë‚˜ ë¼ì¸ì—…ì„ ì‹œì‘í•˜ì„¸ìš”.');

  const pitcher = findPlayer(pitcherName,'íˆ¬ìˆ˜');
  const hitter  = findPlayer(hitterName ,'íƒ€ì');
  if(!pitcher || !hitter) return alert('ì„ ìˆ˜ ë°ì´í„° ì˜¤ë¥˜ì…ë‹ˆë‹¤.');

  const outcome = readCurrentOutcomeFromUI();

  // í†µê³„ ë°˜ì˜
  applyOutcomeToStats(pitcherName, hitterName, outcome, +1);
  savePlayers(players);

  // íˆìŠ¤í† ë¦¬ ì¶•ì 
  duelHistory.push({pitcherName,hitterName,offenseTeam,defenseTeam,inning,half,ts:Date.now(), outcome});
  saveHistory();
  historyPtr=-1;
  updateHistoryBadge(); // ëª©ë¡ ê°±ì‹  í¬í•¨

  // ë‹¤ìŒ íƒ€ì ì´ë™
  if(lu.length>0){
    setCurrentIdx((currentIdx()+1)%lu.length);
    updateCurrentBatterInfo();
    const nextH=findPlayer(getCurrentBatter(),'íƒ€ì');
    if(nextH){
      const ec=document.getElementById('hitterEditSection');
      ec.style.display='block';
      renderHitterEditor(nextH);
    }
  }
  ensureAutoPitcher(); syncSearchInputs();

  // ì…ë ¥ê°’ ë¦¬ì…‹
  document.getElementById('pitcherPitchCountInput').value = 0;
  document.getElementById('pitcherInningsInput').value = 0;
  document.getElementById('pitcherERInput').value = 0;
  clearChipSelection(document.getElementById('pitcherGroup1'));
  clearChipSelection(document.getElementById('pitcherGroup2'));
  clearChipSelection(document.getElementById('hitterGroup'));
  document.getElementById('hitterRBIInput').value = 0;
  document.getElementById('hitterRUNInput').value = 0;

  alert('ëŒ€ê²° ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ì¦ë¶„ ë°˜ì˜ ì™„ë£Œ)');
  renderPlayerList();
});

/* ì´ë¦„ í´ë¦­ â†’ ë“±ë¡ ì„ ìˆ˜ ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤ */
function scrollToPlayerFromDisplay(type){
  const id = (type==='íˆ¬ìˆ˜'?'pitcherNameDisplay':'hitterNameDisplay');
  const txt = (document.getElementById(id).textContent||'').split(' (')[0].trim();
  if(!txt) return;
  const card = document.getElementById(containerIdFor(txt, type));
  if(card){
    card.scrollIntoView({behavior:'smooth', block:'center'});
    card.classList.add('highlight');
    setTimeout(()=>card.classList.remove('highlight'), 2000);
  }else{
    document.getElementById('playerListSection')?.scrollIntoView({behavior:'smooth'});
  }
}

/* ==== ì´ë‹ ì¢…ë£Œ & ì´ì „/ë‹¤ìŒ ì´ë‹ ë³´ê¸° ==== */
document.getElementById('endHalfBtn').addEventListener('click', ()=>{
  [offenseTeam, defenseTeam] = [defenseTeam, offenseTeam];
  if(half==='ì´ˆ'){ half='ë§'; } else { half='ì´ˆ'; inning += 1; }
  saveGameState();
  updateInningBadge();
  updateCurrentBatterInfo();
  ensureAutoPitcher();
  syncSearchInputs();
  alert(`ì´ë‹ ì „í™˜: ${inning}íšŒ ${half} Â· ê³µê²© ${offenseTeam}`);
  renderHistoryList();
});
document.getElementById('prevInningBtn').addEventListener('click', ()=>{
  if(viewHalf==='ë§'){ viewHalf='ì´ˆ'; viewInning = Math.max(1, viewInning-1); }
  else { if(viewInning>1){ viewHalf='ë§'; viewInning-=1; } }
  jumpToLastPAOf(viewInning, viewHalf);
});
document.getElementById('nextInningBtn').addEventListener('click', ()=>{
  if(viewHalf==='ì´ˆ'){ viewHalf='ë§'; }
  else { viewHalf='ì´ˆ'; viewInning += 1; }
  jumpToLastPAOf(viewInning, viewHalf);
});
function jumpToLastPAOf(inn, hf){
  const list = duelHistory.filter(r=>r.inning===inn && r.half===hf);
  if(list.length===0){ alert(`${inn}íšŒ ${hf} ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.`); updateHistoryBadge(); return; }
  const rec = list[list.length-1];
  loadFromHistory(rec);
  applyOutcomeToUI(rec.outcome);
  const idx = duelHistory.indexOf(rec);
  if(idx>=0){ historyPtr = idx; setEditMode(idx); updateHistoryBadge(); }
  syncSearchInputs();
  alert(`${inn}íšŒ ${hf} ë§ˆì§€ë§‰ íƒ€ì„ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
}

/* ==== ì‹œì‘ ==== */
init();
</script>
</body>
</html>

