<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>야구 기록 입력</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1100px;
      margin: 40px auto;
      padding: 20px 30px;
      background-color: #f9faff;
      color: #333;
      overflow-x: auto;
    }

    h1 {
      font-size: 2rem;
      font-weight: 700;
      color: #1a73e8;
      margin-bottom: 30px;
      text-align: center;
    }

    nav a {
      display: inline-block;
      padding: 10px 20px;
      margin-bottom: 30px;
      background-color: #1a73e8;
      color: white;
      font-weight: 600;
      border-radius: 6px;
      text-decoration: none;
      transition: background-color 0.3s ease;
    }
    nav a:hover { background-color: #155ab6; }

    form {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    input[type="text"], select {
      padding: 10px 12px;
      font-size: 1rem;
      border: 1.5px solid #ccc;
      border-radius: 6px;
      transition: border-color 0.3s ease;
      width: 180px;
      min-width: 150px;
    }
    input[type="text"]:focus, select:focus {
      border-color: #1a73e8;
      outline: none;
    }

    button {
      padding: 10px 20px;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      background-color: #1a73e8;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
      white-space: nowrap;
    }
    button:hover { background-color: #155ab6; }

    .player-list > div {
      background-color: white;
      border: 1px solid #ddd;
      padding: 16px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgb(26 115 232 / 0.15);
      overflow-x: auto;
      max-width: 100%;
    }
    .player-list h3 {
      font-weight: 700;
      color: #1a73e8;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .delete-btn {
      color: #e53935;
      font-size: 14px;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background-color 0.3s ease;
      background: none;
      border: none;
      cursor: pointer;
    }
    .delete-btn:hover { background-color: #e5393533; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      min-width: 900px;
    }
    th, td {
      border: 1px solid #ddd;
      text-align: center;
      font-size: 0.9rem;
      white-space: nowrap;
      padding: 8px 6px;
      vertical-align: middle;
    }
    th {
      background-color: #e8f0fe;
      color: #1a73e8;
      font-weight: 600;
      user-select: none;
    }
    td.buttons-cell { padding: 4px 6px; }

    button.stat-btn {
      width: 24px;
      height: 24px;
      font-size: 16px;
      line-height: 1;
      padding: 0;
      border-radius: 4px;
      border: 1px solid #ccc;
      background-color: #f1f3f4;
      cursor: pointer;
      margin: 0 2px;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    button.stat-btn:hover { background-color: #cde0fe; }

    .section {
      background-color: white;
      padding: 20px 25px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgb(26 115 232 / 0.1);
      overflow-x: auto;
      margin-top: 18px;
    }

    .duel-header {
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .pill {
      background:#e8f0fe; color:#1a73e8; padding:6px 12px; border-radius:999px; font-weight:700;
    }

    .duel-grid {
      display:flex; gap: 30px; flex-wrap: wrap;
    }

    #pitcherSearch, #hitterSearch {
      width: 100%;
      margin-bottom: 12px;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1.5px solid #ccc;
      font-size: 1rem;
    }
    #pitcherSearchResults div, #hitterSearchResults div {
      padding: 6px 8px;
      margin-bottom: 6px;
      background-color: #f1f3f4;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #pitcherSearchResults div:hover, #hitterSearchResults div:hover {
      background-color: #cde0fe;
    }

    #pitcherEditSection, #hitterEditSection {
      background-color: #f9fbff;
      border: 1px solid #cde0fe;
      padding: 15px 20px;
      border-radius: 8px;
      margin-top: 8px;
    }
    #pitcherNameDisplay, #hitterNameDisplay {
      font-weight: 700;
      color: #1a73e8;
    }

    .stat-row{
      display:flex; align-items:center; gap:12px; margin-bottom:10px;
    }
    .stat-row label{
      min-width:100px; font-weight:600; color:#3c4043;
    }
    .counter{
      display:flex; align-items:center; gap:10px;
    }
    .counter .big-btn{
      width:44px; height:44px; font-size:26px; font-weight:800;
      border:none; border-radius:10px; cursor:pointer;
      background:#1a73e8; color:#fff; box-shadow:0 2px 8px rgba(26,115,232,.25);
      user-select:none;
    }
    .counter .big-btn:active{ transform: translateY(1px); }
    .counter .val{
      width:90px; height:44px; text-align:center; font-size:1.1rem; font-weight:700;
      border:1.5px solid #cde0fe; border-radius:10px; background:#fff;
      pointer-events:none;
    }

    /* 라인업 용지 */
    .lineup-card{
      border:1px solid #cde0fe; border-radius:10px; padding:14px; background:#f9fbff;
    }
    .tabs{
      display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap;
    }
    .tab{
      padding:6px 12px; border-radius:999px; border:1px solid #cde0fe; background:#e8f0fe; color:#1a73e8; cursor:pointer; font-weight:700;
    }
    .tab.active{ background:#1a73e8; color:#fff; }
    .lineup-table{
      width:100%; border-collapse:collapse; min-width:420px;
    }
    .lineup-table th, .lineup-table td{
      border:1px solid #ccd7ff; padding:6px 8px; text-align:center; background:#fff;
    }
    .lineup-table th{ background:#eef3ff; color:#1a73e8; }
    .lineup-table input{
      width:100%; padding:6px 8px; border:1px solid #dde5ff; border-radius:6px;
    }
    .lineup-footer{
      display:flex; gap:8px; margin-top:10px; align-items:center; flex-wrap:wrap;
    }

    .mvp-section {
      margin-top: 24px;
      background:#f0f4ff;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .mvp-section h2 { color:#1a73e8; margin-bottom: 12px; }
    .mvp-section select {
      padding: 8px;
      border-radius: 6px;
      border: 1.5px solid #ccc;
      font-size: 1rem;
      min-width: 240px;
    }
    .mvp-section button {
      margin-left: 12px;
      padding: 8px 20px;
      background:#1a73e8;
      color:#fff;
      border:none;
      border-radius:6px;
      cursor:pointer;
      font-weight: 600;
    }
    .mvp-section button:hover { background:#155ab6; }
    .mvp-message {
      margin-top: 10px;
      font-weight: 600;
      color: #155ab6;
    }

    .muted{ color:#5f6368; font-size:0.92rem; }
  </style>
</head>
<body>
  <h1>선수 기록 입력 및 관리</h1>
  <nav>
    <a href="records.html">선수 기록 조회 페이지로 이동</a>
  </nav>

  <!-- 선수 추가 -->
  <form id="addPlayerForm">
    <input type="text" id="playerName" placeholder="선수 이름" required />
    <select id="playerType">
      <option value="타자">타자</option>
      <option value="투수">투수</option>
    </select>
    <select id="playerTeam" required>
      <option value="" disabled selected>팀 선택</option>
      <option value="Leaders">Leaders</option>
      <option value="CSIA">CSIA</option>
    </select>
    <button type="submit">선수 추가</button>
  </form>

  <!-- === 투타 대결 + 라인업 + 이닝 === -->
  <section class="section" id="duelSection">
    <div class="duel-header">
      <h2 style="margin:0;">투수-타자 대결 기록 입력</h2>
      <div>
        <span class="pill" id="inningBadge">1회 초 · 공격: Leaders</span>
        <span class="pill" id="historyBadge" style="margin-left:6px;">히스토리 0건</span>
      </div>
    </div>

    <!-- 라인업 용지 (팀별 탭) -->
    <div class="lineup-card" style="margin-bottom:14px;">
      <div class="tabs">
        <button type="button" class="tab active" data-team="Leaders">Leaders 라인업</button>
        <button type="button" class="tab" data-team="CSIA">CSIA 라인업</button>
      </div>
      <div id="lineupEditor"></div>
      <div class="lineup-footer">
        <button id="startLineupBtn" type="button">라인업 시작</button>
        <button id="prevBatterBtn" type="button">◀ 이전 타자 보기</button>
        <button id="nextBatterBtn" type="button">다음 타자 ▶</button>
        <span class="muted" id="currentBatterInfo">현재 타자: -</span>
      </div>
    </div>

    <!-- 투수/타자 편집 그리드 -->
    <div class="duel-grid">
      <!-- 투수 -->
      <div style="flex:1; min-width: 300px;">
        <h3>투수 선택 및 기록</h3>
        <input type="text" id="pitcherSearch" placeholder="투수 이름 검색" autocomplete="off" />
        <div id="pitcherSearchResults"></div>
        <div id="pitcherEditSection" style="display:none; margin-top:10px;">
          <div id="pitcherNameDisplay"></div>
          <div id="pitcherStatsContainer"></div>
        </div>
      </div>
      <!-- 타자 -->
      <div style="flex:1; min-width: 300px;">
        <h3>타자 선택 및 기록</h3>
        <input type="text" id="hitterSearch" placeholder="(단독 선택용) 타자 이름 검색" autocomplete="off" />
        <div id="hitterSearchResults"></div>
        <div id="hitterEditSection" style="display:none; margin-top:10px;">
          <div id="hitterNameDisplay"></div>
          <div id="hitterStatsContainer"></div>
        </div>
      </div>
    </div>

    <!-- 하단 툴바 -->
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
      <button id="saveDuelBtn">대결 기록 저장(자동 다음 타자)</button>
      <button id="historyBackBtn" style="background:#6c63ff;">◀ 히스토리 이전 보기</button>
      <button id="historyForwardBtn" style="background:#6c63ff;">히스토리 다음 보기 ▶</button>
      <button id="endHalfBtn" style="margin-left:auto; background:#e67e22;">이닝 종료(공수 전환)</button>
      <button id="prevInningBtn" style="background:#34a853;">◀ 이전 이닝 보기</button>
      <button id="nextInningBtn" style="background:#34a853;">다음 이닝 보기 ▶</button>
    </div>
  </section>

  <!-- 등록 선수 목록 -->
  <section class="section">
    <h2 style="margin-top:0;">등록 선수 목록</h2>
    <div class="player-list" id="playerList"></div>
  </section>

  <!-- MVP / JSON -->
  <div class="mvp-section">
    <h2>MVP 선정</h2>
    <select id="mvpSelect">
      <option value="" disabled selected>선수 선택</option>
    </select>
    <button id="selectMvpBtn">MVP 선정</button>
    <p id="mvpMessage" class="mvp-message"></p>

    <button id="exportJsonBtn" style="margin-top: 12px; background: #34a853;">JSON 파일로 내보내기</button>
    <div style="margin-top:12px;">
      <input type="file" id="importJsonFile" accept="application/json" />
      <button id="importJsonBtn" style="margin-top: 8px; background: #fbbc05;">JSON 불러오기</button>
    </div>
  </div>

  <script>
    /* ==== Storage Keys ==== */
    const STORAGE_KEY = 'playersData';
    const LINEUP_KEY_BY_TEAM = (team)=>`lineup_${team}`; // {batters:[], pitcher:""}  (구버전 배열도 자동 호환)
    const LINEUP_IDX_KEY_BY_TEAM = (team)=>`lineup_idx_${team}`;
    const HISTORY_KEY = 'duelHistory_v2';
    const GAME_STATE_KEY = 'gameState_v2';

    /* ==== Data ==== */
    let players = [];
    let activeLineupTeam = 'Leaders';  // 라인업 편집 중인 탭
    let offenseTeam = 'Leaders';       // 현재 공격 팀
    let defenseTeam = 'CSIA';
    let inning = 1;
    let half = '초';                   // '초' | '말'
    let duelHistory = [];              // {pitcherName,hitterName,offenseTeam,defenseTeam,inning,half,ts}
    let historyPtr = -1;
    let viewInning = 1;
    let viewHalf = '초';

    const hitterStatsHeaders  = ['1루타','2루타','3루타','홈런','삼진','볼넷','희생플라이','내야땅볼','플라이아웃','타점'];
    const pitcherStatsHeaders = ['투구수','삼진','볼넷','피안타','피홈런','자책점','이닝','승리','패배','홀드','세이브','사구'];

    /* ==== Storage helpers ==== */
    const savePlayers = (p)=>localStorage.setItem(STORAGE_KEY, JSON.stringify(p));
    const loadPlayers = ()=>JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

    // 라인업 저장을 새 포맷으로: {batters:[], pitcher:""}  (구버전 배열도 읽어줌)
    function getLineup(team){
      const raw = localStorage.getItem(LINEUP_KEY_BY_TEAM(team));
      if(!raw) return {batters: [], pitcher: ''};
      try{
        const parsed = JSON.parse(raw);
        if(Array.isArray(parsed)) return {batters: parsed, pitcher: ''}; // 구버전 호환
        if(parsed && typeof parsed==='object')
          return {batters: parsed.batters || [], pitcher: parsed.pitcher || ''};
      }catch(e){}
      return {batters: [], pitcher: ''};
    }
    function saveLineup(team, obj){ localStorage.setItem(LINEUP_KEY_BY_TEAM(team), JSON.stringify(obj)); }

    const saveLineupIdx = (team, idx)=>localStorage.setItem(LINEUP_IDX_KEY_BY_TEAM(team), String(idx||0));
    const loadLineupIdx = (team)=>parseInt(localStorage.getItem(LINEUP_IDX_KEY_BY_TEAM(team))||'0',10);

    const saveHistory = ()=>localStorage.setItem(HISTORY_KEY, JSON.stringify(duelHistory));
    const loadHistory = ()=>JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]');

    const saveGameState = ()=>{
      localStorage.setItem(GAME_STATE_KEY, JSON.stringify({offenseTeam, defenseTeam, inning, half}));
    };
    const loadGameState = ()=>{
      const s = JSON.parse(localStorage.getItem(GAME_STATE_KEY)||'{}');
      offenseTeam = s.offenseTeam || 'Leaders';
      defenseTeam = s.defenseTeam || 'CSIA';
      inning = s.inning || 1;
      half = s.half || '초';
    };

    /* ==== Init ==== */
    function init(){
      players = loadPlayers();
      duelHistory = loadHistory();
      loadGameState();
      renderPlayerList();
      updateMvpSelect();
      setupSearchAndEdit();
      buildLineupEditor();
      updateInningBadge();
      updateHistoryBadge();
      updateCurrentBatterInfo();
      attachLineupTabEvents();
      ensureAutoPitcher();   // 초기에도 수비팀 투수 자동선택 시도 (라인업에 있으면 우선)
      syncSearchInputs();    // 검색칸 동기화
    }

    /* ==== helpers (현재 공격팀) ==== */
    const currentBatters = ()=>getLineup(offenseTeam).batters;
    const currentIdx = ()=>loadLineupIdx(offenseTeam);
    const setCurrentIdx = (v)=>saveLineupIdx(offenseTeam, v);
    function getCurrentBatter(){
      const lu = currentBatters();
      if(lu.length===0) return null;
      const idx = currentIdx()%lu.length;
      return lu[idx]||null;
    }

    /* ==== UI Utils ==== */
    function updateInningBadge(){
      document.getElementById('inningBadge').textContent =
        `${inning}회 ${half} · 공격: ${offenseTeam}`;
    }
    function updateHistoryBadge(){
      const total = duelHistory.length;
      const ptrText = (historyPtr===-1) ? '최신' : `${historyPtr+1}/${total}`;
      document.getElementById('historyBadge').textContent = `히스토리 ${total}건 · 포인터 ${ptrText}`;
    }
    function updateCurrentBatterInfo(){
      const b = getCurrentBatter();
      document.getElementById('currentBatterInfo').textContent =
        b ? `현재 타자: ${b}` : '현재 타자: (라인업 비어 있음)';
    }

    /* === 투/타 검색칸 자동 동기화 & 수비팀 투수 자동 반영 === */
    function applyPitcherFromDefenseLineup(){
      const { pitcher } = getLineup(defenseTeam);
      if(!pitcher) return false;
      const p = players.find(x=>x.type==='투수' && x.name===pitcher && x.team===defenseTeam);
      if(!p) return false;
      const pitcherEdit=document.getElementById('pitcherEditSection');
      const pitcherNameDisplay=document.getElementById('pitcherNameDisplay');
      const pitcherStatsContainer=document.getElementById('pitcherStatsContainer');
      pitcherEdit.style.display='block';
      renderEditor(pitcherStatsContainer,pitcherNameDisplay,p,pitcherStatsHeaders);
      document.getElementById('pitcherSearch').value = p.name;
      return true;
    }
    function ensureAutoPitcher(){
      // 1) 수비팀 라인업에 투수가 지정돼 있으면 그것을 우선 사용
      if(applyPitcherFromDefenseLineup()) return;
      // 2) 없으면 수비팀 투수 중 첫 번째 자동 선택
      const cand = players.find(p=>p.type==='투수' && p.team===defenseTeam);
      if(!cand) return;
      const pitcherEdit=document.getElementById('pitcherEditSection');
      const pitcherNameDisplay=document.getElementById('pitcherNameDisplay');
      const pitcherStatsContainer=document.getElementById('pitcherStatsContainer');
      pitcherEdit.style.display='block';
      renderEditor(pitcherStatsContainer,pitcherNameDisplay,cand,pitcherStatsHeaders);
      document.getElementById('pitcherSearch').value = cand.name;
    }
    function syncSearchInputs(){
      // 타자: 현재 타자
      const curBatter = getCurrentBatter();
      if(curBatter){
        document.getElementById('hitterSearch').value = curBatter;
      }
      // 투수: 현재 선택/자동 반영된 투수명
      const pName = (document.getElementById('pitcherNameDisplay').textContent||'').split(' (')[0].trim();
      if(pName){
        document.getElementById('pitcherSearch').value = pName;
      }
    }

    /* ==== 선수 추가 & 목록 ==== */
    const playerListDiv = document.getElementById('playerList');

    document.getElementById('addPlayerForm').addEventListener('submit', e=>{
      e.preventDefault();
      const name = document.getElementById('playerName').value.trim();
      const type = document.getElementById('playerType').value;
      const team = document.getElementById('playerTeam').value;
      if(!name || !team) return alert('모든 값을 입력하세요.');
      if(players.some(p=>p.name===name && p.type===type)) return alert('이미 등록된 선수입니다.');

      const stats = (type==='타자')
        ? hitterStatsHeaders.reduce((a,c)=>(a[c]=0,a),{})
        : pitcherStatsHeaders.reduce((a,c)=>(a[c]=0,a),{});
      players.push({name, type, team, stats, mvpCount:0});
      savePlayers(players);
      renderPlayerList();
      updateMvpSelect();
      buildLineupEditor();
      e.target.reset();
      ensureAutoPitcher();
      syncSearchInputs();
    });

    playerListDiv.addEventListener('click', e=>{
      const idx = parseInt(e.target.dataset.idx);
      if (e.target.classList.contains('delete-btn')) {
        if (confirm(`${players[idx].name} 선수를 삭제하시겠습니까?`)) {
          // 양 팀 라인업에서 제거/초기화
          ['Leaders','CSIA'].forEach(t=>{
            const obj = getLineup(t);
            obj.batters = obj.batters.filter(n=>n!==players[idx].name);
            if(obj.pitcher === players[idx].name) obj.pitcher = '';
            saveLineup(t, obj);
          });
          players.splice(idx,1);
          savePlayers(players);
          renderPlayerList();
          buildLineupEditor();
          updateMvpSelect();
          ensureAutoPitcher();
          syncSearchInputs();
        }
      } else if (e.target.classList.contains('stat-btn')) {
        const stat = e.target.dataset.stat;
        const delta = parseInt(e.target.dataset.delta);
        if (stat === 'mvpCount') {
          const newVal = (players[idx].mvpCount || 0) + delta;
          if (newVal < 0) return;
          players[idx].mvpCount = newVal;
        } else {
          const newVal = (players[idx].stats[stat] || 0) + delta;
          if (newVal < 0) return;
          players[idx].stats[stat] = newVal;
        }
        savePlayers(players);
        renderPlayerList();
      }
    });

    function renderPlayerList(){
      playerListDiv.innerHTML = '';
      if(players.length===0){
        playerListDiv.textContent = '등록된 선수가 없습니다.';
        return;
      }
      players.forEach((player, idx)=>{
        const container = document.createElement('div');
        const keys = Object.keys(player.stats);
        let html = `<h3>${player.name} (${player.team} / ${player.type}) <button class="delete-btn" data-idx="${idx}">삭제</button></h3>`;
        html += '<table><thead><tr>'+keys.map(k=>`<th>${k}</th>`).join('')+'<th>MVP 횟수</th></tr></thead><tbody><tr>';
        html += keys.map(k=>`
          <td class="buttons-cell">
            <button class="stat-btn" data-idx="${idx}" data-stat="${k}" data-delta="1">▲</button>
            <button class="stat-btn" data-idx="${idx}" data-stat="${k}" data-delta="-1">▼</button>
          </td>`).join('');
        html += `
          <td class="buttons-cell">
            <button class="stat-btn" data-idx="${idx}" data-stat="mvpCount" data-delta="1">▲</button>
            <button class="stat-btn" data-idx="${idx}" data-stat="mvpCount" data-delta="-1">▼</button>
          </td>
        </tr><tr>`;
        html += keys.map(k=>`<td>${player.stats[k]}</td>`).join('');
        html += `<td>${player.mvpCount||0}</td></tr></tbody></table>`;
        container.innerHTML = html;
        playerListDiv.appendChild(container);
      });
    }

    /* ==== MVP ==== */
    function updateMvpSelect(){
      const sel = document.getElementById('mvpSelect');
      sel.innerHTML = '<option value="" disabled selected>선수 선택</option>';
      players.forEach((p,i)=>{
        const opt = document.createElement('option');
        opt.value=i; opt.textContent=`${p.name} (${p.team} / ${p.type})`;
        sel.appendChild(opt);
      });
    }
    document.getElementById('selectMvpBtn').addEventListener('click', ()=>{
      const sel=document.getElementById('mvpSelect');
      const idx=sel.value;
      if(idx===''||idx==null) return alert('선수를 선택하세요.');
      players[idx].mvpCount=(players[idx].mvpCount||0)+1;
      savePlayers(players);
      document.getElementById('mvpMessage').textContent=`${players[idx].name} 선수를 MVP로 기록했습니다. (누적 ${players[idx].mvpCount})`;
      renderPlayerList();
    });

    document.getElementById('exportJsonBtn').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(players,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='players.json';
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    });
    document.getElementById('importJsonBtn').addEventListener('click', async ()=>{
      const file = document.getElementById('importJsonFile').files?.[0];
      if(!file) return alert('JSON 파일을 선택하세요.');
      try{
        const data = JSON.parse(await file.text());
        if(!Array.isArray(data)) throw new Error('형식 오류');
        players=data; savePlayers(players);
        renderPlayerList(); updateMvpSelect(); buildLineupEditor();
        ensureAutoPitcher(); syncSearchInputs();
        alert('불러오기 완료');
      }catch(e){ alert('불러오기 실패: '+e.message); }
    });

    /* ==== 편집 스테퍼 공용 ==== */
    function addStepperRow(container, player, statKey){
      const row=document.createElement('div'); row.className='stat-row';
      const label=document.createElement('label'); label.textContent=statKey;
      const counter=document.createElement('div'); counter.className='counter';
      const dec=document.createElement('button'); dec.className='big-btn'; dec.type='button'; dec.textContent='−';
      const val=document.createElement('input'); val.className='val'; val.type='number'; val.value=player.stats[statKey]||0; val.readOnly=true;
      const inc=document.createElement('button'); inc.className='big-btn'; inc.type='button'; inc.textContent='+';
      dec.addEventListener('click',()=>{ const c=player.stats[statKey]||0; if(c<=0) return; player.stats[statKey]=c-1; val.value=player.stats[statKey]; savePlayers(players); });
      inc.addEventListener('click',()=>{ const c=player.stats[statKey]||0; player.stats[statKey]=c+1; val.value=player.stats[statKey]; savePlayers(players); });
      counter.append(dec,val,inc); row.append(label,counter); container.appendChild(row);
    }
    function renderEditor(containerEl, nameDisplayEl, player, headers){
      nameDisplayEl.textContent = `${player.name} (${player.team})`;
      containerEl.innerHTML=''; headers.forEach(h=>addStepperRow(containerEl, player, h));
    }

    /* ==== 투수/타자 검색 편집 ==== */
    function findPlayer(name,type){ return players.find(p=>p.name===name && p.type===type); }

    function setupSearchAndEdit(){
      const pitcherInput=document.getElementById('pitcherSearch');
      const hitterInput =document.getElementById('hitterSearch');
      const pitcherResults=document.getElementById('pitcherSearchResults');
      const hitterResults =document.getElementById('hitterSearchResults');

      const pitcherEdit=document.getElementById('pitcherEditSection');
      const hitterEdit =document.getElementById('hitterEditSection');
      const pitcherNameDisplay=document.getElementById('pitcherNameDisplay');
      const hitterNameDisplay =document.getElementById('hitterNameDisplay');
      const pitcherStatsContainer=document.getElementById('pitcherStatsContainer');
      const hitterStatsContainer =document.getElementById('hitterStatsContainer');

      function renderList(inputEl, resultsEl, type){
        const kw=inputEl.value.trim().toLowerCase();
        const list=players.filter(p=>p.type===type && p.name.toLowerCase().includes(kw));
        resultsEl.innerHTML=list.map(p=>`<div data-name="${p.name}">${p.name} (${p.team})</div>`).join('');
        resultsEl.style.display=list.length?'block':'none';
      }
      pitcherInput.addEventListener('input',()=>renderList(pitcherInput,pitcherResults,'투수'));
      hitterInput .addEventListener('input',()=>renderList(hitterInput ,hitterResults ,'타자'));

      pitcherResults.addEventListener('click',(e)=>{
        if(e.target.matches('div[data-name]')){
          const name=e.target.getAttribute('data-name');
          const p=findPlayer(name,'투수'); if(!p) return;
          pitcherEdit.style.display='block'; renderEditor(pitcherStatsContainer,pitcherNameDisplay,p,pitcherStatsHeaders);
          pitcherResults.style.display='none';
          // 사용자가 수동으로 투수를 바꾸면 (해당 팀이 현재 수비팀이면) 라인업의 투수도 동기화
          if(p.team===defenseTeam){
            const obj=getLineup(p.team); obj.pitcher=p.name; saveLineup(p.team,obj);
          }
          syncSearchInputs();
        }
      });
      hitterResults.addEventListener('click',(e)=>{
        if(e.target.matches('div[data-name]')){
          const name=e.target.getAttribute('data-name');
          const h=findPlayer(name,'타자'); if(!h) return;
          hitterEdit.style.display='block'; renderEditor(hitterStatsContainer,hitterNameDisplay,h,hitterStatsHeaders);
          hitterResults.style.display='none';
          // 라인업 포인터를 해당 타자로 이동(있으면)
          const lu=currentBatters(); const i=lu.indexOf(name);
          if(i>=0){ setCurrentIdx(i); updateCurrentBatterInfo(); }
          syncSearchInputs();
        }
      });
    }

    /* ==== 라인업 용지(팀별) ==== */
    function buildLineupEditor(){
      const root=document.getElementById('lineupEditor');
      const team = activeLineupTeam;
      const obj = getLineup(team);        // {batters, pitcher}
      const batters = players.filter(p=>p.type==='타자' && p.team===team).map(p=>p.name);
      const pitchers = players.filter(p=>p.type==='투수' && p.team===team).map(p=>p.name);

      const dlB = `dl_b_${team}`;
      const dlP = `dl_p_${team}`;
      const dls = `
        <datalist id="${dlB}">${batters.map(n=>`<option value="${n}">`).join('')}</datalist>
        <datalist id="${dlP}">${pitchers.map(n=>`<option value="${n}">`).join('')}</datalist>
      `;

      let html = `
        ${dls}
        <table class="lineup-table">
          <thead><tr><th style="width:60px;">타순</th><th>성명</th></tr></thead>
          <tbody>
            ${Array.from({length:9}).map((_,i)=>`
              <tr>
                <td>${i+1}</td>
                <td><input list="${dlB}" data-idx="${i}" class="lu-input" placeholder="이름 입력" value="${obj.batters[i]||''}"></td>
              </tr>
            `).join('')}
            <tr>
              <th>P</th>
              <td><input list="${dlP}" class="lu-pitcher" placeholder="투수 이름" value="${obj.pitcher||''}"></td>
            </tr>
          </tbody>
        </table>
      `;
      root.innerHTML = html;

      root.querySelectorAll('.lu-input').forEach(inp=>{
        inp.addEventListener('change',()=>{
          const o=getLineup(team);
          const idx=parseInt(inp.dataset.idx,10);
          o.batters[idx]=inp.value.trim();
          if(!o.batters[idx]) o.batters.splice(idx,1);
          saveLineup(team, o);
          updateCurrentBatterInfo();
          syncSearchInputs();
        });
      });

      root.querySelector('.lu-pitcher').addEventListener('change', (e)=>{
        const o=getLineup(team);
        o.pitcher = e.target.value.trim();
        saveLineup(team, o);
        // 현재 수비팀 라인업의 투수가 바뀌면 즉시 투수 패널에 반영
        if(team===defenseTeam){ applyPitcherFromDefenseLineup(); syncSearchInputs(); }
      });
    }

    function attachLineupTabEvents(){
      document.querySelectorAll('.tab').forEach(btn=>{
        btn.addEventListener('click',()=>{
          document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          activeLineupTeam = btn.dataset.team;
          buildLineupEditor();
        });
      });
    }

    // 라인업 진행 컨트롤
    document.getElementById('startLineupBtn').addEventListener('click', ()=>{
      const lu=currentBatters();
      if(lu.length===0) return alert('현재 공격 팀의 라인업을 먼저 입력하세요.');
      saveLineupIdx(offenseTeam, 0);
      updateCurrentBatterInfo();

      // 타자 패널/검색칸 동기화
      const hitter = findPlayer(lu[0],'타자');
      if(hitter){
        const ec=document.getElementById('hitterEditSection');
        const nd=document.getElementById('hitterNameDisplay');
        const sc=document.getElementById('hitterStatsContainer');
        ec.style.display='block'; renderEditor(sc,nd,hitter,hitterStatsHeaders);
      }
      ensureAutoPitcher();
      syncSearchInputs();
    });

    document.getElementById('nextBatterBtn').addEventListener('click', ()=>{
      const lu=currentBatters();
      if(lu.length===0) return alert('라인업이 비어 있습니다.');
      const idx=(currentIdx()+1)%lu.length;
      setCurrentIdx(idx);
      updateCurrentBatterInfo();
      const hitter=findPlayer(lu[idx],'타자');
      if(hitter){
        const ec=document.getElementById('hitterEditSection');
        const nd=document.getElementById('hitterNameDisplay');
        const sc=document.getElementById('hitterStatsContainer');
        ec.style.display='block'; renderEditor(sc,nd,hitter,hitterStatsHeaders);
      }
      ensureAutoPitcher();
      syncSearchInputs();
    });

    document.getElementById('prevBatterBtn').addEventListener('click', ()=>{
      const list = duelHistory.filter(r=>true);
      if(list.length===0) return alert('이전 타자 기록이 없습니다.');
      if(historyPtr===-1) historyPtr = list.length;
      historyPtr = Math.max(0, historyPtr-1);
      loadFromHistory(list[historyPtr]);
      updateHistoryBadge();
      syncSearchInputs();
    });

    function loadFromHistory(rec){
      // 투수
      const p=findPlayer(rec.pitcherName,'투수');
      if(p){
        const ec=document.getElementById('pitcherEditSection');
        const nd=document.getElementById('pitcherNameDisplay');
        const sc=document.getElementById('pitcherStatsContainer');
        ec.style.display='block'; renderEditor(sc,nd,p,pitcherStatsHeaders);
        document.getElementById('pitcherSearch').value=p.name;
      }
      // 타자
      const h=findPlayer(rec.hitterName,'타자');
      if(h){
        const ec=document.getElementById('hitterEditSection');
        const nd=document.getElementById('hitterNameDisplay');
        const sc=document.getElementById('hitterStatsContainer');
        ec.style.display='block'; renderEditor(sc,nd,h,hitterStatsHeaders);
        document.getElementById('hitterSearch').value=h.name;
        // 라인업 포인터 동기화(해당 이닝의 공격팀에서만)
        if(rec.offenseTeam===offenseTeam){
          const lu=currentBatters();
          const li=lu.indexOf(h.name);
          if(li>=0){ setCurrentIdx(li); updateCurrentBatterInfo(); }
        }
      }
    }

    document.getElementById('historyBackBtn').addEventListener('click', ()=>{
      if(duelHistory.length===0) return alert('히스토리 없음');
      if(historyPtr===-1) historyPtr = duelHistory.length-1;
      else historyPtr = Math.max(0, historyPtr-1);
      loadFromHistory(duelHistory[historyPtr]);
      updateHistoryBadge();
      syncSearchInputs();
    });
    document.getElementById('historyForwardBtn').addEventListener('click', ()=>{
      if(duelHistory.length===0) return alert('히스토리 없음');
      if(historyPtr===-1) return;
      historyPtr++;
      if(historyPtr>=duelHistory.length){ historyPtr=-1; updateHistoryBadge(); syncSearchInputs(); return; }
      loadFromHistory(duelHistory[historyPtr]);
      updateHistoryBadge();
      syncSearchInputs();
    });

    /* ==== 대결 저장 ==== */
    document.getElementById('saveDuelBtn').addEventListener('click', ()=>{
      // 투수는 수비팀 라인업의 투수를 최우선 사용(없으면 편집 패널의 이름)
      const defLu = getLineup(defenseTeam);
      let pitcherName = defLu.pitcher || (document.getElementById('pitcherNameDisplay').textContent||'').split(' (')[0].trim();

      let hitterName = (document.getElementById('hitterNameDisplay').textContent||'').split(' (')[0].trim();
      const lu=currentBatters();
      if(lu.length>0){
        const idx=currentIdx()%lu.length;
        hitterName = lu[idx] || hitterName;
      }
      if(!pitcherName) return alert('투수를 선택하거나 라인업에 투수를 입력하세요.');
      if(!hitterName) return alert('타자를 선택하거나 라인업을 시작하세요.');

      duelHistory.push({pitcherName,hitterName,offenseTeam,defenseTeam,inning,half,ts:Date.now()});
      saveHistory();
      historyPtr=-1; updateHistoryBadge();

      // 다음 타자 진행
      if(lu.length>0){
        setCurrentIdx((currentIdx()+1)%lu.length);
        updateCurrentBatterInfo();
        const hitter=findPlayer(getCurrentBatter(),'타자');
        if(hitter){
          const ec=document.getElementById('hitterEditSection');
          const nd=document.getElementById('hitterNameDisplay');
          const sc=document.getElementById('hitterStatsContainer');
          ec.style.display='block'; renderEditor(sc,nd,hitter,hitterStatsHeaders);
        }
      }
      ensureAutoPitcher();
      syncSearchInputs();

      savePlayers(players);
      alert('대결 기록이 저장되었습니다.');
      renderPlayerList();
    });

    /* ==== 이닝 종료 & 이전/다음 이닝 보기 ==== */
    document.getElementById('endHalfBtn').addEventListener('click', ()=>{
      [offenseTeam, defenseTeam] = [defenseTeam, offenseTeam];
      if(half==='초'){ half='말'; } else { half='초'; inning += 1; }
      saveGameState();
      updateInningBadge();
      updateCurrentBatterInfo();
      ensureAutoPitcher();   // 수비팀이 바뀌면 투수 자동 선정(라인업에 있으면 그 투수)
      syncSearchInputs();
      alert(`이닝 전환: ${inning}회 ${half} · 공격 ${offenseTeam}`);
    });

    document.getElementById('prevInningBtn').addEventListener('click', ()=>{
      if(viewHalf==='말'){ viewHalf='초'; viewInning = Math.max(1, viewInning-1); }
      else { if(viewInning>1){ viewHalf='말'; viewInning-=1; } }
      jumpToLastPAOf(viewInning, viewHalf);
    });
    document.getElementById('nextInningBtn').addEventListener('click', ()=>{
      if(viewHalf==='초'){ viewHalf='말'; }
      else { viewHalf='초'; viewInning += 1; }
      jumpToLastPAOf(viewInning, viewHalf);
    });

    function jumpToLastPAOf(inn, hf){
      const list = duelHistory.filter(r=>r.inning===inn && r.half===hf);
      if(list.length===0){ alert(`${inn}회 ${hf} 기록이 없습니다.`); updateHistoryBadge(); return; }
      const rec = list[list.length-1];
      loadFromHistory(rec);
      syncSearchInputs();
      alert(`${inn}회 ${hf} 마지막 타석을 불러왔습니다.`);
    }

    /* ==== 시작 ==== */
    init();
  </script>
</body>
</html>
