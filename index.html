<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>야구 기록 입력</title>
  <style>
/* ======================= 테마 (라이트/다크) ======================= */
:root{
  --bg:#f6f8fd;
  --text:#1f2937;
  --muted:#6b7280;
  --card:#ffffff;
  --border:#dce3f2;
  --brand:#196ae5;
  --brand-600:#1457b9;
  --pill-bg:#e9f1ff;
  --pill-text:#196ae5;
  --thead:#eef3ff;
  --theadText:#185ad9;

  --chip-bg:#fff;
  --chip-bd:#c7d6fb;
  --chip-sel:#196ae5;
  --chip-wrap:#f2f6ff;

  --shadow:0 6px 22px rgba(20,87,185,.08);
}
[data-theme="dark"]{
  --bg:#0b1220;
  --text:#e7ecf7;
  --muted:#9aa6bd;
  --card:#0f1629;
  --border:#1e2a44;
  --brand:#5aa2ff;
  --brand-600:#3b84eb;
  --pill-bg:#0e1b33;
  --pill-text:#b8d5ff;
  --thead:#101e38;
  --theadText:#cfe2ff;

  --chip-bg:#101a34;
  --chip-bd:#2a3d66;
  --chip-sel:linear-gradient(180deg,#5aa2ff 0%,#3c78ff 100%);
  --chip-wrap:#0f1629;

  --shadow:0 10px 28px rgba(7,14,28,.55);
}

/* ======================= 기본 레이아웃 ======================= */
body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
  max-width: 1200px;
  margin: 40px auto;
  padding: 20px 30px;
  background: var(--bg);
  color: var(--text);
  overflow-x: auto;
}
h1 {
  font-size: 2rem;
  font-weight: 800;
  color: var(--brand);
  margin-bottom: 18px;
  text-align: center;
  letter-spacing: .2px;
}
nav a {
  display: inline-block;
  padding: 10px 20px;
  margin-bottom: 18px;
  background: var(--brand);
  color: white;
  font-weight: 700;
  border-radius: 10px;
  text-decoration: none;
  box-shadow: var(--shadow);
  transition: transform .05s ease, filter .2s ease;
}
nav a:hover { filter: brightness(.97); transform: translateY(-1px); }

/* 다크모드 토글 */
#themeToggle{
  float:right;
  margin-top:-6px;
  margin-bottom:8px;
  padding:8px 12px;
  border-radius:10px;
  border:1px solid var(--border);
  background: var(--card);
  color: var(--text);
  cursor:pointer;
  box-shadow: var(--shadow);
}

/* 공통 버튼 */
button {
  padding: 10px 18px;
  font-size: 0.98rem;
  font-weight: 700;
  border: 1px solid transparent;
  border-radius: 10px;
  background: var(--brand);
  color: white;
  cursor: pointer;
  transition: transform .05s ease, filter .18s ease, box-shadow .18s ease;
  box-shadow: var(--shadow);
}
button:hover { filter: brightness(.97); transform: translateY(-1px); }
button:active { transform: translateY(0); }
button.alt { background: var(--brand-600); }

/* 입력/선택 */
form {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-bottom: 16px;
  flex-wrap: wrap;
}
input[type="text"], select {
  padding: 10px 12px;
  font-size: 1rem;
  border: 1.5px solid var(--border);
  border-radius: 10px;
  width: 180px;
  min-width: 150px;
  background: var(--card);
  color: var(--text);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
  transition: box-shadow .2s ease, border-color .2s ease;
}
input[type="text"]:focus, select:focus,
.spin-input:focus {
  outline: none;
  border-color: var(--brand);
  box-shadow: 0 0 0 3px rgba(90,162,255,.28);
}

/* 카드 섹션 */
.section {
  background: var(--card);
  padding: 20px 25px;
  border-radius: 14px;
  border:1px solid var(--border);
  box-shadow: var(--shadow);
  overflow-x: auto;
  margin-top: 18px;
}

/* 상단 제어바 */
.controlbar{
  display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom:10px;
}
.left-controls, .right-controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.pill{
  background: var(--pill-bg);
  color: var(--pill-text);
  padding:6px 12px; border-radius:999px; font-weight:800; border:1px solid var(--border);
}

/* 라인업 2열 */
.lineup-2col{ display:grid; gap:16px; grid-template-columns: 1fr 1fr; }
.lineup-card{
  border:1px solid var(--border); border-radius:14px; padding:14px; background:var(--card);
  box-shadow: var(--shadow);
}
.lineup-title{ font-weight:900; color:var(--brand); margin-bottom:8px; letter-spacing:.2px; }
.lineup-table{ width:100%; border-collapse:collapse; min-width:420px; }
.lineup-table th, .lineup-table td{
  border:1px solid var(--border); padding:8px 10px; text-align:center; background:transparent; color:var(--text);
}
.lineup-table th{ background:var(--thead); color:var(--theadText); }

/* 듀얼 그리드(투수/타자 입력) */
.duel-grid{ display:flex; gap:30px; flex-wrap:wrap; }
#pitcherSearch, #hitterSearch{
  width: 100%; margin-bottom: 12px;
}
#pitcherSearchResults div, #hitterSearchResults div{
  padding:8px 10px; margin-bottom:6px; background:var(--thead);
  border:1px solid var(--border); border-radius:8px; cursor:pointer;
}
#pitcherEditSection, #hitterEditSection{
  background: var(--chip-wrap);
  border: 1px solid var(--border);
  padding: 15px 20px;
  border-radius: 12px;
  margin-top: 8px;
}
#pitcherNameDisplay, #hitterNameDisplay{ font-weight:900; color:var(--brand); margin-bottom:10px; cursor:pointer; text-decoration: underline dashed; }

/* 칩(단일선택) */
.group-title{ font-weight:800; color:var(--text); margin:10px 0 6px; }
.chip-group{
  display:flex; flex-wrap:wrap; gap:10px; background:var(--chip-wrap);
  border:1px dashed var(--border); border-radius:12px; padding:12px;
}
.chip{
  padding:10px 14px; border-radius:12px; border:1px solid var(--chip-bd); background:var(--chip-bg);
  cursor:pointer; user-select:none; transition:transform .05s ease, box-shadow .18s ease, filter .18s ease, background .18s ease;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
  font-weight:700;
}
.chip:hover{ filter: brightness(.98); transform: translateY(-1px); }
.chip.selected{
  background: var(--chip-sel); color:#fff; border-color: transparent;
  box-shadow: 0 6px 18px rgba(58,120,255,.35);
}

/* 숫자 입력 + 큰 화살표(커스텀 스피너) */
.num-row{ display:flex; align-items:center; gap:12px; margin:10px 0; }
.num-row label{ min-width:92px; font-weight:800; color:var(--text); }
.spin-wrap{ display:flex; align-items:center; gap:8px; }
.spin-input{
  width:140px; padding:12px 14px; border:1.5px solid var(--border);
  border-radius:12px; font-size:1.02rem; background:var(--card); color:var(--text);
}
.spin-btn{
  width:42px; height:42px; font-size:18px; font-weight:900; line-height:1;
  border-radius:12px; border:1px solid var(--border); background:var(--thead); color:var(--text);
  cursor:pointer; box-shadow: var(--shadow);
}
.spin-btn:hover{ filter:brightness(1.03); transform: translateY(-1px); }
.spin-btn:active{ transform: translateY(0); }

/* 테이블/리스트 */
.player-list > div {
  background: var(--card);
  border: 1px solid var(--border);
  padding: 16px 20px;
  border-radius: 14px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
  overflow-x: auto;
  max-width: 100%;
}
.player-list h3 {
  font-weight: 900; color: var(--brand); margin-bottom: 15px;
  display: flex; justify-content: space-between; align-items: center;
}
.delete-btn {
  color: #ff6b6b; font-size: 14px; padding: 6px 10px; border-radius: 10px;
  background: transparent; border:1px solid var(--border); cursor: pointer;
}
table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 900px; }
th, td { border: 1px solid var(--border); text-align: center; font-size: 0.92rem; white-space: nowrap; padding: 8px 6px; }
th { background: var(--thead); color: var(--theadText); font-weight: 800; user-select: none; }
td.buttons-cell{ padding:6px 6px; }
button.stat-btn{
  width:26px; height:26px; font-size:16px; line-height:1; padding:0; border-radius:8px;
  border:1px solid var(--border); background:var(--thead); cursor:pointer; margin:0 2px;
}
.muted{ color:var(--muted); font-size:0.92rem; }

/* ==== 히스토리 리스트 패널 ==== */
.history-wrap{
  display:flex; gap:14px; align-items:flex-start; margin-top:12px; flex-wrap:wrap;
}
.history-panel{
  flex:1; min-width: 340px; max-height: 260px; overflow:auto;
  background: var(--card); border:1px solid var(--border); border-radius:12px; box-shadow: var(--shadow);
}
.history-head{
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 12px; position:sticky; top:0; background:var(--thead); color:var(--theadText);
  border-bottom:1px solid var(--border); border-top-left-radius:12px; border-top-right-radius:12px;
}
.history-list{ padding:8px; }
.history-item{
  padding:10px 12px; border:1px solid var(--border); border-radius:10px; margin-bottom:8px; cursor:pointer;
  display:flex; gap:10px; align-items:center; background:var(--chip-bg);
}
.history-item:hover{ filter:brightness(0.98); transform: translateY(-1px); }
.history-item.active{
  background: var(--pill-bg); border-color: var(--brand); box-shadow: 0 6px 18px rgba(58,120,255,.18);
}
.tag{
  font-size:.78rem; font-weight:800; padding:4px 8px; border-radius:999px; border:1px solid var(--border);
  background: var(--thead); color: var(--theadText); white-space:nowrap;
}
.hist-main{ display:flex; flex-direction:column; gap:2px; }
.hist-title{ font-weight:800; }
.hist-sub{ font-size:.86rem; color:var(--muted); }

/* 고정 상단/하단 이동 버튼 */
#backToEditorBtn{
  position:fixed; left:16px; bottom:16px; z-index:1000;
  font-size:.85rem; padding:8px 10px; border-radius:10px; opacity:.92;
  box-shadow: var(--shadow);
}

/* 하이라이트 효과 */
.highlight{
  outline: 3px solid var(--brand);
  background: var(--pill-bg);
  transition: outline .3s ease;
}
  </style>
</head>
<body>
  <h1>선수 기록 입력 및 관리</h1>
  <button id="themeToggle">🌙 다크 모드</button>
  <nav>
    <a href="records.html">선수 기록 조회 페이지로 이동</a>
  </nav>

  <!-- 선수 추가 -->
  <form id="addPlayerForm">
    <input type="text" id="playerName" placeholder="선수 이름" required />
    <select id="playerType">
      <option value="타자">타자</option>
      <option value="투수">투수</option>
    </select>
    <select id="playerTeam" required>
      <option value="" disabled selected>팀 선택</option>
      <option value="Leaders">Leaders</option>
      <option value="CSIA">CSIA</option>
    </select>
    <button type="submit">선수 추가</button>
  </form>

  <!-- === 투타 대결 + 라인업 + 이닝 === -->
  <section class="section" id="duelSection">
    <!-- 상단 제어바 -->
    <div class="controlbar">
      <div class="left-controls">
        <span class="pill" id="inningBadge">1회 초 · 공격: Leaders</span>
        <span class="pill" id="historyBadge">히스토리 0건 · 포인터 최신</span>
        <span class="pill" id="editBadge" style="display:none; background:#fff0f0; color:#d33;">편집 모드</span>
      </div>
      <div class="right-controls">
        <label for="firstTeamSel" class="muted">선공 팀:</label>
        <select id="firstTeamSel">
          <option value="Leaders">Leaders</option>
          <option value="CSIA">CSIA</option>
        </select>
        <button id="applyFirstTeamBtn" class="alt">선공 적용</button>
        <button id="resetInningBtn" style="background:#e67e22;">이닝 초기화</button>
      </div>
    </div>

    <!-- 라인업: 양쪽 동시 표시 -->
    <div class="lineup-2col" style="margin-bottom:12px;">
      <div class="lineup-card">
        <div class="lineup-title">Leaders 라인업</div>
        <div id="lineupEditorLeaders"></div>
      </div>
      <div class="lineup-card">
        <div class="lineup-title">CSIA 라인업</div>
        <div id="lineupEditorCSIA"></div>
      </div>
    </div>

    <!-- 라인업 진행 툴바 -->
    <div class="lineup-footer" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:6px;">
      <button id="startLineupBtn" type="button">라인업 시작</button>
      <button id="prevBatterBtn" type="button">◀ 이전 타자 보기</button>
      <button id="nextBatterBtn" type="button">다음 타자 ▶</button>
      <span class="muted" id="currentBatterInfo">현재 타자: -</span>
    </div>

    <div id="editorTop"></div>
    <!-- 투수/타자 입력 그리드 -->
    <div class="duel-grid">
      <!-- 투수 -->
      <div style="flex:1; min-width: 320px;">
        <h3>투수 선택 및 기록</h3>
        <input type="text" id="pitcherSearch" placeholder="투수 이름 검색" autocomplete="off" />
        <div id="pitcherSearchResults"></div>
        <div id="pitcherEditSection" style="display:none;">
          <div id="pitcherNameDisplay" title="등록 선수 목록에서 위치 보기"></div>

          <div class="num-row">
            <label>투구수(+)</label>
            <div class="spin-wrap">
              <button class="spin-btn" data-spin="dec" data-target="pitcherPitchCountInput">▼</button>
              <input id="pitcherPitchCountInput" class="spin-input" type="number" min="0" step="1" value="0" />
              <button class="spin-btn" data-spin="inc" data-target="pitcherPitchCountInput">▲</button>
            </div>
          </div>
          <div class="num-row">
            <label>이닝(+)</label>
            <div class="spin-wrap">
              <button class="spin-btn" data-spin="dec" data-target="pitcherInningsInput">▼</button>
              <input id="pitcherInningsInput" class="spin-input" type="number" min="0" step="0.1" value="0" />
              <button class="spin-btn" data-spin="inc" data-target="pitcherInningsInput">▲</button>
            </div>
          </div>
          <div class="num-row">
            <label>자책점(+)</label>
            <div class="spin-wrap">
              <button class="spin-btn" data-spin="dec" data-target="pitcherERInput">▼</button>
              <input id="pitcherERInput" class="spin-input" type="number" min="0" step="1" value="0" />
              <button class="spin-btn" data-spin="inc" data-target="pitcherERInput">▲</button>
            </div>
          </div>

          <!-- 단일 선택 그룹 1 -->
          <div class="group-title">이번 결과(투수) – 택1</div>
          <div id="pitcherGroup1" class="chip-group" role="group" aria-label="Pitcher Result Group 1"></div>

          <!-- 단일 선택 그룹 2 -->
          <div class="group-title">승패/세이브 – 택1</div>
          <div id="pitcherGroup2" class="chip-group" role="group" aria-label="Pitcher Result Group 2"></div>
        </div>
      </div>

      <!-- 타자 -->
      <div style="flex:1; min-width: 320px;">
        <h3>타자 선택 및 기록</h3>
        <input type="text" id="hitterSearch" placeholder="(단독 선택용) 타자 이름 검색" autocomplete="off" />
        <div id="hitterSearchResults"></div>
        <div id="hitterEditSection" style="display:none;">
          <div id="hitterNameDisplay" title="등록 선수 목록에서 위치 보기"></div>

          <div class="group-title">이번 결과(타자) – 택1</div>
          <div id="hitterGroup" class="chip-group" role="group" aria-label="Hitter Result Group"></div>

          <div class="num-row">
            <label>타점(+)</label>
            <div class="spin-wrap">
              <button class="spin-btn" data-spin="dec" data-target="hitterRBIInput">▼</button>
              <input id="hitterRBIInput" class="spin-input" type="number" min="0" step="1" value="0" />
              <button class="spin-btn" data-spin="inc" data-target="hitterRBIInput">▲</button>
            </div>
          </div>
          <div class="num-row">
            <label>득점(+)</label>
            <div class="spin-wrap">
              <button class="spin-btn" data-spin="dec" data-target="hitterRUNInput">▼</button>
              <input id="hitterRUNInput" class="spin-input" type="number" min="0" step="1" value="0" />
              <button class="spin-btn" data-spin="inc" data-target="hitterRUNInput">▲</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 하단 툴바 -->
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
      <button id="saveDuelBtn">대결 기록 저장(증분 반영 & 자동 다음 타자)</button>
      <button id="updateRecordBtn" class="alt" style="display:none;">기록 수정 저장</button>
      <button id="deleteRecordBtn" style="display:none; background:#ff6b6b;">기록 삭제</button>
      <button id="cancelEditBtn" class="alt" style="display:none;">수정 취소</button>

      <button id="historyBackBtn" class="alt">◀ 히스토리 이전 보기</button>
      <button id="historyForwardBtn" class="alt">히스토리 다음 보기 ▶</button>

      <button id="endHalfBtn" style="margin-left:auto; background:#e67e22;">이닝 종료(공수 전환)</button>
      <button id="prevInningBtn" style="background:#34a853;">◀ 이전 이닝 보기</button>
      <button id="nextInningBtn" style="background:#34a853;">다음 이닝 보기 ▶</button>
    </div>

    <!-- 히스토리 목록 패널 -->
    <div class="history-wrap">
      <div class="history-panel" aria-label="히스토리 목록">
        <div class="history-head">
          <div style="display:flex; gap:8px; align-items:center;">
            <strong>히스토리 목록</strong>
            <span class="muted" id="historyCountLabel"></span>
          </div>
          <div style="display:flex; gap:6px; align-items:center;">
            <select id="historyFilter">
              <option value="all">전체</option>
              <option value="current">현재 이닝만</option>
            </select>
            <button id="clearSelBtn" class="alt" title="선택 해제">선택 해제</button>
            <button id="clearHistoryBtn" style="background:#ff6b6b;" title="모든 히스토리 삭제">초기화</button>
          </div>
        </div>
        <div id="historyList" class="history-list"></div>
      </div>
    </div>
  </section>

  <!-- 등록 선수 목록 -->
  <section class="section" id="playerListSection">
    <h2 style="margin-top:0; color:var(--brand);">등록 선수 목록</h2>
    <div class="player-list" id="playerList"></div>
  </section>

  <!-- MVP / JSON -->
  <div class="section" style="text-align:center;">
    <h2 style="color:var(--brand);">MVP 선정</h2>
    <select id="mvpSelect">
      <option value="" disabled selected>선수 선택</option>
    </select>
    <button id="selectMvpBtn">MVP 선정</button>
    <p id="mvpMessage" class="muted"></p>

    <button id="exportJsonBtn" style="margin-top: 12px; background: #34a853;">JSON 파일로 내보내기</button>
    <div style="margin-top:12px;">
      <input type="file" id="importJsonFile" accept="application/json" />
      <button id="importJsonBtn" style="margin-top: 8px; background: #fbbc05;">JSON 불러오기</button>
    </div>
  </div>

  <!-- 항상 고정: 에디터로 올라가기 -->
  <button id="backToEditorBtn" title="투수/타자 선택 및 기록으로 가기">▲ 기록 입력으로</button>

<script>
/* ==== 테마 토글 ==== */
(function(){
  const root=document.documentElement, btn=document.getElementById('themeToggle');
  const saved = localStorage.getItem('theme');
  if(saved){ root.setAttribute('data-theme', saved); btn.textContent = saved==='dark'?'☀️ 라이트 모드':'🌙 다크 모드'; }
  btn.addEventListener('click',()=>{
    const isDark = root.getAttribute('data-theme')==='dark';
    const next = isDark ? '' : 'dark';
    if(next) root.setAttribute('data-theme', next); else root.removeAttribute('data-theme');
    localStorage.setItem('theme', next||'');
    btn.textContent = next==='dark'?'☀️ 라이트 모드':'🌙 다크 모드';
  });
})();

/* ==== Storage Keys ==== */
const STORAGE_KEY = 'playersData';
const LINEUP_KEY_BY_TEAM = (team)=>`lineup_${team}`;
const LINEUP_IDX_KEY_BY_TEAM = (team)=>`lineup_idx_${team}`;
const HISTORY_KEY = 'duelHistory_v2';
const GAME_STATE_KEY = 'gameState_v2';
const FIRST_TEAM_KEY = 'firstTeam_sel';

/* ==== Data ==== */
let players = [];
let offenseTeam = 'Leaders';
let defenseTeam = 'CSIA';
let inning = 1;
let half = '초';
let duelHistory = [];
let historyPtr = -1;     // 포인터(원본 인덱스)
let editIndex = -1;      // 편집 중인 히스토리 인덱스
let viewInning = 1;
let viewHalf = '초';

const hitterStatsHeaders  = ['1루타','2루타','3루타','홈런','삼진','볼넷','희생플라이','내야땅볼','플라이아웃','타점','득점'];
const pitcherStatsHeaders = ['투구수','삼진','볼넷','피안타','피홈런','자책점','이닝','승리','패배','홀드','세이브','사구'];

/* ==== Storage helpers ==== */
const savePlayers = (p)=>localStorage.setItem(STORAGE_KEY, JSON.stringify(p));
const loadPlayers = ()=>JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

function getLineup(team){
  const raw = localStorage.getItem(LINEUP_KEY_BY_TEAM(team));
  if(!raw) return {batters: [], pitcher: ''};
  try{
    const parsed = JSON.parse(raw);
    if(Array.isArray(parsed)) return {batters: parsed, pitcher: ''};
    if(parsed && typeof parsed==='object')
      return {batters: parsed.batters || [], pitcher: parsed.pitcher || ''};
  }catch(e){}
  return {batters: [], pitcher: ''};
}
function saveLineup(team, obj){ localStorage.setItem(LINEUP_KEY_BY_TEAM(team), JSON.stringify(obj)); }

const saveLineupIdx = (team, idx)=>localStorage.setItem(LINEUP_IDX_KEY_BY_TEAM(team), String(idx||0));
const loadLineupIdx = (team)=>parseInt(localStorage.getItem(LINEUP_IDX_KEY_BY_TEAM(team))||'0',10);

const saveHistory = ()=>localStorage.setItem(HISTORY_KEY, JSON.stringify(duelHistory));
const loadHistory = ()=>JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]');

const saveGameState = ()=>{ localStorage.setItem(GAME_STATE_KEY, JSON.stringify({offenseTeam, defenseTeam, inning, half})); };
const loadGameState = ()=>{
  const s = JSON.parse(localStorage.getItem(GAME_STATE_KEY)||'{}');
  offenseTeam = s.offenseTeam || 'Leaders';
  defenseTeam = s.defenseTeam || 'CSIA';
  inning = s.inning || 1;
  half = s.half || '초';
};

/* ==== Init ==== */
function init(){
  players = loadPlayers();
  duelHistory = loadHistory();
  loadGameState();

  const savedFirst = localStorage.getItem(FIRST_TEAM_KEY);
  if(savedFirst){
    document.getElementById('firstTeamSel').value = savedFirst;
    setFirstTeam(savedFirst, false);
  }else{
    setFirstTeam(offenseTeam, false);
  }

  renderPlayerList();
  updateMvpSelect();
  setupSearchAndEdit();
  buildBothLineups();
  updateInningBadge();
  updateHistoryBadge();
  updateCurrentBatterInfo();
  ensureAutoPitcher();
  syncSearchInputs();

  // 초기 히스토리 목록 렌더
  renderHistoryList('all');

  // 필터/선택해제/초기화 이벤트
  document.getElementById('historyFilter').addEventListener('change', ()=>renderHistoryList());
  document.getElementById('clearSelBtn').addEventListener('click', ()=>{
    historyPtr = -1;
    exitEditMode();
    updateHistoryBadge();
    renderHistoryList();
  });
  document.getElementById('clearHistoryBtn').addEventListener('click', ()=>{
    if(!confirm('모든 히스토리를 삭제할까요? 되돌릴 수 없습니다.')) return;
    // 목록만 초기화(통계는 유지)
    duelHistory = [];
    saveHistory();
    historyPtr = -1;
    exitEditMode();
    updateHistoryBadge();
    renderHistoryList();
    alert('히스토리를 초기화했습니다.');
  });

  // 편집 버튼 이벤트
  document.getElementById('updateRecordBtn').addEventListener('click', onUpdateRecord);
  document.getElementById('deleteRecordBtn').addEventListener('click', onDeleteRecord);
  document.getElementById('cancelEditBtn').addEventListener('click', exitEditMode);

  // 이름 클릭 → 등록 선수 위치로 스크롤
  document.getElementById('pitcherNameDisplay').addEventListener('click', ()=>scrollToPlayerFromDisplay('투수'));
  document.getElementById('hitterNameDisplay').addEventListener('click', ()=>scrollToPlayerFromDisplay('타자'));

  // 고정: 에디터로 올라가기
  document.getElementById('backToEditorBtn').addEventListener('click', ()=>{
    document.getElementById('editorTop')?.scrollIntoView({behavior:'smooth', block:'start'});
  });

  // 투수 결과칩(삼진/볼넷) → 타자 자동 동기화
  document.getElementById('pitcherGroup1').addEventListener('click', ()=>{
    setTimeout(()=>syncHitterFromPitcherResult(),0);
  });
}

/* ==== helpers ==== */
const currentBatters = ()=>getLineup(offenseTeam).batters;
const currentIdx = ()=>loadLineupIdx(offenseTeam);
const setCurrentIdx = (v)=>saveLineupIdx(offenseTeam, v);
function getCurrentBatter(){
  const lu = currentBatters();
  if(lu.length===0) return null;
  const idx = currentIdx()%lu.length;
  return lu[idx]||null;
}

/* ==== UI Utils ==== */
function updateInningBadge(){
  document.getElementById('inningBadge').textContent = `${inning}회 ${half} · 공격: ${offenseTeam}`;
}
function updateHistoryBadge(){
  const total = duelHistory.length;
  const ptrText = (historyPtr===-1) ? '최신' : `${historyPtr+1}/${total}`;
  document.getElementById('historyBadge').textContent = `히스토리 ${total}건 · 포인터 ${ptrText}`;
  renderHistoryList(); // active 표시 갱신
}
function updateCurrentBatterInfo(){
  const b = getCurrentBatter();
  document.getElementById('currentBatterInfo').textContent =
    b ? `현재 타자: ${b}` : '현재 타자: (라인업 비어 있음)';
}
function setEditMode(idx){
  editIndex = idx;
  document.getElementById('editBadge').style.display = 'inline-block';
  document.getElementById('updateRecordBtn').style.display = 'inline-block';
  document.getElementById('deleteRecordBtn').style.display = 'inline-block';
  document.getElementById('cancelEditBtn').style.display = 'inline-block';
}
function exitEditMode(){
  editIndex = -1;
  document.getElementById('editBadge').style.display = 'none';
  document.getElementById('updateRecordBtn').style.display = 'none';
  document.getElementById('deleteRecordBtn').style.display = 'none';
  document.getElementById('cancelEditBtn').style.display = 'none';
}

/* ==== 히스토리 목록 ==== */
function timeAgo(ts){
  if(!ts) return '';
  const diff = Date.now() - ts;
  const s = Math.floor(diff/1000);
  if(s<60) return `${s}s 전`;
  const m = Math.floor(s/60);
  if(m<60) return `${m}m 전`;
  const h = Math.floor(m/60);
  if(h<24) return `${h}h 전`;
  const d = Math.floor(h/24);
  return `${d}d 전`;
}
function formatOutcome(o){
  if(!o) return '';
  const parts=[];
  if(o.hitterEvt) parts.push(`타자 ${o.hitterEvt}`);
  if(o.rbi && o.rbi>0) parts.push(`타점 +${o.rbi}`);
  if(o.run && o.run>0) parts.push(`득점 +${o.run}`);
  if(o.pitcherEvt) parts.push(`투수 ${o.pitcherEvt}`);
  if(o.pitcherDecision) parts.push(o.pitcherDecision);
  if(o.pitchCount) parts.push(`투구수 +${o.pitchCount}`);
  if(o.inningsDelta) parts.push(`이닝 +${o.inningsDelta}`);
  if(o.er) parts.push(`자책점 +${o.er}`);
  return parts.join(' · ');
}
/** filter: 'all' | 'current' */
function renderHistoryList(filterVal){
  const listEl = document.getElementById('historyList');
  const countEl = document.getElementById('historyCountLabel');
  if(!listEl) return;
  const f = filterVal || document.getElementById('historyFilter')?.value || 'all';

  let items = duelHistory.map((r,idx)=>({r, idx})).reverse(); // 최신 위
  if(f==='current'){
    items = items.filter(x => x.r.inning===inning && x.r.half===half);
  }

  countEl.textContent = `(${items.length}건)`;

  if(items.length===0){
    listEl.innerHTML = `<div class="muted" style="padding:10px 12px;">표시할 히스토리가 없습니다.</div>`;
    return;
  }

  const activeIdx = (historyPtr===-1) ? -1 : historyPtr;
  listEl.innerHTML = items.map(({r, idx})=>{
    const title = `${r.inning}회 ${r.half} · ${r.offenseTeam} 공격`;
    const sub   = `${r.hitterName}  vs  ${r.pitcherName}`;
    const res   = formatOutcome(r.outcome);
    const isActive = (activeIdx===idx);
    return `
      <div class="history-item ${isActive?'active':''}" data-idx="${idx}" title="클릭하여 불러오기">
        <span class="tag">${timeAgo(r.ts)||'—'}</span>
        <div class="hist-main">
          <div class="hist-title">${title}</div>
          <div class="hist-sub">${sub}</div>
          <div class="hist-sub">${res || ''}</div>
        </div>
      </div>
    `;
  }).join('');
}

// 목록 클릭 -> 해당 기록 로드 + 편집 모드 + UI에 값 반영
document.addEventListener('click', (e)=>{
  const it = e.target.closest('.history-item');
  if(!it) return;
  const idx = parseInt(it.dataset.idx, 10);
  if(isNaN(idx)) return;
  historyPtr = idx;
  const rec = duelHistory[idx];
  loadFromHistory(rec);
  applyOutcomeToUI(rec.outcome);
  setEditMode(idx);
  updateHistoryBadge();
  syncSearchInputs();
});

/* ==== 선공/초기화 ==== */
function setFirstTeam(team, persist=true){
  offenseTeam = team;
  defenseTeam = (team==='Leaders')?'CSIA':'Leaders';
  if(persist) localStorage.setItem(FIRST_TEAM_KEY, team);
  saveGameState();
  updateInningBadge();
  updateCurrentBatterInfo();
  ensureAutoPitcher();
  syncSearchInputs();
}
document.getElementById('applyFirstTeamBtn').addEventListener('click', ()=>{
  const team = document.getElementById('firstTeamSel').value;
  setFirstTeam(team, true);
  alert(`선공 팀을 ${team}로 설정했습니다.`);
});
document.getElementById('resetInningBtn').addEventListener('click', ()=>{
  inning = 1; half='초';
  const first = document.getElementById('firstTeamSel').value;
  setFirstTeam(first, true);
  saveGameState();
  updateInningBadge();
  updateCurrentBatterInfo();
  alert('이닝이 1회 초로 초기화되었습니다.');
});

/* === 투수 에디터 업데이트 유틸 === */
function updatePitcherEditorByName(name, team){
  if(!name) return false;
  let p = players.find(x=>x.type==='투수' && x.name===name && x.team===team);
  if(!p) p = players.find(x=>x.type==='투수' && x.name===name);
  if(!p) return false;

  const pitcherEdit=document.getElementById('pitcherEditSection');
  pitcherEdit.style.display='block';
  renderPitcherEditor(p);
  document.getElementById('pitcherNameDisplay').textContent = `${p.name} (${p.team})`;
  document.getElementById('pitcherSearch').value = p.name;
  return true;
}

/* === 투/타 검색칸 자동 동기화 & 수비팀 투수 자동 반영 === */
function applyPitcherFromDefenseLineup(){
  const { pitcher } = getLineup(defenseTeam);
  if(!pitcher) return false;
  return updatePitcherEditorByName(pitcher, defenseTeam);
}
function ensureAutoPitcher(){
  if(applyPitcherFromDefenseLineup()) return;
  const cand = players.find(p=>p.type==='투수' && p.team===defenseTeam);
  if(!cand) return;
  updatePitcherEditorByName(cand.name, defenseTeam);
}
function syncSearchInputs(){
  const curBatter = getCurrentBatter();
  if(curBatter) document.getElementById('hitterSearch').value = curBatter;
  const pName = (document.getElementById('pitcherNameDisplay').textContent||'').split(' (')[0].trim();
  if(pName) document.getElementById('pitcherSearch').value = pName;
}

/* ==== 선수 추가 & 목록 ==== */
const playerListDiv = document.getElementById('playerList');

document.getElementById('addPlayerForm').addEventListener('submit', e=>{
  e.preventDefault();
  const name = document.getElementById('playerName').value.trim();
  const type = document.getElementById('playerType').value;
  const team = document.getElementById('playerTeam').value;
  if(!name || !team) return alert('모든 값을 입력하세요.');
  if(players.some(p=>p.name===name && p.type===type)) return alert('이미 등록된 선수입니다.');

  const stats = (type==='타자')
    ? hitterStatsHeaders.reduce((a,c)=>(a[c]=0,a),{})
    : pitcherStatsHeaders.reduce((a,c)=>(a[c]=0,a),{});
  players.push({name, type, team, stats, mvpCount:0});
  savePlayers(players);
  renderPlayerList(); updateMvpSelect(); buildBothLineups();
  e.target.reset();
  ensureAutoPitcher(); syncSearchInputs();
});

playerListDiv.addEventListener('click', e=>{
  const idx = parseInt(e.target.dataset.idx);
  if (e.target.classList.contains('delete-btn')) {
    if (confirm(`${players[idx].name} 선수를 삭제하시겠습니까?`)) {
      ['Leaders','CSIA'].forEach(t=>{
        const obj = getLineup(t);
        obj.batters = obj.batters.filter(n=>n!==players[idx].name);
        if(obj.pitcher === players[idx].name) obj.pitcher = '';
        saveLineup(t, obj);
      });
      players.splice(idx,1);
      savePlayers(players);
      renderPlayerList(); buildBothLineups(); updateMvpSelect();
      ensureAutoPitcher(); syncSearchInputs();
    }
  } else if (e.target.classList.contains('stat-btn')) {
    const stat = e.target.dataset.stat;
    const delta = parseInt(e.target.dataset.delta);
    if (stat === 'mvpCount') {
      const newVal = (players[idx].mvpCount || 0) + delta;
      if (newVal < 0) return;
      players[idx].mvpCount = newVal;
    } else {
      const newVal = (players[idx].stats[stat] || 0) + delta;
      if (newVal < 0) return;
      players[idx].stats[stat] = newVal;
    }
    savePlayers(players);
    renderPlayerList();
  }
});

function containerIdFor(name, type){
  return `player-card-${type}-${encodeURIComponent(name)}`;
}

function renderPlayerList(){
  playerListDiv.innerHTML = '';
  if(players.length===0){
    playerListDiv.textContent = '등록된 선수가 없습니다.';
    return;
  }
  players.forEach((player, idx)=>{
    const container = document.createElement('div');
    container.id = containerIdFor(player.name, player.type);
    const keys = Object.keys(player.stats);
    let html = `<h3>${player.name} (${player.team} / ${player.type}) <button class="delete-btn" data-idx="${idx}">삭제</button></h3>`;
    html += '<table><thead><tr>'+keys.map(k=>`<th>${k}</th>`).join('')+'<th>MVP 횟수</th></tr></thead><tbody><tr>';
    html += keys.map(k=>`
      <td class="buttons-cell">
        <button class="stat-btn" data-idx="${idx}" data-stat="${k}" data-delta="1">▲</button>
        <button class="stat-btn" data-idx="${idx}" data-stat="${k}" data-delta="-1">▼</button>
      </td>`).join('');
    html += `
      <td class="buttons-cell">
        <button class="stat-btn" data-idx="${idx}" data-stat="mvpCount" data-delta="1">▲</button>
        <button class="stat-btn" data-idx="${idx}" data-stat="mvpCount" data-delta="-1">▼</button>
      </td>
    </tr><tr>`;
    html += keys.map(k=>`<td>${player.stats[k]}</td>`).join('');
    html += `<td>${player.mvpCount||0}</td></tr></tbody></table>`;
    container.innerHTML = html;
    playerListDiv.appendChild(container);
  });
}

/* ==== MVP ==== */
function updateMvpSelect(){
  const sel = document.getElementById('mvpSelect');
  sel.innerHTML = '<option value="" disabled selected>선수 선택</option>';
  players.forEach((p,i)=>{
    const opt = document.createElement('option');
    opt.value=i; opt.textContent=`${p.name} (${p.team} / ${p.type})`;
    sel.appendChild(opt);
  });
}
document.getElementById('selectMvpBtn').addEventListener('click', ()=>{
  const sel=document.getElementById('mvpSelect');
  const idx=sel.value;
  if(idx===''||idx==null) return alert('선수를 선택하세요.');
  players[idx].mvpCount=(players[idx].mvpCount||0)+1;
  savePlayers(players);
  document.getElementById('mvpMessage').textContent=`${players[idx].name} 선수를 MVP로 기록했습니다. (누적 ${players[idx].mvpCount})`;
  renderPlayerList();
});
document.getElementById('exportJsonBtn').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(players,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='players.json';
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
});
document.getElementById('importJsonBtn').addEventListener('click', async ()=>{
  const file = document.getElementById('importJsonFile').files?.[0];
  if(!file) return alert('JSON 파일을 선택하세요.');
  try{
    const data = JSON.parse(await file.text());
    if(!Array.isArray(data)) throw new Error('형식 오류');
    players=data; savePlayers(players);
    renderPlayerList(); updateMvpSelect(); buildBothLineups();
    ensureAutoPitcher(); syncSearchInputs();
    alert('불러오기 완료');
  }catch(e){ alert('불러오기 실패: '+e.message); }
});

/* ==== 칩 유틸 ==== */
function renderChipGroup(rootEl, options){
  rootEl.innerHTML = '';
  options.forEach(opt=>{
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.textContent = opt;
    chip.dataset.value = opt;
    chip.addEventListener('click', ()=>{
      if(chip.classList.contains('selected')){
        chip.classList.remove('selected');
        return;
      }
      [...rootEl.querySelectorAll('.chip')].forEach(c=>c.classList.remove('selected'));
      chip.classList.add('selected');
    });
    rootEl.appendChild(chip);
  });
}
function getSelectedValue(rootEl){
  const sel = rootEl.querySelector('.chip.selected');
  return sel ? sel.dataset.value : '';
}
function selectChipByValue(rootEl, value){
  if(!rootEl) return;
  [...rootEl.querySelectorAll('.chip')].forEach(c=>c.classList.remove('selected'));
  if(!value) return;
  const el = rootEl.querySelector(`.chip[data-value="${value}"]`);
  if(el) el.classList.add('selected');
}
function clearChipSelection(rootEl){
  rootEl && [...rootEl.querySelectorAll('.chip')].forEach(c=>c.classList.remove('selected'));
}
function syncHitterFromPitcherResult(val){
  const v = val || getSelectedValue(document.getElementById('pitcherGroup1'));
  if(v==='삼진' || v==='볼넷'){
    selectChipByValue(document.getElementById('hitterGroup'), v);
  }
}

/* ==== 커스텀 스피너 ==== */
document.addEventListener('click',(e)=>{
  const btn = e.target.closest('.spin-btn');
  if(!btn) return;
  const id = btn.dataset.target;
  const input = document.getElementById(id);
  const step = parseFloat(input.step||'1');
  const cur = parseFloat(input.value||'0')||0;
  const next = (btn.dataset.spin==='inc') ? cur+step : Math.max(0,cur-step);
  input.value = (step<1?next.toFixed(1):next.toFixed(0));
  input.dispatchEvent(new Event('change'));
});

/* ==== 투수/타자 에디터 ==== */
function findPlayer(name,type){ return players.find(p=>p.name===name && p.type===type); }
function renderPitcherEditor(pitcher){
  document.getElementById('pitcherNameDisplay').textContent = `${pitcher.name} (${pitcher.team})`;
  renderChipGroup(document.getElementById('pitcherGroup1'), ['삼진','볼넷','피안타','피홈런','사구']);
  renderChipGroup(document.getElementById('pitcherGroup2'), ['승리','패배','홀드','세이브']);
  document.getElementById('pitcherPitchCountInput').value = 0;
  document.getElementById('pitcherInningsInput').value = 0;
  document.getElementById('pitcherERInput').value = 0;
}
function renderHitterEditor(hitter){
  document.getElementById('hitterNameDisplay').textContent = `${hitter.name} (${hitter.team})`;
  renderChipGroup(document.getElementById('hitterGroup'),
    ['1루타','2루타','3루타','홈런','삼진','볼넷','희생플라이','내야땅볼','플라이아웃']);
  document.getElementById('hitterRBIInput').value = 0;
  document.getElementById('hitterRUNInput').value = 0;
}

/* ==== 검색/선택 ==== */
function setupSearchAndEdit(){
  const pitcherInput=document.getElementById('pitcherSearch');
  const hitterInput =document.getElementById('hitterSearch');
  const pitcherResults=document.getElementById('pitcherSearchResults');
  const hitterResults =document.getElementById('hitterSearchResults');
  const pitcherEdit=document.getElementById('pitcherEditSection');
  const hitterEdit =document.getElementById('hitterEditSection');

  function renderList(inputEl, resultsEl, type){
    const kw=inputEl.value.trim().toLowerCase();
    const list=players.filter(p=>p.type===type && p.name.toLowerCase().includes(kw));
    resultsEl.innerHTML=list.map(p=>`<div data-name="${p.name}">${p.name} (${p.team})</div>`).join('');
    resultsEl.style.display=list.length?'block':'none';
  }
  pitcherInput.addEventListener('input',()=>renderList(pitcherInput,pitcherResults,'투수'));
  hitterInput .addEventListener('input',()=>renderList(hitterInput ,hitterResults ,'타자'));

  pitcherResults.addEventListener('click',(e)=>{
    if(e.target.matches('div[data-name]')){
      const name=e.target.getAttribute('data-name');
      const p=findPlayer(name,'투수'); if(!p) return;
      pitcherEdit.style.display='block';
      renderPitcherEditor(p);
      pitcherResults.style.display='none';
      if(p.team===defenseTeam){ const obj=getLineup(p.team); obj.pitcher=p.name; saveLineup(p.team,obj); }
      syncSearchInputs();
    }
  });
  hitterResults.addEventListener('click',(e)=>{
    if(e.target.matches('div[data-name]')){
      const name=e.target.getAttribute('data-name');
      const h=findPlayer(name,'타자'); if(!h) return;
      hitterEdit.style.display='block';
      renderHitterEditor(h);
      hitterResults.style.display='none';
      const lu=currentBatters(); const i=lu.indexOf(name);
      if(i>=0){ setCurrentIdx(i); updateCurrentBatterInfo(); }
      syncSearchInputs();
    }
  });
}

/* ==== 라인업(양쪽) ==== */
function buildBothLineups(){
  buildLineupEditor('Leaders', 'lineupEditorLeaders');
  buildLineupEditor('CSIA', 'lineupEditorCSIA');
}
function buildLineupEditor(team, mountId){
  const root=document.getElementById(mountId);
  const obj = getLineup(team);
  const batters = players.filter(p=>p.type==='타자' && p.team===team).map(p=>p.name);
  const pitchers = players.filter(p=>p.type==='투수' && p.team===team).map(p=>p.name);

  const dlB = `dl_b_${team}`;
  const dlP = `dl_p_${team}`;
  const dls = `
    <datalist id="${dlB}">${batters.map(n=>`<option value="${n}">`).join('')}</datalist>
    <datalist id="${dlP}">${pitchers.map(n=>`<option value="${n}">`).join('')}</datalist>
  `;

  let html = `
    ${dls}
    <table class="lineup-table">
      <thead><tr><th style="width:60px;">타순</th><th>성명</th></tr></thead>
      <tbody>
        ${Array.from({length:9}).map((_,i)=>`
          <tr>
            <td>${i+1}</td>
            <td><input list="${dlB}" data-team="${team}" data-idx="${i}" class="lu-input" placeholder="이름 입력" value="${obj.batters[i]||''}"></td>
          </tr>
        `).join('')}
        <tr>
          <th>P</th>
          <td><input list="${dlP}" data-team="${team}" class="lu-pitcher" placeholder="투수 이름" value="${obj.pitcher||''}"></td>
        </tr>
      </tbody>
    </table>
  `;
  root.innerHTML = html;

  root.querySelectorAll('.lu-input').forEach(inp=>{
    inp.addEventListener('change',()=>{
      const t=inp.dataset.team;
      const o=getLineup(t);
      const idx=parseInt(inp.dataset.idx,10);
      o.batters[idx]=inp.value.trim();
      if(!o.batters[idx]) o.batters.splice(idx,1);
      saveLineup(t, o);
      if(t===offenseTeam) updateCurrentBatterInfo();
      syncSearchInputs();
    });
  });

  const pitcherField = root.querySelector('.lu-pitcher');
  function handlePitcherField(){
    const t=pitcherField.dataset.team;
    const o=getLineup(t);
    o.pitcher = pitcherField.value.trim();
    saveLineup(t, o);
    if(t===defenseTeam){
      if(!updatePitcherEditorByName(o.pitcher, t)){
        applyPitcherFromDefenseLineup();
      }
      syncSearchInputs();
    }
  }
  pitcherField.addEventListener('change', handlePitcherField);
  pitcherField.addEventListener('input',  handlePitcherField); // datalist 선택 즉시 반영
}

/* ==== 라인업 진행 컨트롤 ==== */
document.getElementById('startLineupBtn').addEventListener('click', ()=>{
  const lu=currentBatters();
  if(lu.length===0) return alert('현재 공격 팀의 라인업을 먼저 입력하세요.');
  saveLineupIdx(offenseTeam, 0);
  updateCurrentBatterInfo();

  const hitter = findPlayer(lu[0],'타자');
  if(hitter){
    const ec=document.getElementById('hitterEditSection');
    ec.style.display='block';
    renderHitterEditor(hitter);
  }
  ensureAutoPitcher();
  syncSearchInputs();
});
document.getElementById('nextBatterBtn').addEventListener('click', ()=>{
  const lu=currentBatters();
  if(lu.length===0) return alert('라인업이 비어 있습니다.');
  const idx=(currentIdx()+1)%lu.length;
  setCurrentIdx(idx);
  updateCurrentBatterInfo();
  const hitter=findPlayer(lu[idx],'타자');
  if(hitter){
    const ec=document.getElementById('hitterEditSection');
    ec.style.display='block';
    renderHitterEditor(hitter);
  }
  ensureAutoPitcher();
  syncSearchInputs();
});
document.getElementById('prevBatterBtn').addEventListener('click', ()=>{
  const list = duelHistory.filter(r=>true);
  if(list.length===0) return alert('이전 타자 기록이 없습니다.');
  if(historyPtr===-1) historyPtr = list.length;
  historyPtr = Math.max(0, historyPtr-1);
  loadFromHistory(list[historyPtr]);
  applyOutcomeToUI(list[historyPtr].outcome);
  setEditMode(historyPtr);
  updateHistoryBadge();
  syncSearchInputs();
});

/* ==== 히스토리 로드 ==== */
function loadFromHistory(rec){
  const p=findPlayer(rec.pitcherName,'투수');
  if(p){
    const ec=document.getElementById('pitcherEditSection');
    ec.style.display='block';
    renderPitcherEditor(p);
    document.getElementById('pitcherNameDisplay').textContent = `${p.name} (${p.team})`;
    document.getElementById('pitcherSearch').value=p.name;
  }
  const h=findPlayer(rec.hitterName,'타자');
  if(h){
    const ec=document.getElementById('hitterEditSection');
    ec.style.display='block';
    renderHitterEditor(h);
    document.getElementById('hitterNameDisplay').textContent = `${h.name} (${h.team})`;
    document.getElementById('hitterSearch').value=h.name;
    if(rec.offenseTeam===offenseTeam){
      const lu=currentBatters();
      const li=lu.indexOf(h.name);
      if(li>=0){ setCurrentIdx(li); updateCurrentBatterInfo(); }
    }
  }
}
function applyOutcomeToUI(outcome){
  if(!outcome) return;
  // 숫자 입력
  document.getElementById('pitcherPitchCountInput').value = outcome.pitchCount || 0;
  document.getElementById('pitcherInningsInput').value   = outcome.inningsDelta || 0;
  document.getElementById('pitcherERInput').value        = outcome.er || 0;
  document.getElementById('hitterRBIInput').value        = outcome.rbi || 0;
  document.getElementById('hitterRUNInput').value        = outcome.run || 0;
  // 칩 선택
  selectChipByValue(document.getElementById('pitcherGroup1'), outcome.pitcherEvt||'');
  selectChipByValue(document.getElementById('pitcherGroup2'), outcome.pitcherDecision||'');
  selectChipByValue(document.getElementById('hitterGroup'),   outcome.hitterEvt||'');
  // 삼진/볼넷 자동 동기화
  syncHitterFromPitcherResult(outcome.pitcherEvt);
}
document.getElementById('historyBackBtn').addEventListener('click', ()=>{
  if(duelHistory.length===0) return alert('히스토리 없음');
  if(historyPtr===-1) historyPtr = duelHistory.length-1;
  else historyPtr = Math.max(0, historyPtr-1);
  const rec = duelHistory[historyPtr];
  loadFromHistory(rec);
  applyOutcomeToUI(rec.outcome);
  setEditMode(historyPtr);
  updateHistoryBadge(); syncSearchInputs();
});
document.getElementById('historyForwardBtn').addEventListener('click', ()=>{
  if(duelHistory.length===0) return alert('히스토리 없음');
  if(historyPtr===-1) return;
  historyPtr++;
  if(historyPtr>=duelHistory.length){ historyPtr=-1; exitEditMode(); updateHistoryBadge(); syncSearchInputs(); return; }
  const rec = duelHistory[historyPtr];
  loadFromHistory(rec);
  applyOutcomeToUI(rec.outcome);
  setEditMode(historyPtr);
  updateHistoryBadge(); syncSearchInputs();
});

/* ==== 통계 반영/되돌리기 ==== */
function applyOutcomeToStats(pitcherName, hitterName, outcome, sign){
  if(!outcome) return;
  const p = findPlayer(pitcherName, '투수');
  const h = findPlayer(hitterName, '타자');
  const s = (v)=>sign*(v||0);

  if(p){
    p.stats['투구수'] = (p.stats['투구수']||0) + s(outcome.pitchCount);
    p.stats['이닝']   = (p.stats['이닝']  ||0) + s(outcome.inningsDelta);
    p.stats['자책점'] = (p.stats['자책점']||0) + s(outcome.er);
    if(outcome.pitcherEvt){ p.stats[outcome.pitcherEvt] = (p.stats[outcome.pitcherEvt]||0) + s(1); }
    if(outcome.pitcherDecision){ p.stats[outcome.pitcherDecision] = (p.stats[outcome.pitcherDecision]||0) + s(1); }
  }
  if(h){
    if(outcome.hitterEvt){ h.stats[outcome.hitterEvt] = (h.stats[outcome.hitterEvt]||0) + s(1); }
    if(outcome.rbi){ h.stats['타점'] = (h.stats['타점']||0) + s(outcome.rbi); }
    if(outcome.run){ h.stats['득점'] = (h.stats['득점']||0) + s(outcome.run); }
  }
}

/* ==== 편집: 저장/삭제 ==== */
function readCurrentOutcomeFromUI(){
  const pitchCountDelta = Math.max(0, parseFloat(document.getElementById('pitcherPitchCountInput').value)||0);
  const inningsDelta    = Math.max(0, parseFloat(document.getElementById('pitcherInningsInput').value)||0);
  const erDelta         = Math.max(0, parseInt(document.getElementById('pitcherERInput').value)||0);
  const g1 = getSelectedValue(document.getElementById('pitcherGroup1'));
  const g2 = getSelectedValue(document.getElementById('pitcherGroup2'));
  const hitterEvt = getSelectedValue(document.getElementById('hitterGroup'));
  const rbiDelta  = Math.max(0, parseInt(document.getElementById('hitterRBIInput').value)||0);
  const runDelta  = Math.max(0, parseInt(document.getElementById('hitterRUNInput').value)||0);

  return {
    hitterEvt: hitterEvt || '',
    rbi: rbiDelta || 0,
    run: runDelta || 0,
    pitcherEvt: g1 || '',
    pitcherDecision: g2 || '',
    pitchCount: pitchCountDelta || 0,
    inningsDelta: inningsDelta || 0,
    er: erDelta || 0
  };
}

function onUpdateRecord(){
  if(editIndex<0){ alert('편집할 히스토리를 선택하세요.'); return; }
  const old = duelHistory[editIndex];

  // 롤백(기존 증분 제거)
  applyOutcomeToStats(old.pitcherName, old.hitterName, old.outcome, -1);

  // 현재 UI 값 읽기 (이름도 변경 가능)
  const defLu = getLineup(defenseTeam);
  let pitcherName = defLu.pitcher || (document.getElementById('pitcherNameDisplay').textContent||'').split(' (')[0].trim();
  let hitterName  = (document.getElementById('hitterNameDisplay').textContent||'').split(' (')[0].trim();
  if(!pitcherName) pitcherName = old.pitcherName;
  if(!hitterName)  hitterName  = old.hitterName;

  const newOutcome = readCurrentOutcomeFromUI();

  // 적용
  applyOutcomeToStats(pitcherName, hitterName, newOutcome, +1);
  savePlayers(players);

  // 히스토리 업데이트
  duelHistory[editIndex] = {
    ...old,
    pitcherName,
    hitterName,
    outcome: newOutcome,
    ts: Date.now()
  };
  saveHistory();

  renderPlayerList();
  updateHistoryBadge();
  alert('기록을 수정했습니다.');
}

function onDeleteRecord(){
  if(editIndex<0){ alert('삭제할 히스토리를 선택하세요.'); return; }
  if(!confirm('이 기록을 삭제할까요? 선수 통계는 자동으로 되돌립니다.')) return;

  const old = duelHistory[editIndex];
  // 롤백
  applyOutcomeToStats(old.pitcherName, old.hitterName, old.outcome, -1);
  savePlayers(players);

  // 제거
  duelHistory.splice(editIndex,1);
  saveHistory();

  // 상태 정리
  historyPtr = -1;
  exitEditMode();

  renderPlayerList();
  updateHistoryBadge();
  alert('기록을 삭제하고 통계를 되돌렸습니다.');
}

/* ==== 대결 저장 (증분 반영) ==== */
document.getElementById('saveDuelBtn').addEventListener('click', ()=>{
  if(editIndex!==-1){
    alert('편집 모드에서는 "기록 수정 저장" 버튼을 사용하세요.');
    return;
  }

  const defLu = getLineup(defenseTeam);
  let pitcherName = defLu.pitcher || (document.getElementById('pitcherNameDisplay').textContent||'').split(' (')[0].trim();

  let hitterName = (document.getElementById('hitterNameDisplay').textContent||'').split(' (')[0].trim();
  const lu=currentBatters();
  if(lu.length>0){
    const idx=currentIdx()%lu.length;
    hitterName = lu[idx] || hitterName;
  }
  if(!pitcherName) return alert('투수를 선택하거나 라인업에 투수를 입력하세요.');
  if(!hitterName) return alert('타자를 선택하거나 라인업을 시작하세요.');

  const pitcher = findPlayer(pitcherName,'투수');
  const hitter  = findPlayer(hitterName ,'타자');
  if(!pitcher || !hitter) return alert('선수 데이터 오류입니다.');

  const outcome = readCurrentOutcomeFromUI();

  // 통계 반영
  applyOutcomeToStats(pitcherName, hitterName, outcome, +1);
  savePlayers(players);

  // 히스토리 축적
  duelHistory.push({pitcherName,hitterName,offenseTeam,defenseTeam,inning,half,ts:Date.now(), outcome});
  saveHistory();
  historyPtr=-1;
  updateHistoryBadge(); // 목록 갱신 포함

  // 다음 타자 이동
  if(lu.length>0){
    setCurrentIdx((currentIdx()+1)%lu.length);
    updateCurrentBatterInfo();
    const nextH=findPlayer(getCurrentBatter(),'타자');
    if(nextH){
      const ec=document.getElementById('hitterEditSection');
      ec.style.display='block';
      renderHitterEditor(nextH);
    }
  }
  ensureAutoPitcher(); syncSearchInputs();

  // 입력값 리셋
  document.getElementById('pitcherPitchCountInput').value = 0;
  document.getElementById('pitcherInningsInput').value = 0;
  document.getElementById('pitcherERInput').value = 0;
  clearChipSelection(document.getElementById('pitcherGroup1'));
  clearChipSelection(document.getElementById('pitcherGroup2'));
  clearChipSelection(document.getElementById('hitterGroup'));
  document.getElementById('hitterRBIInput').value = 0;
  document.getElementById('hitterRUNInput').value = 0;

  alert('대결 기록이 저장되었습니다. (증분 반영 완료)');
  renderPlayerList();
});

/* 이름 클릭 → 등록 선수 카드로 스크롤 */
function scrollToPlayerFromDisplay(type){
  const id = (type==='투수'?'pitcherNameDisplay':'hitterNameDisplay');
  const txt = (document.getElementById(id).textContent||'').split(' (')[0].trim();
  if(!txt) return;
  const card = document.getElementById(containerIdFor(txt, type));
  if(card){
    card.scrollIntoView({behavior:'smooth', block:'center'});
    card.classList.add('highlight');
    setTimeout(()=>card.classList.remove('highlight'), 2000);
  }else{
    document.getElementById('playerListSection')?.scrollIntoView({behavior:'smooth'});
  }
}

/* ==== 이닝 종료 & 이전/다음 이닝 보기 ==== */
document.getElementById('endHalfBtn').addEventListener('click', ()=>{
  [offenseTeam, defenseTeam] = [defenseTeam, offenseTeam];
  if(half==='초'){ half='말'; } else { half='초'; inning += 1; }
  saveGameState();
  updateInningBadge();
  updateCurrentBatterInfo();
  ensureAutoPitcher();
  syncSearchInputs();
  alert(`이닝 전환: ${inning}회 ${half} · 공격 ${offenseTeam}`);
  renderHistoryList();
});
document.getElementById('prevInningBtn').addEventListener('click', ()=>{
  if(viewHalf==='말'){ viewHalf='초'; viewInning = Math.max(1, viewInning-1); }
  else { if(viewInning>1){ viewHalf='말'; viewInning-=1; } }
  jumpToLastPAOf(viewInning, viewHalf);
});
document.getElementById('nextInningBtn').addEventListener('click', ()=>{
  if(viewHalf==='초'){ viewHalf='말'; }
  else { viewHalf='초'; viewInning += 1; }
  jumpToLastPAOf(viewInning, viewHalf);
});
function jumpToLastPAOf(inn, hf){
  const list = duelHistory.filter(r=>r.inning===inn && r.half===hf);
  if(list.length===0){ alert(`${inn}회 ${hf} 기록이 없습니다.`); updateHistoryBadge(); return; }
  const rec = list[list.length-1];
  loadFromHistory(rec);
  applyOutcomeToUI(rec.outcome);
  const idx = duelHistory.indexOf(rec);
  if(idx>=0){ historyPtr = idx; setEditMode(idx); updateHistoryBadge(); }
  syncSearchInputs();
  alert(`${inn}회 ${hf} 마지막 타석을 불러왔습니다.`);
}

/* ==== 시작 ==== */
init();
</script>
</body>
</html>

