<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>선수 상세 정보</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 600px;
      margin: 40px auto;
      padding: 20px 30px;
      background-color: #f9faff;
      color: #333;
    }

    h1 {
      font-weight: 700;
      font-size: 2rem;
      margin-bottom: 20px;
      color: #1a73e8;
      text-align: center;
    }

    #backBtn {
      display: inline-block;
      margin-bottom: 20px;
      padding: 8px 16px;
      font-size: 1rem;
      font-weight: 600;
      color: white;
      background-color: #1a73e8;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #backBtn:hover {
      background-color: #155ab6;
    }

    .table-wrapper {
      overflow-x: auto;
      width: 100%;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th, td {
      border: 1px solid #1a73e8;
      padding: 6px 12px;
      text-align: center;
      font-weight: 600;
      white-space: nowrap;
    }

    th {
      background-color: #f0f4ff;
      color: #1a73e8;
    }

    @media (max-width: 600px) {
      body {
        padding: 10px 15px;
      }
      th, td {
        font-size: 0.85rem;
        padding: 5px 8px;
      }
    }
  </style>
</head>
<body>

  <button id="backBtn">← 뒤로가기</button>

  <h1 id="playerName">선수명 (포지션)</h1>

  <div class="table-wrapper">
    <table id="statsTable">
      <tbody id="statsTableBody"></tbody>
    </table>
  </div>

  <script>
    document.getElementById('backBtn').addEventListener('click', () => {
      history.back();
    });

    const playerNameElem = document.getElementById('playerName');
    const statsTableBody = document.getElementById('statsTableBody');
    const urlParams = new URLSearchParams(window.location.search);
    const playerName = urlParams.get('name');
    const playerType = urlParams.get('type');

    const PLAYER_JSON_URL = "https://alex4u-jun.github.io/bs_record/players.json";

    // ----- 공통 계산 유틸 (공식 규정대로 ROE를 AB에 포함) -----
    function singles(p){ return p.stats['1루타'] || 0; }
    function doubles(p){ return p.stats['2루타'] || 0; }
    function triples(p){ return p.stats['3루타'] || 0; }
    function homers(p){ return p.stats['홈런']  || 0; }
    function strikeouts(p){ return p.stats['삼진'] || 0; }
    function gbOut(p){ return p.stats['내야땅볼'] || 0; }
    function fbOut(p){ return p.stats['플라이아웃'] || 0; }
    function walks(p){ return p.stats['볼넷'] || 0; }
    function sacFly(p){ return p.stats['희생플라이'] || 0; }
    function roe(p){ return p.stats['수비 실책'] || 0; } // ✅ ROE(수비 실책)

    function hits(p){
      return singles(p) + doubles(p) + triples(p) + homers(p);
    }
    function atBats(p){
      // ✅ ROE를 타수에 포함 (안타는 포함, 볼넷/SF는 제외)
      return hits(p) + strikeouts(p) + gbOut(p) + fbOut(p) + roe(p);
    }
    function totalBases(p){
      // 안타에 의해서만 총루타 증가
      return singles(p) + 2*doubles(p) + 3*triples(p) + 4*homers(p);
    }

    function calculateAVG(player) {
      const H  = hits(player);
      const AB = atBats(player);
      return AB === 0 ? 0 : H / AB;
    }

    function calculateOBP(player) {
      const H  = hits(player);
      const BB = walks(player);
      const AB = atBats(player);  // ✅ ROE 포함된 AB
      const SF = sacFly(player);
      const denom = AB + BB + SF;
      return denom === 0 ? 0 : (H + BB) / denom; // HBP=0 가정
    }

    function calculateSLG(player) {
      const TB = totalBases(player);
      const AB = atBats(player);  // ✅ ROE 포함된 AB
      return AB === 0 ? 0 : TB / AB;
    }

    function calculateOPS(player) {
      return calculateOBP(player) + calculateSLG(player);
    }

    // 투수 지표
    function calculateERA(player) {
      const ER = player.stats['자책점'] || 0;
      const IP = player.stats['이닝'] || 0;
      return IP === 0 ? 0 : (ER * 9) / IP;
    }

    function calculateWHIP(player) {
      const BB = player.stats['볼넷'] || 0;
      const H = player.stats['피안타'] || 0;
      const IP = player.stats['이닝'] || 0;
      return IP === 0 ? 0 : (BB + H) / IP;
    }

    function calculateWinRate(player) {
      const W = player.stats['승리'] || 0;
      const L = player.stats['패배'] || 0;
      const total = W + L;
      return total === 0 ? 0 : W / total;
    }

    async function loadPlayerData() {
      try {
        const res = await fetch(PLAYER_JSON_URL);
        if (!res.ok) throw new Error("선수 데이터를 불러오지 못했습니다.");
        const players = await res.json();
        const player = players.find(p => p.name === playerName && p.type === playerType);

        if (!player) {
          playerNameElem.textContent = '선수 정보를 찾을 수 없습니다.';
          statsTableBody.innerHTML = '';
          return;
        }

        playerNameElem.textContent = `${player.name} (${player.type})`;
        statsTableBody.innerHTML = '';

        let statHeaders, statValues;

        if (player.type === '투수') {
          statHeaders = ['투구수', '삼진', '볼넷', '사구', '피안타', '피홈런', '자책점', '이닝', '승리', '패배', '홀드', '세이브', 'ERA', 'WHIP', '승률', 'MVP 횟수'];
          statValues = [
            player.stats['투구수'] || 0,
            player.stats['삼진'] || 0,
            player.stats['볼넷'] || 0,
            player.stats['사구'] || 0,
            player.stats['피안타'] || 0,
            player.stats['피홈런'] || 0,
            player.stats['자책점'] || 0,
            player.stats['이닝'] || 0,
            player.stats['승리'] || 0,
            player.stats['패배'] || 0,
            player.stats['홀드'] || 0,
            player.stats['세이브'] || 0,
            calculateERA(player).toFixed(2),
            calculateWHIP(player).toFixed(3),
            (calculateWinRate(player) * 100).toFixed(1) + '%',
            player.mvpCount || 0
          ];
        } else {
          // ✅ 타자 표에 '수비 실책' 추가 + 계산 공식은 ROE를 AB에 포함
          const H  = hits(player);
          const AB = atBats(player);
          const TB = totalBases(player);

          statHeaders = [
            '1루타', '2루타', '3루타', '홈런',
            '삼진', '볼넷', '희생플라이',
            '내야땅볼', '플라이아웃', '수비 실책',  // ✅ 추가
            '타점',
            '타수(AB)', '안타(H)', '총루타(TB)',  // 참고용 지표(원하면 숨겨도 됨)
            '타율', '출루율', '장타율', 'OPS',
            'MVP 횟수'
          ];
          statValues = [
            singles(player),
            doubles(player),
            triples(player),
            homers(player),
            strikeouts(player),
            walks(player),
            sacFly(player),
            gbOut(player),
            fbOut(player),
            roe(player),                     // ✅ 수비 실책 수치
            player.stats['타점'] || 0,
            AB, H, TB,                       // 참고용
            calculateAVG(player).toFixed(3),
            calculateOBP(player).toFixed(3),
            calculateSLG(player).toFixed(3),
            calculateOPS(player).toFixed(3),
            player.mvpCount || 0
          ];
        }

        for (let i = 0; i < statHeaders.length; i++) {
          const tr = document.createElement('tr');

          const th = document.createElement('th');
          th.textContent = statHeaders[i];
          tr.appendChild(th);

          const td = document.createElement('td');
          td.textContent = statValues[i];
          tr.appendChild(td);

          statsTableBody.appendChild(tr);
        }
      } catch (err) {
        playerNameElem.textContent = '선수 데이터를 불러오는 중 오류가 발생했습니다.';
        console.error(err);
      }
    }

    // 실행
    loadPlayerData();
  </script>
</body>
</html>

